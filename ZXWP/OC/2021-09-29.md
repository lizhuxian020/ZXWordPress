# //
//  LZMFoodHomeService.m
//  LZM_SmartEdifice
//
//  Created by zzstc on 2020/9/3.
//  Copyright © 2020 SZ_LZM. All rights reserved.
//

#import "LZMFoodHomeService.h"
#import "LZMRequestManager.h"
@implementation LZMFoodHomeService

+ (void)getFoodGroupsDataSuccess:(ReqSuccess)success failureHandle:(ReqFailed)failureBlock {
//       [LZMRequestManager GET:@"http://rap2.louzhangmen.cn:38080/app/mock/23/app-get/ec/v1/aggregation/food/groups" parameters:nil success:success failed:failureBlock];
    [LZMNetworking GET:kGetFoodGroupsInfo parameters:nil success:success failed:failureBlock];
}

+ (void)getShopListWithType:(NSInteger)type success:(ReqSuccess)success failureHandle:(ReqFailed)failureBlock{
    NSString *requestUrl = [NSString stringWithFormat:@"%@?type=%@", kGetRecommendShopList, @(type)];
    [LZMNetworking GET:requestUrl parameters:nil success:success failed:failureBlock];
}

+ (void)getProductsWithGroupId:(NSString *)groupId
                       pageNum:(NSUInteger)pageNum
                      pageSize:(NSUInteger)pageSize
                       success:(ReqSuccess)success
                 failureHandle:(ReqFailed)failureBlock{
    NSString *requestUrl = [NSString stringWithFormat:@"%@%@/goods?pageNum=%ld&pageSize=%ld", kReqGroupProducts, groupId, pageNum, pageSize];
    [LZMNetworking GET:requestUrl parameters:nil success:success failed:failureBlock];
}


@end
//
//  CollectionWaterfallLayout.m
//  TidusWWDemo
//
//  Created by Tidus on 17/1/12.
//  Copyright © 2017年 Tidus. All rights reserved.
//

#import "CollectionWaterfallLayout.h"

NSString *const kSupplementaryViewKindHeader = @"Header";
CGFloat const kSupplementaryViewKindHeaderPinnedHeight = 44.f;

@interface CollectionWaterfallLayout()

/** 保存所有Item的LayoutAttributes */
@property (nonatomic, strong) NSMutableArray<UICollectionViewLayoutAttributes *> *attributesArray;
/** 保存所有列的当前高度 */
@property (nonatomic, strong) NSMutableArray<NSNumber *> *columnHeights;

@end


@implementation CollectionWaterfallLayout

- (void)dealloc
{
    NSLog(@"%s", __func__);
}

- (instancetype)init
{
    if(self = [super init]) {
        _columns = 1;
        _columnSpacing = 10;
        _itemSpacing = 10;
        _insets = UIEdgeInsetsZero;
    }
    return self;
}

#pragma mark - UICollectionViewLayout (UISubclassingHooks)
/**
 *  1、
 *  collectionView初次显示或者调用invalidateLayout方法后会调用此方法
 *  触发此方法会重新计算布局，每次布局也是从此方法开始
 *  在此方法中需要做的事情是准备后续计算所需的东西，以得出后面的ContentSize和每个item的layoutAttributes
 */
- (void)prepareLayout
{
    [super prepareLayout];
    
    
    //初始化数组
    self.columnHeights = [NSMutableArray array];
    for(NSInteger column=0; column<_columns; column++){
        self.columnHeights[column] = @(0);
    }
    
    
    self.attributesArray = [NSMutableArray array];
    NSInteger numSections = [self.collectionView numberOfSections];
    for(NSInteger section=0; section<numSections; section++){
        NSInteger numItems = [self.collectionView numberOfItemsInSection:0];
        for(NSInteger item=0; item<numItems; item++){
            //遍历每一项
            NSIndexPath *indexPath = [NSIndexPath indexPathForItem:item inSection:section];
            //计算LayoutAttributes
            UICollectionViewLayoutAttributes *attributes = [self layoutAttributesForItemAtIndexPath:indexPath];
            
            [self.attributesArray addObject:attributes];
        }
    }
}

/**
 *  2、
 *  需要返回所有内容的滚动长度
 */
- (CGSize)collectionViewContentSize
{
    NSInteger mostColumn = [self columnOfMostHeight];
    //所有列当中最大的高度
    CGFloat mostHeight = [self.columnHeights[mostColumn] floatValue];
    return CGSizeMake(self.collectionView.bounds.size.width, mostHeight+_insets.top+_insets.bottom);
}

/**
 *  3、
 *  当CollectionView开始刷新后，会调用此方法并传递rect参数（即当前可视区域）
 *  我们需要利用rect参数判断出在当前可视区域中有哪几个indexPath会被显示（无视rect而全部计算将会带来不好的性能）
 *  最后计算相关indexPath的layoutAttributes，加入数组中并返回
 */
- (NSArray<UICollectionViewLayoutAttributes *> *)layoutAttributesForElementsInRect:(CGRect)rect
{
    NSMutableArray *attributesArray = self.attributesArray;
    NSArray<NSIndexPath *> *indexPaths;
    //1、计算rect中出现的items
    indexPaths = [self indexPathForItemsInRect:rect];
    for(NSIndexPath *indexPath in indexPaths){
        //计算对应的LayoutAttributes
        UICollectionViewLayoutAttributes *attributes = [self layoutAttributesForItemAtIndexPath:indexPath];
        [attributesArray addObject:attributes];
    }
    
    //2、计算rect中出现的SupplementaryViews
    //这里只计算了kSupplementaryViewKindHeader
    indexPaths = [self indexPathForSupplementaryViewsOfKind:kSupplementaryViewKindHeader InRect:rect];
    for(NSIndexPath *indexPath in indexPaths){
        //计算对应的LayoutAttributes
        UICollectionViewLayoutAttributes *attributes = [self layoutAttributesForSupplementaryViewOfKind:kSupplementaryViewKindHeader atIndexPath:indexPath];
        [attributesArray addObject:attributes];
    }
    
    return attributesArray;
}

/**
 *  每当offset改变时，是否需要重新布局，newBounds为offset改变后的rect
 *  瀑布流中不需要，因为滑动时，cell的布局不会随offset而改变
 *  如果需要实现悬浮Header，需要改为YES
 */
- (BOOL)shouldInvalidateLayoutForBoundsChange:(CGRect)newBounds
{
    //return [super shouldInvalidateLayoutForBoundsChange:newBounds];
    return YES;
}

#pragma mark - 计算单个indexPath的LayoutAttributes
/**
 *  根据indexPath，计算对应的LayoutAttributes
 */
- (UICollectionViewLayoutAttributes *)layoutAttributesForItemAtIndexPath:(NSIndexPath *)indexPath
{
    UICollectionViewLayoutAttributes *attributes = [UICollectionViewLayoutAttributes layoutAttributesForCellWithIndexPath:indexPath];
    //外部返回Item高度
    CGFloat itemHeight = [self.delegate collectionViewLayout:self heightForItemAtIndexPath:indexPath];
    
    //headerView高度
    CGFloat headerHeight = [self.delegate collectionViewLayout:self heightForSupplementaryViewAtIndexPath:[NSIndexPath indexPathForItem:0 inSection:0]];
    
    //找出所有列中高度最小的
    NSInteger columnIndex = [self columnOfLessHeight];
    CGFloat lessHeight = [self.columnHeights[columnIndex] floatValue];
    
    //计算LayoutAttributes
    CGFloat width = (self.collectionView.bounds.size.width-(_insets.left+_insets.right)-_columnSpacing*(_columns-1)) / _columns;
    CGFloat height = itemHeight;
    CGFloat x = _insets.left+(width+_columnSpacing)*columnIndex;
    CGFloat y = lessHeight==0 ? headerHeight+_insets.top : lessHeight+_itemSpacing;
    attributes.frame = CGRectMake(x, y, width, height);
    
    //更新列高度
    self.columnHeights[columnIndex] = @(y+height);
    
    return attributes;
}

/**
 *  根据kind、indexPath，计算对应的LayoutAttributes
 */
- (UICollectionViewLayoutAttributes *)layoutAttributesForSupplementaryViewOfKind:(NSString *)elementKind atIndexPath:(NSIndexPath *)indexPath
{
    UICollectionViewLayoutAttributes *attributes = [UICollectionViewLayoutAttributes layoutAttributesForSupplementaryViewOfKind:elementKind withIndexPath:indexPath];
    
    //计算LayoutAttributes
    if([elementKind isEqualToString:kSupplementaryViewKindHeader]){
        CGFloat width = self.collectionView.bounds.size.width;
        CGFloat height = [self.delegate collectionViewLayout:self heightForSupplementaryViewAtIndexPath:indexPath];
        CGFloat x = 0;
        //根据offset计算kSupplementaryViewKindHeader的y
        //y = offset.y-(header高度-固定高度)
        CGFloat offsetY = self.collectionView.contentOffset.y;
        CGFloat y = MAX(0,
                        offsetY-(height-kSupplementaryViewKindHeaderPinnedHeight));
        attributes.frame = CGRectMake(x, y, width, height);
        attributes.zIndex = 1024;
    }
    return attributes;
}


#pragma mark - helpers
/**
 *  找到高度最小的那一列的下标
 */
- (NSInteger)columnOfLessHeight
{
    if(self.columnHeights.count == 0 || self.columnHeights.count == 1){
        return 0;
    }

    __block NSInteger leastIndex = 0;
    [self.columnHeights enumerateObjectsUsingBlock:^(NSNumber *number, NSUInteger idx, BOOL *stop) {
        
        if([number floatValue] < [self.columnHeights[leastIndex] floatValue]){
            leastIndex = idx;
        }
    }];
    
    return leastIndex;
}

/**
 *  找到高度最大的那一列的下标
 */
- (NSInteger)columnOfMostHeight
{
    if(self.columnHeights.count == 0 || self.columnHeights.count == 1){
        return 0;
    }
    
    __block NSInteger mostIndex = 0;
    [self.columnHeights enumerateObjectsUsingBlock:^(NSNumber *number, NSUInteger idx, BOOL *stop) {
        
        if([number floatValue] > [self.columnHeights[mostIndex] floatValue]){
            mostIndex = idx;
        }
    }];
    
    return mostIndex;
}

#pragma mark - 根据rect返回应该出现的Items
/**
 *  计算目标rect中含有的item
 */
- (NSMutableArray<NSIndexPath *> *)indexPathForItemsInRect:(CGRect)rect
{
    NSMutableArray<NSIndexPath *> *indexPaths = [NSMutableArray array];
    
    
    return indexPaths;
}

/**
 *  计算目标rect中含有的某类SupplementaryView
 */
- (NSMutableArray<NSIndexPath *> *)indexPathForSupplementaryViewsOfKind:(NSString *)kind InRect:(CGRect)rect
{
    NSMutableArray<NSIndexPath *> *indexPaths = [NSMutableArray array];
    if([kind isEqualToString:kSupplementaryViewKindHeader]){
        //在这个瀑布流自定义布局中，只有一个位于列表顶部的SupplementaryView
        NSIndexPath *indexPath = [NSIndexPath indexPathForItem:0 inSection:0];
        
        //如果当前区域可以看到SupplementaryView，则返回
        //CGFloat height = [self.delegate collectionViewLayout:self heightForSupplementaryViewAtIndexPath:indexPath];
        //if(CGRectGetMinY(rect) <= height + _insets.top){
        //Header默认总是需要显示
        [indexPaths addObject:indexPath];
        //}
    }
    
    
    return indexPaths;
}

@end//
//  LZMFoodMainController.m
//  LZM_SmartEdifice
//
//  Created by zzstc on 2020/9/1.
//  Copyright © 2020 SZ_LZM. All rights reserved.
//

#import "LZMFoodMainController.h"
#import "MFNestTableView.h"
#import "MFPageView.h"
#import "HZMutiMenuView.h"
#import "LZMFoodHeaderView.h"
#import "LZMGoodShopViewController.h"
#import "LZMFoodRecommendCollectionViewController.h"
#import "LZMCustomNavBarView.h"
#import "UIViewController+PanEntrance.h"
#import "UIImage+Gradient.h"
#import "LZMFoodGroupModel.h"
#import "LZMMallService.h"
#import "LZMBanner.h"
#import "LZMFoodHomeService.h"

@interface LZMFoodMainController ()<HZMutiItemMenuDelegate,MFNestTableViewDelegate,MFNestTableViewDataSource,UIScrollViewDelegate,MFPageViewDelegate,MFPageViewDataSource,LZMMallProductScrollViewDelegate,LZMMallSelectedDelegate>
@property (nonatomic, strong)MFPageView *contentView;
@property (nonatomic, strong)MFNestTableView *nestTableView;
@property (nonatomic, strong)HZMutiMenuView *menuView;
@property (nonatomic, strong)HZMutiMenuView *topMenuView;
@property (nonatomic, strong)LZMFoodHeaderView *headerView;
@property (nonatomic, strong)NSArray *titles;
@property (nonatomic, strong) NSArray <FineFoodTopGroupsModel *> * groups ; /**< 分组 **/
@property (nonatomic, strong)UIImageView *maskImageView;
@property (nonatomic, strong) NSMutableArray <__kindof UIViewController *>* controllers; /**< 控制器 **/
@property (nonatomic, strong) NSMutableArray <__kindof UIView *> * controllerViews ; /**< 控制器view **/
@property (nonatomic, strong) NSMutableArray <NSString *> * groupNames ; /**< 分组名称 **/
@property (nonatomic, strong) LZMCustomNavBarView *navBarView;
@property (nonatomic, assign) CGFloat naviAlpha ; /**< 导航栏透明度 **/
@property (nonatomic, assign) BOOL canContentScroll ;
@property (nonatomic, strong) LZMFoodGroupModel *foodGroupModel;
@property (nonatomic, strong) NSArray <LZMBanner *> * banners ; /**< banners **/
@property (nonatomic, strong) UIView *menuViewContainer;
@property (nonatomic, assign) CGFloat menuViewWidth;
@property (nonatomic, assign) CGFloat tmpHeight;
@property (nonatomic, assign) CGFloat lastContentOffset;
@property (nonatomic, assign) BOOL isDown;
@end

@implementation LZMFoodMainController

- (void)viewDidLoad {
    [super viewDidLoad];
    self.titles = @[@"优质店铺",@"发现美食"];
    self.view.backgroundColor = LZMColor(@"C9");
    [self creatSubView];
    self.headerView.foodGroupModel = nil;
    [self getBanner];
    [LZMDataAnalysis pageEvent:kAnyFoodEntrance];
   // [LZMDataAnalysis setEventLabel:kAnyFoodEntrance];
    // Do any additional setup after loading the view.
}

- (void)viewWillAppear:(BOOL)animated {
    [super viewWillAppear:animated];
    [self.navigationController setNavigationBarHidden:YES animated:YES];
}

- (void)viewWillDisappear:(BOOL)animated {
    [super viewWillDisappear:animated];
  //  [self.navigationController setNavigationBarHidden:NO animated:YES];
}

- (void)creatSubView {
    [self.view addSubview:self.nestTableView];
    [self.view addSubview:self.navBarView];
    self.nestTableView.headerView = self.headerView;
    [self.nestTableView setContentHeight:(LZMDevHeight - SafeAreaTopHeight )];
    self.nestTableView.contentView = self.contentView;
    [self.nestTableView.tableView.panGestureRecognizer requireGestureRecognizerToFail:self.contentView.panGesture];
    __weak typeof(self) weakSelf = self;
    LZMRefreshHeader *header = [LZMRefreshHeader headerWithRefreshingBlock:^{
        [weakSelf getBanner];
    }];
    header.allowVibration = YES;
    self.nestTableView.tableView.mj_header = header;
    [self setAutoAjustOfScrollView:self.nestTableView.tableView isNeedAuto:NO];
    [self.nestTableView.tableView.panGestureRecognizer requireGestureRecognizerToFail:self.navigationController.interactivePopGestureRecognizer];
}

- (void)setupControllers{
    NSMutableArray *groupNames = [NSMutableArray array];
    if (self.groups.count == 0){
        self.controllers = [NSMutableArray array];
        self.controllerViews = [NSMutableArray array];
        for (NSInteger i = 0; i<2; i++) {
            LZMGoodShopViewController *shopVC = [LZMGoodShopViewController new];
            shopVC.isDefault = YES;
            shopVC.view.frame = self.contentView.bounds;
            shopVC.mallScrollDelegate = self;
            shopVC.mallSelectDelegate = self;
            [self.controllers addObject:shopVC];
            [self.controllerViews addObject:shopVC.tableView];
            
        }
        groupNames = @[@"优质店铺",@"发现美食"].mutableCopy;
    } else {
   
    for (FineFoodTopGroupsModel *model in self.groups) {
        [groupNames addObject:model.groupName];
    }
    
    if ([groupNames isEqual:self.groupNames]){
        // 刷新数据
        [self.controllers enumerateObjectsUsingBlock:^(__kindof UIViewController * _Nonnull obj, NSUInteger idx, BOOL * _Nonnull stop) {
            UIViewController *controller = self.controllers[idx];
            if (controller){
                [controller performSelector:@selector(refreshData)];
            }
        }];
        [self.nestTableView.tableView.mj_header endRefreshing];
        return;
    }
    
    
    self.controllers = [NSMutableArray array];
    self.controllerViews = [NSMutableArray array];
    [self.groups enumerateObjectsUsingBlock:^(FineFoodTopGroupsModel *  _Nonnull obj, NSUInteger idx, BOOL * _Nonnull stop) {
        if (obj.contentKind == 2) {
            //商铺列表
            LZMGoodShopViewController *shopVC = [LZMGoodShopViewController new];
            shopVC.view.frame = self.contentView.bounds;
            shopVC.mallScrollDelegate = self;
            shopVC.mallSelectDelegate = self;
            [self.controllers addObject:shopVC];
            [self.controllerViews addObject:shopVC.tableView];
        } else {
            //商品列表
            LZMFoodRecommendCollectionViewController *recommendVC = [LZMFoodRecommendCollectionViewController getFoodRecommendCollectionViewController];
            recommendVC.view.frame = self.contentView.bounds;
            recommendVC.mallScrollDelegate = self;
            recommendVC.mallSelectDelegate = self;
            recommendVC.groupId = @(obj.groupId).stringValue;
            [self.controllers addObject:recommendVC];
            [self.controllerViews addObject:recommendVC.collectionView];
        }
    }];
    }
    self.groupNames = groupNames;
    NSInteger currentIndex = 0;
    if (self.menuView.selectIndex > self.groupNames.count-1) {
        currentIndex = self.groupNames.count-1;
    } else {
        currentIndex = self.menuView.selectIndex;
    }
    BOOL isTop = NO;//判断缓存时候是否将菜单栏滑到顶部
    if ([self.menuView.superview isEqual:self.view]) {
        isTop = YES;
        [self.menuView removeFromSuperview];
    }
    self.menuView = [[HZMutiMenuView alloc] initWithFrame:CGRectMake(0,0, self.groupNames.count<=2?LZMDevWidth-190:LZMDevWidth, 44.f) items:self.groupNames icons:@[] config:^(HZMutiMenuConfig * _Nonnull config) {
          config.normalFont = LZMFontMedium18;
          config.highlightFont = LZMFontMedium18;
          config.itemBackgroundColor = LZMColor(@"C9");
          config.highlightColor = LZMColor(@"C4");
          config.normalColor = LZMColorA(@"C4",0.4);
          config.isEqualWidth = NO;
          config.leftMargin = 12;
          config.itemSpace = 30;
          config.hoverWidth = 20.f;
          config.hoverHeight = 4.f;
          config.hoverBottomOffset = 4;
        config.hoverColor = [UIColor clearColor];
      }];
    self.menuViewWidth = self.groupNames.count<=2?LZMDevWidth-190:LZMDevWidth;
    [self addCircularImg:[self.menuView valueForKey:@"hoverView"]];
    self.menuView.delegate = self;
    [self.menuViewContainer removeAllSubviews];
    [self.menuViewContainer addSubview:self.menuView];
    
    self.nestTableView.segmentView = self.menuViewContainer;
    if (isIPhoneXSeries){
        
    }else{
        [self.nestTableView setSegmentViewHeight:self.menuView.bounds.size.height];
    }
    self.nestTableView.allowGestureEventPassViews = self.controllerViews;
    [self.contentView reloadViews];
    [self.nestTableView.tableView.mj_header endRefreshing];
    [self.contentView scrollToIndex:currentIndex];
    self.menuView.selectIndex = currentIndex;
    if (isTop) {
        [self.menuView removeFromSuperview];
        [self.view addSubview:self.menuView];
        self.menuView.center = self.menuView.width == LZMDevWidth - 190?CGPointMake(self.navBarView.width/2, kstatusBarHeight+22):CGPointMake(self.navBarView.width/2+44, kstatusBarHeight+22);
        [self.nestTableView.tableView scrollToRowAtIndexPath:[NSIndexPath indexPathForRow:NSNotFound inSection:0] atScrollPosition:UITableViewScrollPositionTop animated:YES];
    }
}

- (UIView *)menuViewContainer {
    if (!_menuViewContainer) {
        _menuViewContainer  = [[UIView alloc]initWithFrame:CGRectMake(0,0, LZMDevWidth, 44.f)];
    }
    return _menuViewContainer;
}

- (void)moveUpMenuView:(CGFloat)offset {
    CGPoint originalCenter = [self.view convertPoint:self.menuView.center fromView:self.menuView.superview];
    [self.menuView removeFromSuperview];
    [self.view addSubview:self.menuView];
    self.menuView.center = originalCenter;
    static CGFloat oldHeight = 0;
    CGFloat height = offset - self.headerView.height+SafeAreaTopHeight;
    NSLog(@"height:%f+======+offset:%f+++=====oldHeight:%f",height,offset,oldHeight);
   // CGPoint destinationPoint = CGPointMake(self.navBarView.width/2, kstatusBarHeight+22); // Set it's value
  //  CGPoint finalCenter = [self.view convertPoint:destinationPoint fromView:self.menuView];
    CGFloat upHeight ;//= fabs(height-oldHeight);
  //  if(_isDown) {
        upHeight = height-oldHeight;
   // }
    CGPoint destinationPoint = CGPointMake(originalCenter.x+upHeight,originalCenter.y-upHeight);
    if(self.menuView.width == LZMDevWidth - 190) {
        destinationPoint = CGPointMake(originalCenter.x+95*upHeight/44,originalCenter.y-upHeight);
    }
    self.menuView.scrollView.backgroundColor = LZMColorA(@"C11", 0);
    if (destinationPoint.y < kstatusBarHeight+22||offset == (int)(self.headerView.height-SafeAreaTopHeight+44)) {
        destinationPoint = CGPointMake(self.navBarView.width/2+44, kstatusBarHeight+22);
        if(self.menuView.width == LZMDevWidth - 190) {
            destinationPoint = CGPointMake(self.navBarView.width/2, kstatusBarHeight+22);
        }
    }
    NSLog(@"++++++y:%f",destinationPoint.y);
    [UIView animateWithDuration:0.1
                          delay:0
                        options:UIViewAnimationOptionCurveEaseInOut
                     animations:^{
//                    [self.nestTableView setSegmentViewHeight:0];
//                    [self.nestTableView setContentHeight:_contentView.height+44];
//        if (self.menuViewWidth != LZMDevWidth-190) {
//            self.menuView.width = LZMDevWidth-95;
//            self.menuView.scrollView.width = LZMDevWidth-95;
//        }
        self.menuView.center = destinationPoint;
        if (self.menuView.frame.origin.x<0) {
            self.menuView.frame = CGRectMake(0, SafeAreaTopHeight, self.menuView.width, 44);
        }
                         //self.menuView.center = destinationPoint;
                     } completion:^(BOOL finished) {

//                         self.menuView.scrollView.backgroundColor = [UIColor whiteColor];
//                         if (offset == self.headerView.height-SafeAreaTopHeight+44) {
//
//                         }
//                         [self.menuView removeFromSuperview];
//                         [self.navBarView addSubview:self.menuView];
//                          // self.menuView.center = [self.view convertPoint: self.menuView.center toView:self.navBarView];
//                         self.menuView.frame = CGRectMake((LZMDevWidth - self.menuView.width)/2, SafeAreaTopHeight-44, self.menuView.width, 44);
                         }];
    oldHeight = height;
}

- (void)moveDownMenuView:(CGFloat)offset {
      CGPoint originalCenter = [self.menuViewContainer convertPoint:self.menuView.center fromView:self.view];
      [self.menuView removeFromSuperview];
      [self.menuViewContainer addSubview:self.menuView];
      self.menuView.center = originalCenter;
      CGPoint destinationPoint = CGPointMake(self.nestTableView.width/2, SafeAreaTopHeight+22); // Set it's value
    //  CGPoint finalCenter = [self.nestTableView convertPoint:destinationPoint fromView:self.menuView];
   // self.menuView.scrollView.backgroundColor = LZMColorA(@"C11", 1);
    [UIView animateWithDuration:0.1
                            delay:0
                          options:UIViewAnimationOptionCurveEaseInOut
                       animations:^{
              //  self.menuView.scrollView.backgroundColor = LZMColor(@"C120");
                        self.menuView.frame = CGRectMake(0, 0, self.menuViewWidth, 44);
       // self.menuView.scrollView.width = self.menuView.width;
                         //  self.menuView.center = destinationPoint;
                       } completion:^(BOOL finished) {
                        //   [self.nestTableView setSegmentViewHeight:44.f];
                          // [self.menuView removeFromSuperview];
                        //   [self.menuViewContainer addSubview:self.menuView];
                         //  self.menuView.frame = CGRectMake(0, 0, self.menuView.width, 44);
                           }];
}

#pragma mark -- Http

- (void)getBanner{
    self.headerView.foodGroupModel = nil;
    [self setupControllers];
    [LZMMallService getMallBannerWithType:LZMMallTypeFood success:^(id  _Nullable responseObj, NSString * _Nullable message, NSInteger statusCode, NSUInteger responseCode) {
        [self.nestTableView.tableView.mj_header endRefreshing];
        self.headerView.banners = [LZMBanner mj_objectArrayWithKeyValuesArray:responseObj];
        CGFloat bannerHeight = self.headerView.banners.count == 0?0:88;
        CGFloat topHeight = 102 - (isIPhoneXSeries?60:36);
        self.tmpHeight = 211+topHeight+106*LZMWIDTH_SCALE +SafeAreaTopHeight+bannerHeight;
//        self.headerView.frame = CGRectMake(0, 0, self.headerView.width, 211+topHeight+106*LZMWIDTH_SCALE +SafeAreaTopHeight+bannerHeight);
//        self.tmpHeight = self.headerView.height;
    //    [self.nestTableView setHeaderViewHeight:self.headerView.height];
        [self getFoodGroupData];
    } failureHandle:^(NSError * _Nullable error, NSString * _Nullable message, NSInteger statusCode, NSUInteger responseCode) {
        self.headerView.foodGroupModel = nil;
        [self setupControllers];
        self.contentView.userInteractionEnabled = NO;
        [self.nestTableView.tableView.mj_header endRefreshing];
    }];
}

- (void)getFoodGroupData {
    [LZMFoodHomeService getFoodGroupsDataSuccess:^(id  _Nullable responseObj, NSString * _Nullable message, NSInteger statusCode, NSUInteger responseCode) {
        [self.nestTableView.tableView.mj_header endRefreshing];
        self.foodGroupModel = [LZMFoodGroupModel mj_objectWithKeyValues:responseObj];
        CGFloat topHeight = LZMArrayIsEmpty(self.foodGroupModel.fineFoodTemporaryGroup.fineFoodGoods)?199:0;
        self.headerView.frame = CGRectMake(0, 0, self.headerView.width, self.tmpHeight-topHeight);
        self.headerView.foodGroupModel = self.foodGroupModel;
        self.groups = self.foodGroupModel.fineFoodRecommendGroups;
        self.contentView.userInteractionEnabled = !LZMArrayIsEmpty(self.foodGroupModel.fineFoodRecommendGroups);
        [self.nestTableView setHeaderViewHeight:self.headerView.height];
        [self setupControllers];
    } failureHandle:^(NSError * _Nullable error, NSString * _Nullable message, NSInteger statusCode, NSUInteger responseCode) {
        if (self.groups.count > 0){
            [self setupControllers];
        }
        self.contentView.userInteractionEnabled = NO;
        self.headerView.foodGroupModel = nil;
        [self.nestTableView.tableView.mj_header endRefreshing];
    }];
}

#pragma mark -- HZMutiMenuViewDelegate

- (void)addCircularImg:(UIView *)hoverView {
    UIImageView *circularImgView = [[UIImageView alloc]initWithFrame:CGRectMake(0, 0, 20, 4)];
    circularImgView.image = LZMImage(@"lzm_ circular");
    circularImgView.contentMode = UIViewContentModeScaleAspectFit;
    [hoverView addSubview:circularImgView];
}

- (void)itemMenuView:(HZMutiMenuView *)itemMenuView selectItemAtIndex:(NSUInteger)index {
    [self.contentView scrollToIndex:index];
    if (LZMArrayIsEmpty(self.groups)) return;
    NSString *event = kAnyCanteenEntrance;
    [LZMDataAnalysis actionEvent:event eventId:@(self.groups[index].groupId).stringValue];
    //[LZMDataAnalysis setEventLabel:event dataId:@(self.groups[index].groupId).stringValue];
}

#pragma mark - MFPageViewDataSource & MFPageViewDelegate
- (NSUInteger)numberOfPagesInPageView:(MFPageView *)pageView {
    return [self.controllerViews count];
}

- (UIView *)pageView:(MFPageView *)pageView pageAtIndex:(NSUInteger)index {
    [self.menuView finishedProgress];
    [self.topMenuView finishedProgress];
    return self.controllers[index].view;
}


#pragma mark - scrollview
- (void)mallProductScrollViewBeginDragging:(__kindof UIScrollView *)scrollView{
    [self disablePanEnranceView];
}
- (void)mallProductScrollViewEndDragging:(__kindof UIScrollView *)scrollView{
    [self enablePanEntranceView];
}

- (void)mallProductScrollViewDidScroll:(__kindof UIScrollView *)scrollView{
    [self scrollViewDidScroll:scrollView];
}

- (void)scrollViewDidScroll:(UIScrollView *)scrollView{
    // 嵌套滚动
  //  NSLog(@"=====%f",scrollView.contentOffset.y);
//    CGFloat hight = scrollView.frame.size.height;
//    CGFloat contentOffset = scrollView.contentOffset.y;
//    CGFloat distanceFromBottom = scrollView.contentSize.height - contentOffset;
//    CGFloat offset = contentOffset - self.lastContentOffset;
//    self.lastContentOffset = contentOffset;
//    if (offset > 0 && contentOffset > 0) {
// //   NSLog(@"上拉行为");
//        _isDown = NO;
//      //  _nestTableView.isHover = NO;
//    }
//    if (offset < 0 && distanceFromBottom > hight) {
//       // _nestTableView.canScroll = NO;
//   // NSLog(@"下拉行为");
//        _isDown = YES;
//       // _nestTableView.isHover = YES;
//
//    }
    if (!_canContentScroll) {
        // 这里通过固定contentOffset，来实现不滚动
        scrollView.contentOffset = CGPointZero;
    } else if (scrollView.contentOffset.y <= 0) {
        _canContentScroll = NO;
        // 通知容器可以开始滚动
        _nestTableView.canScroll = YES;
    }
    scrollView.showsVerticalScrollIndicator = _canContentScroll;
}

- (void)pageViewDidScroll:(UIScrollView *)scrollView{
    self.menuView.progress = scrollView.contentOffset.x/scrollView.bounds.size.width;
    self.topMenuView.progress = scrollView.contentOffset.x/scrollView.bounds.size.width;
}

- (void)pageViewDidEndScroll:(UIScrollView *)scrollView{
    [self.menuView finishedProgress];
    [self.topMenuView finishedProgress];
}
#pragma mark - MFNestTableViewDelegate & MFNestTableViewDataSource
- (void)nestTableViewContentCanScroll:(MFNestTableView *)nestTableView {
    self.canContentScroll = YES;
}

- (void)nestTableViewContainerCanScroll:(MFNestTableView *)nestTableView {
    // 当容器开始可以滚动时，将所有内容设置回到顶部
    for (UIView *view in self.controllerViews) {
        UIScrollView *scrollView;
        if ([view isKindOfClass:[UIScrollView class]]) {
            scrollView = (UIScrollView *)view;
        }
        if (scrollView) {
            scrollView.contentOffset = CGPointZero;
        }
    }
}

- (void)nestTableViewDidScroll:(UIScrollView *)scrollView {
    // 监听容器的滚动，来设置NavigationBar的透明度
    CGFloat offset = scrollView.contentOffset.y;
    //无数据缓存上滑后无法下滑判断
    if (!self.headerView.foodGroupModel) {
        _nestTableView.canScroll = YES;
    }
//    if (offset >= self.headerView.height-SafeAreaTopHeight-1) {
//        if (!self.menuView.hidden) {
//            self.menuView.hidden = YES;
//            _topMenuView.hidden = NO;
//            [UIView animateWithDuration:0.3 animations:^{
//              //  [self.nestTableView setSegmentViewHeight:0];
//
//                self.topMenuView.frame = CGRectMake((LZMDevWidth - self.topMenuView.width)/2, SafeAreaTopHeight-44, self.topMenuView.width, 44);
//            } completion:^(BOOL finished) {
////                   [self.nestTableView setContentHeight:(LZMDevHeight - SafeAreaTopHeight - SafeAreaBottomHeight)];
//            }];
//
//        }
//    } else {
//        if (self.menuView.hidden) {
//            self.menuView.hidden = NO;
//             _topMenuView.hidden = YES;
//            [UIView animateWithDuration:0.3 animations:^{
//              //  [self.nestTableView setSegmentViewHeight:44.f];
//
//                self.topMenuView.frame = CGRectMake(0, SafeAreaTopHeight, self.topMenuView.width, 44);
//            } completion:^(BOOL finished) {
////                     [self.nestTableView setContentHeight:(LZMDevHeight - SafeAreaTopHeight - 0.f - SafeAreaBottomHeight)];
//            }];
//        }
//    }
        if (offset >= self.headerView.height-SafeAreaTopHeight-1) {
                [self moveUpMenuView:offset];
                 self.menuViewContainer.hidden = YES;
               self.navBarView.titleLable.hidden = YES;
            
        } else {
                if (self.menuViewContainer.hidden) {
                    self.menuViewContainer.hidden = NO;
                    [self moveDownMenuView:offset];
                    self.navBarView.titleLable.hidden = NO;
                }
        }
   
    CGFloat canScrollHeight = 150+SafeAreaTopHeight;//[_nestTableView heightForContainerCanScroll];
    //计算导航栏的透明度
    CGFloat minAlphaOffset = 0;
    CGFloat maxAlphaOffset = canScrollHeight;
    CGFloat alpha = (offset - minAlphaOffset) / (maxAlphaOffset - minAlphaOffset);
    alpha = MIN(1, alpha);
    alpha = MAX(0, alpha);
    self.naviAlpha = alpha;
    self.navBarView.titleColor = alpha>0.3?LZMColor(@"C4"):LZMColor(@"C11");
    [self.navBarView handleTrundNoTitleleAlpha:self.naviAlpha bg_ColorStr:@"C9" navTitle:@"美食"];
    [self setNeedsStatusBarAppearanceUpdate];
}

- (CGFloat)nestTableViewContentInsetTop:(MFNestTableView *)nestTableView {
    // 因为这里navigationBar.translucent == YES，所以实现这个方法，返回下面的值
    if (isIPhoneXSeries){
//        NSLog(@"是IphoneX系列");
    }

//    NSLog(@"top height : %.f \n bottomHeight: %.f", SafeAreaTopHeight, SafeAreaBottomHeight);
    return SafeAreaTopHeight;
}



#pragma mark - getter

- (MFNestTableView *)nestTableView{
    if (!_nestTableView) {
        _nestTableView = [[MFNestTableView alloc] initWithFrame:CGRectMake(0, 0, LZMDevWidth, LZMDevHeight)];
        _nestTableView.delegate = self;
        _nestTableView.dataSource = self;
        _nestTableView.tableView.panGestureRecognizer.cancelsTouchesInView = YES;
        _nestTableView.isHover = NO;
      //  _nestTableView.tableView.scrollEnabled = NO;
    }
    return _nestTableView;
}

- (LZMFoodHeaderView *)headerView {
    if (!_headerView) {
        _headerView = [[LZMFoodHeaderView alloc]initWithFrame:CGRectMake(0, 0, LZMDevWidth, 448+106*(LZMWIDTH_SCALE-1)+SafeAreaTopHeight)];
    }
    return _headerView;
}

- (MFPageView *)contentView{
    if (!_contentView) {
        _contentView = [[MFPageView alloc] initWithFrame:CGRectMake(0, 0, LZMDevWidth, LZMDevHeight - SafeAreaTopHeight - 44.f )];
        [_contentView.panGesture requireGestureRecognizerToFail:self.navigationController.interactivePopGestureRecognizer];
        _contentView.delegate = self;
        _contentView.dataSource = self;
    }
    return _contentView;
}

//- (HZMutiMenuView *)menuView {
//    if (!_menuView) {
//        _menuView = [[HZMutiMenuView alloc] initWithFrame:CGRectMake(0,0, LZMDevWidth-190, 44.f) items:self.titles icons:@[] config:^(HZMutiMenuConfig * _Nonnull config) {
//             config.normalFont = LZMFontMedium18;
//             config.highlightFont = LZMFontMedium18;
//             config.itemBackgroundColor = LZMColor(@"C120");
//             config.highlightColor = LZMColor(@"C4");
//             config.normalColor = LZMColorA(@"C4",0.4);
//             config.leftMargin = 12;
//             config.itemSpace = 30;
//             config.hoverWidth = 25.f;
//             config.hoverHeight = 2.f;
//             config.hoverBottomOffset = 4;
//         }];
//         _menuView.delegate = self;
//     }
//     return _menuView;
//}

//- (HZMutiMenuView *)topMenuView {
//    if (!_topMenuView) {
//        _topMenuView = [[HZMutiMenuView alloc] initWithFrame:CGRectMake(0,SafeAreaTopHeight, LZMDevWidth-190, 44.f) items:self.titles icons:@[] config:^(HZMutiMenuConfig * _Nonnull config) {
//             config.normalFont = LZMFontMedium18;
//             config.highlightFont = LZMFontMedium18;
//             config.itemBackgroundColor = LZMColor(@"C11");
//             config.highlightColor = LZMColor(@"C4");
//             config.normalColor = LZMColorA(@"C4",0.4);
//             config.leftMargin = 12;
//             config.itemSpace = 30;
//             config.hoverWidth = 25.f;
//             config.hoverHeight = 2.f;
//             config.hoverBottomOffset = 4;
//         }];
//         _topMenuView.delegate = self;
//        _topMenuView.hidden = YES;
//     }
//     return _topMenuView;
//}


- (LZMCustomNavBarView *)navBarView {
    if (!_navBarView) {
        _navBarView = [[LZMCustomNavBarView alloc]initWithFrame:CGRectMake(0, 0, LZMDevWidth, SafeAreaTopHeight) bgColor:LZMColorA(@"C10", 0)];
        [_navBarView setNavDefaultLeftImage:@"navigation_back_white" rightItem:@""];
        [_navBarView setNavDisplayLeftImage:@"navigation_back_black" rightItem:@""];
        WEAK_SELF(self);
        [_navBarView setLZMCustomNavBarViewBlock:^(LZMCustomNavBarViewTag type) {
            STRONG_SELF(self);
            if (type == LZMCustomNavBar_left_Tag) {
                [self.navigationController popViewControllerAnimated:true];
            }
        }];
        _navBarView.naviTitle = @"美食";
        _navBarView.titleColor = [UIColor whiteColor];
    }
    return _navBarView;
}

@end
//
//  LZMGoodShopViewController.m
//  LZM_SmartEdifice
//
//  Created by zzstc on 2020/9/2.
//  Copyright © 2020 SZ_LZM. All rights reserved.
//

#import "LZMGoodShopViewController.h"
#import "LZMGoodShopCell.h"
#import "LZMFoodHomeService.h"
#import "LZMShopModel.h"
static NSString *const kLZMGoodShopCell = @"LZMGoodShopCell";
@interface LZMGoodShopViewController ()
@property (nonatomic, assign) NSInteger pageNum ; /**< 1. 2. 3. ... **/
@property (nonatomic, assign) NSInteger pageSize ; /**< 20 **/
@property (nonatomic, strong) NSMutableArray <LZMShopModel *> *shopData;
@property (nonatomic, strong) NSMutableArray <LZMShopModel *> *shoplist;
@end

@implementation LZMGoodShopViewController

- (void)viewDidLoad {
    [super viewDidLoad];
    self.pageNum = 1;
    self.pageSize = 10;
    self.tableView.backgroundColor = LZMColor(@"C9");
    [self.tableView registerClass:[LZMGoodShopCell class] forCellReuseIdentifier:kLZMGoodShopCell];
    self.tableView.separatorStyle = UITableViewCellSeparatorStyleNone;
    [self.tableView setEmptyTipConfig];
    if (_isDefault) {
        self.shopData = nil;
        [self.tableView reloadData];
    } else
    [self getNetData];
    // Do any additional setup after loading the view.
}

- (void)viewWillAppear:(BOOL)animated {
    [super viewWillAppear:animated];
    if (self.isFromTopGroups) {
        UIButton *leftButton = [UIButton buttonWithType:UIButtonTypeCustom];
       leftButton.frame = CGRectMake(0, 0, 18, 18);
       leftButton.imageView.contentMode = UIViewContentModeScaleAspectFit;
       [leftButton setImage:LZMImage(@"navigation_back_black") forState:UIControlStateNormal];
       [leftButton addTarget:self action:@selector(backAction) forControlEvents:UIControlEventTouchUpInside];
       UIView *leftCustomView = [[UIView alloc]initWithFrame:leftButton.frame];
       [leftCustomView addSubview:leftButton];
       self.navigationItem.leftBarButtonItem = [[UIBarButtonItem alloc] initWithCustomView:leftCustomView];
        [self.navigationController setNavigationBarHidden:NO animated:true];
    }
}

- (void)backAction {
    [self.navigationController popViewControllerAnimated:YES];
}

#pragma mark -- http
- (void)getNetData {
    self.shopData = nil;
    [LZMFoodHomeService getShopListWithType:1 success:^(id  _Nullable responseObj, NSString * _Nullable message, NSInteger statusCode, NSUInteger responseCode) {
        self.shopData = [LZMShopModel mj_objectArrayWithKeyValuesArray:responseObj];
        if (LZMArrayIsEmpty(self.shopData)) {
            [self listNoData];
         }
        [self.tableView reloadData];
    } failureHandle:^(NSError * _Nullable error, NSString * _Nullable message, NSInteger statusCode, NSUInteger responseCode) {
        
    }];
    
}

- (void)refreshData{
    [self getNetData];
}

/** 无内容 */
- (void)listNoData {
    self.tableView.emptyType = LZMEmptyDataType_noData;
    self.tableView.noDataTipImg = [[SingleDataHelper sharedSingleDataHelper]getAppEmptyDataKey:no_RecordsImage];
    self.tableView.noDataTipMsg =  @"暂无数据";
}

#pragma mark - scrollview delegate
- (void)scrollViewWillBeginDragging:(UIScrollView *)scrollView{
    if (self.mallScrollDelegate && [self.mallScrollDelegate respondsToSelector:@selector(mallProductScrollViewBeginDragging:)]){
        [self.mallScrollDelegate mallProductScrollViewBeginDragging:scrollView];
    }
}

///用于判断手指是否离开了 要做到当用户手指离开了，tableview滑道顶部，也不显示出主控制器
- (void)scrollViewWillEndDragging:(UIScrollView *)scrollView withVelocity:(CGPoint)velocity targetContentOffset:(inout CGPoint *)targetContentOffset {
    if (self.mallScrollDelegate && [self.mallScrollDelegate respondsToSelector:@selector(mallProductScrollViewEndDragging:)]){
        [self.mallScrollDelegate mallProductScrollViewEndDragging:scrollView];
    }
}

- (void)scrollViewDidScroll:(UIScrollView *)scrollView{
    if (self.mallScrollDelegate && [self.mallScrollDelegate respondsToSelector:@selector(mallProductScrollViewDidScroll:)]){
        [self.mallScrollDelegate mallProductScrollViewDidScroll:scrollView];
    }
}
#pragma mark - UITableViewDelegate&&UITableViewDatasource
- (NSInteger)tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section {
    return self.shopData?self.shopData.count:1;
}

- (UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath {
    NSLog(@"asdasd");
    LZMGoodShopCell *cell = [tableView dequeueReusableCellWithIdentifier:kLZMGoodShopCell forIndexPath:indexPath];
    cell.shopModel = self.shopData?self.shopData[indexPath.row]:nil;
    return cell;
}

- (CGFloat)tableView:(UITableView *)tableView heightForRowAtIndexPath:(NSIndexPath *)indexPath {
    return 232;
}

- (CGFloat)tableView:(UITableView *)tableView heightForHeaderInSection:(NSInteger)section {
    return 0.0001f;
}
- (UIView *)tableView:(UITableView *)tableView viewForHeaderInSection:(NSInteger)section {
    UIView *header = [[UIView alloc] initWithFrame:CGRectMake(0, 0, self.view.bounds.size.width, 0.1f)];
    header.backgroundColor = [UIColor whiteColor];
    return header;
}
- (CGFloat)tableView:(UITableView *)tableView heightForFooterInSection:(NSInteger)section {
    return 0.0001f;
}
- (UIView *)tableView:(UITableView *)tableView viewForFooterInSection:(NSInteger)section {
    UIView *footer = [[UIView alloc] initWithFrame:CGRectMake(0, 0, self.view.bounds.size.width, 0.0001f)];
    return footer;
}

@end

//
//  LZMFoodRecommendCollectionViewController.m
//  LZM_SmartEdifice
//
//  Created by zzstc on 2020/9/2.
//  Copyright © 2020 SZ_LZM. All rights reserved.
//

#import "LZMFoodRecommendCollectionViewController.h"
#import "LZMFoodRecommendCollectionViewCell.h"
#import "LZMFoodHomeService.h"
#import "LZMProduct.h"
#import "CollectionWaterfallLayout.h"
#import "LZMFoodStoreDetailController.h"

@interface LZMFoodRecommendCollectionViewController ()<CollectionWaterfallLayoutProtocol>
@property (nonatomic, assign) NSInteger pageNum ; /**< 1. 2. 3. ... **/
@property (nonatomic, assign) NSInteger pageSize ; /**< 10 **/
@property (nonatomic, strong) NSMutableArray <LZMProduct *>* products ; /**< <# #> **/
@property (nonatomic, strong) CollectionWaterfallLayout *waterfallLayout;
@end

@implementation LZMFoodRecommendCollectionViewController

static NSString * const kLZMFoodRecommendCollectionViewCell = @"LZMFoodRecommendCollectionViewCell";


+ (LZMFoodRecommendCollectionViewController *)getFoodRecommendCollectionViewController{
    CollectionWaterfallLayout *waterfallLayout  = [[CollectionWaterfallLayout alloc] init];
    waterfallLayout.columnSpacing = 5;
    waterfallLayout.itemSpacing = 5;
    waterfallLayout.columns = 2;
    waterfallLayout.insets = UIEdgeInsetsMake(12, 11, 12, 11);
//    CGFloat cellWidth = (LZMDevWidth - 29)/2;
//    CGFloat cellHeight = 264;
//    layout.estimatedItemSize = CGSizeMake(cellWidth, cellHeight);
    LZMFoodRecommendCollectionViewController *recommendVC = [[LZMFoodRecommendCollectionViewController alloc] initWithCollectionViewLayout:waterfallLayout];
    recommendVC.waterfallLayout = waterfallLayout;
    return recommendVC;
}

- (BOOL)shouldInvalidateLayoutForBoundsChange:(CGRect)newBounds {
    return true;
}

- (void)viewDidLoad {
    [super viewDidLoad];
    self.waterfallLayout.delegate = self;
    // Uncomment the following line to preserve selection between presentations
    // self.clearsSelectionOnViewWillAppear = NO;
    self.pageNum = 1;
    self.pageSize = 10;
    self.collectionView.backgroundColor = LZMColor(@"C9");
    self.collectionView.showsVerticalScrollIndicator = NO;
    self.collectionView.alwaysBounceVertical = YES;
    [self.collectionView setEmptyTipConfig];
    [self.collectionView registerClass:[LZMFoodRecommendCollectionViewCell class] forCellWithReuseIdentifier:kLZMFoodRecommendCollectionViewCell];
    [self.collectionView registerClass:[UICollectionReusableView class] forSupplementaryViewOfKind:UICollectionElementKindSectionHeader withReuseIdentifier:@"header"];
    self.collectionView.mj_footer = [MJRefreshAutoNormalFooter createAutoFooterRefreshingBlock:^{
         self.pageNum ++;
         [self requestMoreData];
     }];
}
- (void)viewWillAppear:(BOOL)animated {
    [super viewWillAppear:animated];
    if (self.isFromTopGroups) {
        UIButton *leftButton = [UIButton buttonWithType:UIButtonTypeCustom];
        leftButton.frame = CGRectMake(0, 0, 18, 18);
        leftButton.imageView.contentMode = UIViewContentModeScaleAspectFit;
        [leftButton setImage:LZMImage(@"navigation_back_black") forState:UIControlStateNormal];
        [leftButton addTarget:self action:@selector(backAction) forControlEvents:UIControlEventTouchUpInside];
        UIView *leftCustomView = [[UIView alloc]initWithFrame:leftButton.frame];
        [leftCustomView addSubview:leftButton];
        self.navigationItem.leftBarButtonItem = [[UIBarButtonItem alloc] initWithCustomView:leftCustomView];
        [self.navigationController setNavigationBarHidden:NO animated:true];
    }
    if (LZMArrayIsEmpty(self.products)) {
        [self getNetData];
    }
}

- (void)backAction {
    [self.navigationController popViewControllerAnimated:YES];
}

- (void)loadMoreData {
    self.pageNum ++;
    [self requestMoreData];
}

- (void)getNetData {
    [LZMFoodHomeService getProductsWithGroupId:self.groupId pageNum:self.pageNum pageSize:self.pageSize success:^(id  _Nullable responseObj, NSString * _Nullable message, NSInteger statusCode, NSUInteger responseCode) {
        self.products = [LZMProduct mj_objectArrayWithKeyValuesArray:responseObj[@"list"]];
        if (LZMArrayIsEmpty(self.products)) {
            [self listNoData];
        }
        NSInteger total = [responseObj[@"total"] integerValue];
        if (total == self.products.count){
            [self.collectionView.mj_footer endRefreshingWithNoMoreData];
        }
        [self.collectionView reloadData];
//        [self.collectionView layoutIfNeeded];
//        if (self.collectionView.mj_footer.mj_y<self.collectionView.height) {
//            [self.collectionView.mj_footer setHidden:YES];
//        } else {
//            [self.collectionView.mj_footer setHidden:NO];
//        }
    } failureHandle:^(NSError * _Nullable error, NSString * _Nullable message, NSInteger statusCode, NSUInteger responseCode) {
        [self.collectionView.mj_footer setHidden:YES];
        NSLog(@"%@",error.localizedDescription);
    }];
}

- (void)requestMoreData{
    [LZMFoodHomeService getProductsWithGroupId:self.groupId pageNum:self.pageNum pageSize:self.pageSize success:^(id  _Nullable responseObj, NSString * _Nullable message, NSInteger statusCode, NSUInteger responseCode) {
        NSArray *products = [LZMProduct mj_objectArrayWithKeyValuesArray:responseObj[@"list"]];
        [self.products addObjectsFromArray:products];
        NSInteger total = [responseObj[@"total"] integerValue];
        if (total == self.products.count){
            [self.collectionView.mj_footer endRefreshingWithNoMoreData];
        }else{
            [self.collectionView.mj_footer endRefreshing];
        }
        [self.collectionView reloadData];
    } failureHandle:^(NSError * _Nullable error, NSString * _Nullable message, NSInteger statusCode, NSUInteger responseCode) {
        [self.collectionView.mj_footer endRefreshing];
    }];
}

/** 数据为空 */
- (void)listNoData {
    self.collectionView.emptyType = LZMEmptyDataType_noData;
    self.collectionView.noDataTipImg = [[SingleDataHelper sharedSingleDataHelper]getAppEmptyDataKey:no_ProductsImage];
    self.collectionView.noDataTipMsg = [[SingleDataHelper sharedSingleDataHelper]getAppEmptyDataKey:no_ProductsDescrib];
}

- (void)refreshData{
    self.pageNum = 1;
    self.pageSize = 10;
    [self.collectionView.mj_footer resetNoMoreData];
    [self getNetData];
}

/*
#pragma mark - Navigation

// In a storyboard-based application, you will often want to do a little preparation before navigation
- (void)prepareForSegue:(UIStoryboardSegue *)segue sender:(id)sender {
    // Get the new view controller using [segue destinationViewController].
    // Pass the selected object to the new view controller.
}
*/

#pragma mark - scrollview delegate
- (void)scrollViewWillBeginDragging:(UIScrollView *)scrollView{
    if (self.mallScrollDelegate && [self.mallScrollDelegate respondsToSelector:@selector(mallProductScrollViewBeginDragging:)]){
        [self.mallScrollDelegate mallProductScrollViewBeginDragging:scrollView];
    }
}

///用于判断手指是否离开了 要做到当用户手指离开了，tableview滑道顶部，也不显示出主控制器
- (void)scrollViewWillEndDragging:(UIScrollView *)scrollView withVelocity:(CGPoint)velocity targetContentOffset:(inout CGPoint *)targetContentOffset {
    if (self.mallScrollDelegate && [self.mallScrollDelegate respondsToSelector:@selector(mallProductScrollViewEndDragging:)]){
        [self.mallScrollDelegate mallProductScrollViewEndDragging:scrollView];
    }
}

- (void)scrollViewDidScroll:(UIScrollView *)scrollView{
    if (self.mallScrollDelegate && [self.mallScrollDelegate respondsToSelector:@selector(mallProductScrollViewDidScroll:)]){
        [self.mallScrollDelegate mallProductScrollViewDidScroll:scrollView];
    }
}

#pragma mark <UICollectionViewDataSource>

- (NSInteger)numberOfSectionsInCollectionView:(UICollectionView *)collectionView {
    return 1;
}


- (NSInteger)collectionView:(UICollectionView *)collectionView numberOfItemsInSection:(NSInteger)section {
    return self.products.count;
}

- (UICollectionViewCell *)collectionView:(UICollectionView *)collectionView cellForItemAtIndexPath:(NSIndexPath *)indexPath {
    LZMFoodRecommendCollectionViewCell *cell = [collectionView dequeueReusableCellWithReuseIdentifier:kLZMFoodRecommendCollectionViewCell forIndexPath:indexPath];
    cell.productModel = self.products[indexPath.row];
    return cell;
}


- (UICollectionReusableView *)collectionView:(UICollectionView *)collectionView viewForSupplementaryElementOfKind:(NSString *)kind atIndexPath:(NSIndexPath *)indexPath {
   // if([kind isEqualToString:UICollectionElementKindSectionHeader]){
        UICollectionReusableView *headerView = [collectionView dequeueReusableSupplementaryViewOfKind:UICollectionElementKindSectionHeader withReuseIdentifier:@"header" forIndexPath:indexPath];
        return headerView;
   // }
}
- (void)collectionView:(UICollectionView *)collectionView didSelectItemAtIndexPath:(NSIndexPath *)indexPath {
    LZMFoodStoreDetailController *vc = [LZMFoodStoreDetailController new];
    vc.shopId = self.products[indexPath.row].shopId.integerValue;
    [vc scrollToGroupId:self.products[indexPath.row].groupId.integerValue goodId:self.products[indexPath.row].goodsId.integerValue];
    [NSObject.getCurrentVC.navigationController pushViewController:vc animated:YES];
}

#pragma mark - CollectionWaterfallLayoutProtocol
- (CGFloat)collectionViewLayout:(CollectionWaterfallLayout *)layout heightForItemAtIndexPath:(NSIndexPath *)indexPath {
    LZMProduct *model = self.products[indexPath.row];
    CGSize size = [model.goodsName sizeOfConstantWidth:(LZMDevWidth-29)/2-16 font:LZMFontMedium16];
    return 264+size.height-20;
}

- (CGFloat)collectionViewLayout:(CollectionWaterfallLayout *)layout heightForSupplementaryViewAtIndexPath:(NSIndexPath *)indexPath {
    return 0;
}

#pragma mark <UICollectionViewDelegate>

/*
// Uncomment this method to specify if the specified item should be highlighted during tracking
- (BOOL)collectionView:(UICollectionView *)collectionView shouldHighlightItemAtIndexPath:(NSIndexPath *)indexPath {
	return YES;
}
*/

/*
// Uncomment this method to specify if the specified item should be selected
- (BOOL)collectionView:(UICollectionView *)collectionView shouldSelectItemAtIndexPath:(NSIndexPath *)indexPath {
    return YES;
}
*/

/*
// Uncomment these methods to specify if an action menu should be displayed for the specified item, and react to actions performed on the item
- (BOOL)collectionView:(UICollectionView *)collectionView shouldShowMenuForItemAtIndexPath:(NSIndexPath *)indexPath {
	return NO;
}

- (BOOL)collectionView:(UICollectionView *)collectionView canPerformAction:(SEL)action forItemAtIndexPath:(NSIndexPath *)indexPath withSender:(id)sender {
	return NO;
}

- (void)collectionView:(UICollectionView *)collectionView performAction:(SEL)action forItemAtIndexPath:(NSIndexPath *)indexPath withSender:(id)sender {
	
}
*/

@end

//
//  LZMFoodHeaderView.m
//  LZM_SmartEdifice
//
//  Created by zzstc on 2020/9/1.
//  Copyright © 2020 SZ_LZM. All rights reserved.
//

#import "LZMFoodHeaderView.h"
#import "LZMFoodTypeView.h"
#import "LZMFoodView.h"
#import "AnimatedBannerView.h"
#import "UIView+HGCorner.h"
#import "LZMFoodGroupModel.h"
@interface LZMFoodHeaderView ()<AnimatedBannerViewDelegate>
@property (nonatomic, strong)LZMFoodView *foodView;
@property (nonatomic, strong)LZMFoodTypeView *foodTypeView;
@property (nonatomic, strong)UIView *topView;
@property (nonatomic, strong)NSArray *itemTitleArr;
@property (nonatomic, strong)UILabel *pageLabel;
@property (nonatomic, strong)UIImageView *maskImgView;
@end

@implementation LZMFoodHeaderView


- (instancetype)initWithFrame:(CGRect)frame {
    self = [super initWithFrame:frame];
    if (self) {
        self.backgroundColor = LZMColor(@"C9");
        self.itemTitleArr = @[@"楼内专享",@"专人配送",@"优质商家"];
        [self createSubView];
    }
    return self;
}

- (void)createSubView {
    [self addSubview:self.maskImgView];
    [self.maskImgView mas_makeConstraints:^(MASConstraintMaker *make) {
        make.top.left.right.mas_equalTo(0);
        make.height.mas_equalTo(SafeAreaTopHeight+102);
    }];

    [self addSubview:self.foodTypeView];
    [self.foodTypeView mas_makeConstraints:^(MASConstraintMaker *make) {
//        make.top.mas_equalTo(self.maskImgView.mas_bottom).offset(isIPhoneXSeries?-60:-36);
        make.top.mas_equalTo(isIPhoneXSeries?SafeAreaTopHeight+42:SafeAreaTopHeight+66);
        make.left.mas_equalTo(12);
        make.right.mas_equalTo(-12);
        make.height.mas_equalTo(106*LZMWIDTH_SCALE);
    }];
    [self addSubview:self.foodView];
    [self.foodView mas_makeConstraints:^(MASConstraintMaker *make) {
        make.top.mas_equalTo(self.foodTypeView.mas_bottom).offset(12);
        make.left.mas_equalTo(12);
        make.right.mas_equalTo(-12);
        make.height.mas_equalTo(187);
    }];
    [self addSubview:self.bannerView];
    [self.bannerView mas_makeConstraints:^(MASConstraintMaker *make) {
        make.top.mas_equalTo(self.foodView.mas_bottom).offset(12);
        make.left.mas_equalTo(12);
        make.right.mas_equalTo(-12);
        make.height.mas_equalTo(76);
        make.bottom.mas_equalTo(-12);
    }];
    [self.bannerView addSubview:self.pageLabel];
    [self.pageLabel mas_makeConstraints:^(MASConstraintMaker *make) {
        make.right.mas_equalTo(-8);
        make.bottom.mas_equalTo(-11);
        make.width.mas_greaterThanOrEqualTo(26*LZMWIDTH_SCALE);
    }];
}

#pragma mark -- delegate
- (void)animatedBannerView:(AnimatedBannerView *)bannerView selectAtIndex:(NSUInteger)index{
    LZMBanner *banner = self.banners[index];
    NSString *event = kAnyCanteenHomePageBanner;
    [LZMDataAnalysis actionEvent:event eventId:banner.bannerId];
    [LZMWebViewHelper handleJumpId:banner.jumpId jumpType:banner.jumpType jumpUrl:banner.infoUrl title:banner.title controller:self.viewController];
}

- (void)animatedBannerView:(AnimatedBannerView *)bannerView didScrollToIndex:(NSUInteger)index {
    self.pageLabel.text = [NSString stringWithFormat:@"%ld/%ld",index+1,self.banners.count];
}

#pragma mark -- setter&&getter

- (void)setBanners:(NSArray<LZMBanner *> *)banners {
    _banners = banners;
    if (_banners.count > 0) {
        _pageLabel.hidden = _banners.count>1?NO:YES;
        [self.bannerView mas_updateConstraints:^(MASConstraintMaker *make) {
            make.height.mas_equalTo(76);
        }];
        NSMutableArray *bannerImages = [NSMutableArray array];
         for (LZMBanner *banner in self.banners) {
            [bannerImages addObject:banner.imageUrl];
         }
         self.bannerView.imageStringUrls = bannerImages;
        self.pageLabel.text = [NSString stringWithFormat:@"1/%ld",self.banners.count];
    } else {
        _pageLabel.hidden = YES;
        [self.bannerView mas_updateConstraints:^(MASConstraintMaker *make) {
            make.height.mas_equalTo(0);
        }];
    }
}

- (void)setFoodGroupModel:(LZMFoodGroupModel *)foodGroupModel {
    _foodGroupModel = foodGroupModel;
    if (_foodGroupModel) {
        if (LZMArrayIsEmpty(_foodGroupModel.fineFoodTemporaryGroup.fineFoodGoods)) {
            [self.foodView mas_remakeConstraints:^(MASConstraintMaker *make) {
                make.top.mas_equalTo(self.foodTypeView.mas_bottom).offset(0);
                make.left.mas_equalTo(12);
                make.right.mas_equalTo(-12);
                make.height.mas_equalTo(0);
            }];
        } else {
            [self.foodView mas_remakeConstraints:^(MASConstraintMaker *make) {
                 make.top.mas_equalTo(self.foodTypeView.mas_bottom).offset(12);
                 make.left.mas_equalTo(12);
                 make.right.mas_equalTo(-12);
                 make.height.mas_equalTo(187);
             }];
        }
        self.foodTypeView.fineFoodTopGroups = LZMArrayIsEmpty(_foodGroupModel.fineFoodTopGroups)?nil: _foodGroupModel.fineFoodTopGroups;
        
        self.foodView.fineFoodTemporaryGroupModel = _foodGroupModel.fineFoodTemporaryGroup;
    } else {
        self.foodTypeView.fineFoodTopGroups = nil;
        self.foodView.fineFoodTemporaryGroupModel = nil;
    }
    
}

- (void)refreshData {
    [self.foodView refreshData];
}



- (UIView *)topView {
    if (!_topView) {
        _topView = [UIView new];
    }
    return _topView;
}

- (LZMFoodTypeView *)foodTypeView {
    if (!_foodTypeView) {
        _foodTypeView = [LZMFoodTypeView new];
    }
    return _foodTypeView;
}

- (LZMFoodView *)foodView {
    if (!_foodView) {
        _foodView = [[LZMFoodView alloc] initWithFrame:CGRectZero foodType:LZMFoodViewTypeRecommend];
    }
    return _foodView;
}

- (AnimatedBannerView *)bannerView{
    if (!_bannerView) {
        _bannerView = [[AnimatedBannerView alloc] initWithFrame:CGRectMake(0, 0, LZMDevWidth-24, 76)];
        _bannerView.pageControlStyle = BannerPageControlStyleNone;
        _bannerView.placeholderImage = kBannerPlaceholderImage;
        _bannerView.delegate = self;
        _bannerView.backgroundColor = LZMColor(@"C127");
        //_bannerView.userInteractionEnabled = NO;
        [_bannerView hg_setAllCornerWithCornerRadius:12];
    }
    return _bannerView;
}

- (UILabel *)pageLabel {
    if (!_pageLabel) {
        _pageLabel = [UILabel new];
        _pageLabel.font = LZMFont(LZMSize(@"T6"), LZMFontName(@"F3"));
        _pageLabel.textColor = [UIColor whiteColor];
        [_pageLabel hg_setAllCornerWithCornerRadius:7];
        _pageLabel.backgroundColor = LZMColorA(@"C12", 0.3);
        _pageLabel.textAlignment = NSTextAlignmentCenter;
        _pageLabel.hidden = YES;
    }
    return _pageLabel;
}

- (UIImageView *)maskImgView {
    if (!_maskImgView) {
        _maskImgView = [UIImageView new];
        _maskImgView.image = LZMImage(@"lzm_food_home_mask");
    }
    return _maskImgView;
}

@end

//
//  LZMFoodTypeView.m
//  LZM_SmartEdifice
//
//  Created by zzstc on 2020/9/1.
//  Copyright © 2020 SZ_LZM. All rights reserved.
//

#import "LZMFoodTypeView.h"
#import "ExtendButton.h"
#import "UIView+HGCorner.h"
#import "LZMFoodGroupModel.h"
#import "LZMGoodShopViewController.h"
#import "LZMFoodRecommendCollectionViewController.h"
@interface LZMFoodTypeView ()
@property (nonatomic, strong)UIScrollView *scrollView;
@property (nonatomic, strong)UIView *contentView;
@property (nonatomic, strong)NSMutableArray *btnArr;
@property (nonatomic, strong)NSArray *btnTitleArr;
@end

@implementation LZMFoodTypeView

- (instancetype)initWithFrame:(CGRect)frame {
    self = [super initWithFrame:frame];
    if (self) {
        self.backgroundColor = [UIColor whiteColor];
        [self hg_setAllCornerWithCornerRadius:12];
        self.btnArr = [NSMutableArray new];
        [self createSubView];
    }
    return self;
}

- (void)layoutSubviews {
   
}

- (void)createSubView {
    [self addSubview:self.scrollView];
    [self.scrollView mas_makeConstraints:^(MASConstraintMaker *make) {
        (void)make.edges;
    }];
    self.contentView = [UIView new];
    self.contentView.backgroundColor = [UIColor whiteColor];
    [self.scrollView addSubview:self.contentView];
    [self.contentView mas_makeConstraints:^(MASConstraintMaker *make) {
        make.edges.mas_equalTo(self.scrollView);
        make.height.mas_equalTo(self.scrollView);
    }];

   
}

- (void)setFineFoodTopGroups:(NSArray<FineFoodTopGroupsModel *> *)fineFoodTopGroups {
    _fineFoodTopGroups = fineFoodTopGroups;
    [self createBtnItems];
}

- (void)createBtnItems {
    [self.contentView removeAllSubviews];
    [self layoutIfNeeded];
    CGFloat btnWidth = (LZMDevWidth-24-50-36*3)/4;
    NSInteger itemsCount = self.fineFoodTopGroups.count<7?self.fineFoodTopGroups.count:6;
    NSMutableArray *defaultArr;
    if(!self.fineFoodTopGroups) {
        itemsCount = 4;
        defaultArr = @[@"",@"",@"",@""].mutableCopy;
    }
    for (NSInteger i = 0; i<itemsCount; i++) {
        UIView *btnView = [UIView new];
        [self.contentView addSubview:btnView];
        [btnView mas_makeConstraints:^(MASConstraintMaker *make) {
            make.left.mas_equalTo(25+(btnWidth+36)*i);
            make.centerY.mas_equalTo(self.contentView.mas_centerY);
            make.width.mas_equalTo(btnWidth);
            make.height.mas_equalTo(78*LZMWIDTH_SCALE);
            if (i == itemsCount-1) {
                make.right.mas_equalTo(self.contentView.mas_right).offset(-25);
            }
        }];
        UIImageView *imgView = [UIImageView new];
        [imgView sd_setImageWithURL:[NSURL URLWithString:self.fineFoodTopGroups[i].iconUrl]];
        [btnView addSubview:imgView];
        UILabel *label = [UILabel labelWithFont:LZMFont12 textColor:@"C5"];
        label.text = self.fineFoodTopGroups?self.fineFoodTopGroups[i].groupName:defaultArr[i];
        label.textAlignment = NSTextAlignmentCenter;
        [btnView addSubview:label];
        [imgView mas_makeConstraints:^(MASConstraintMaker *make) {
            make.left.top.right.mas_equalTo(0);
            make.height.mas_equalTo(btnWidth);
        }];
        [label mas_makeConstraints:^(MASConstraintMaker *make) {
            make.bottom.mas_equalTo(0);
            make.width.mas_greaterThanOrEqualTo(48);
            make.height.mas_greaterThanOrEqualTo(15);
            make.centerX.mas_equalTo(btnView.mas_centerX);
        }];
        label.backgroundColor = LZMColor(@"C11");
        if(!self.fineFoodTopGroups) {
            imgView.backgroundColor = LZMColor(@"C127");
            label.backgroundColor = LZMColor(@"C127");
            [imgView hg_setAllCornerWithCornerRadius:4];
        } else {
            [imgView hg_setAllCornerWithCornerRadius:0];
        }
       // btnView.tag = self.fineFoodTopGroups[i].groupId;
        [btnView bk_whenTapped:^{
            if (!self.fineFoodTopGroups) return;
            if (self.fineFoodTopGroups[i].contentKind == 1) {
                LZMFoodRecommendCollectionViewController *recommendVC = [LZMFoodRecommendCollectionViewController getFoodRecommendCollectionViewController];
                recommendVC.groupId = @(self.fineFoodTopGroups[i].groupId).stringValue;
                recommendVC.title = self.fineFoodTopGroups[i].groupName;
                recommendVC.isFromTopGroups = YES;
                [self.viewController.navigationController pushViewController:recommendVC animated:YES];
                
            } else {
                LZMGoodShopViewController *shopVC = [LZMGoodShopViewController new];
                shopVC.title = self.fineFoodTopGroups[i].groupName;
                shopVC.isFromTopGroups = YES;
                [self.viewController.navigationController pushViewController:shopVC animated:YES];
            }
        }];
    }
}

- (UIScrollView *)scrollView {
    if (!_scrollView) {
        _scrollView = [UIScrollView new];
        _scrollView.showsHorizontalScrollIndicator = NO;
    }
    return _scrollView;
}

- (void)clickAction:(UIButton *)sender {
    
}

@end

//
//  LZMFoodView.m
//  LZM_SmartEdifice
//
//  Created by zzstc on 2020/9/1.
//  Copyright © 2020 SZ_LZM. All rights reserved.
//

#import "LZMFoodView.h"
#import "UIView+HGCorner.h"
#import "LZMFoodCollectionViewCell.h"
#import "LZMFoodGroupModel.h"
#import "LZMShopModel.h"
#import "LZMFoodStoreDetailController.h"
#import "HZAlert.h"
static NSString *const kLZMFoodCollectionViewCell = @"LZMFoodCollectionViewCell";
@interface LZMFoodView ()<UICollectionViewDelegate,UICollectionViewDataSource>
@property (nonatomic, strong)UIView *shopView;
@property (nonatomic, strong)UIImageView *shopImageView;//商铺图片
@property (nonatomic, strong)UILabel *shopNameLabel;//商铺名字
@property (nonatomic, strong)UILabel *salesLabel;//销量
@property (nonatomic, strong)UILabel *distributionLabel;//配送价格
@property (nonatomic, strong)UILabel *minPriceLabel;//起送价
@property (nonatomic, strong)UILabel *titleLable;
@property (nonatomic, strong)UILabel *defaultLabel; //预加载
@property (nonatomic, strong)NSMutableArray *couponArr;
@property (nonatomic, strong)UICollectionView *collectionView;
@property (nonatomic, strong)UIImageView *moreImgView;
@end

@implementation LZMFoodView

- (instancetype)initWithFrame:(CGRect)frame foodType:(LZMFoodViewType)foodViewType {
    if (self = [super init]) {
        self.frame = frame;
        self.backgroundColor = [UIColor whiteColor];
        [self hg_setAllCornerWithCornerRadius:12];
        self.foodViewType = foodViewType;
        self.couponArr = [NSMutableArray new];
        [self creatSubView];
    }
    return self;
}

- (instancetype)initWithFrame:(CGRect)frame {
    self = [super initWithFrame:frame];
    if (self) {
        self.backgroundColor = [UIColor whiteColor];
        [self hg_setAllCornerWithCornerRadius:12];
    }
    return self;
}

- (void)creatSubView {
    [self addSubview:self.collectionView];
    if (self.foodViewType == LZMFoodViewTypeRecommend) {
        [self addSubview:self.titleLable];
        [self.titleLable mas_makeConstraints:^(MASConstraintMaker *make) {
            make.left.mas_equalTo(12);
            make.top.mas_equalTo(14);
        }];
        [self.collectionView mas_makeConstraints:^(MASConstraintMaker *make) {
            make.left.right.mas_equalTo(0);
            make.top.mas_equalTo(self.titleLable.mas_bottom).offset(12);
            make.bottom.mas_equalTo(-12);
        }];
    } else {
        [self creatShopView];
        [self.collectionView mas_makeConstraints:^(MASConstraintMaker *make) {
            make.left.right.mas_equalTo(0);
            make.top.mas_equalTo(self.shopView.mas_bottom).offset(0);
            make.bottom.mas_equalTo(0);
        }];
    }

}

- (void)setFineFoodTemporaryGroupModel:(FineFoodTemporaryGroupModel *)fineFoodTemporaryGroupModel {
    _fineFoodTemporaryGroupModel = fineFoodTemporaryGroupModel;
    self.titleLable.text = _fineFoodTemporaryGroupModel?_fineFoodTemporaryGroupModel.groupName:@"今日推荐";
    [self.collectionView reloadData];
}

- (void)setShopModel:(LZMShopModel *)shopModel {
    _shopModel = shopModel;
    if (!shopModel) {
        _moreImgView.hidden = YES;
        self.defaultLabel.hidden = NO;
        self.shopImageView.backgroundColor = LZMColor(@"C127");
        self.shopNameLabel.backgroundColor = LZMColor(@"C127");
        self.salesLabel.backgroundColor = LZMColor(@"C127");
        self.salesLabel.text = @"                       ";
        self.defaultLabel.text = @"                       ";
        self.shopNameLabel.text = @"                                     ";
        return;
    }
    _moreImgView.hidden = NO;
    self.defaultLabel.hidden = YES;
    [self.shopImageView sd_setImageWithURL:[NSURL URLWithString:shopModel.logoImg]];
    self.shopNameLabel.text = _shopModel.shopName;
    self.salesLabel.text = [NSString stringWithFormat:@"已售%ld",_shopModel.totalSales];
    self.distributionLabel.text = _shopModel.deliveryFee == 0?@"免配送费":[NSString stringWithFormat:@"配送￥%0.2f",_shopModel.deliveryFee/100];
    self.minPriceLabel.text = [NSString stringWithFormat:@"起送￥%0.2f",_shopModel.startExpressAmount/100.f];
    if (!LZMArrayIsEmpty(_shopModel.coupons)) {
        [self.salesLabel mas_updateConstraints:^(MASConstraintMaker *make) {
           make.top.mas_equalTo(self.shopNameLabel.mas_bottom).offset(3);
        }];
        [self createDiscountView:_shopModel.coupons];
    } else {
        [self.salesLabel mas_updateConstraints:^(MASConstraintMaker *make) {
            make.top.mas_equalTo(self.shopNameLabel.mas_bottom).offset(23);
         }];
    }
    self.shopImageView.backgroundColor = LZMColor(@"C11");
    self.shopNameLabel.backgroundColor = LZMColor(@"C11");
    self.salesLabel.backgroundColor = LZMColor(@"C11");
    [self.collectionView reloadData];
}

- (void)creatShopView {
    [self addSubview:self.shopView];
    [self.shopView mas_makeConstraints:^(MASConstraintMaker *make) {
        make.left.top.right.mas_equalTo(0);
        make.height.mas_equalTo(72);
    }];
    [self.shopView addSubview:self.shopImageView];
    [self.shopView addSubview:self.shopNameLabel];
    [self.shopView addSubview:self.salesLabel];
    [self.shopView addSubview:self.distributionLabel];
    [self.shopView addSubview:self.minPriceLabel];
    [self.shopImageView mas_makeConstraints:^(MASConstraintMaker *make) {
        make.top.left.mas_equalTo(12);
        make.width.height.mas_equalTo(60);
    }];
    [self.shopNameLabel mas_makeConstraints:^(MASConstraintMaker *make) {
        make.left.mas_equalTo(self.shopImageView.mas_right).offset(8);
        make.top.mas_equalTo(11);
        make.right.mas_lessThanOrEqualTo(-33);
        make.height.mas_greaterThanOrEqualTo(22);
    }];
    _moreImgView = [UIImageView new];
    _moreImgView.image = LZMImage(@"lzm_food_more");
    [self.shopView addSubview:_moreImgView];
    [_moreImgView mas_makeConstraints:^(MASConstraintMaker *make) {
        make.width.height.mas_equalTo(8);
        make.centerY.mas_equalTo(self.shopNameLabel.mas_centerY);
        make.left.mas_equalTo(self.shopNameLabel.mas_right).offset(4);
    }];
    [self.salesLabel mas_makeConstraints:^(MASConstraintMaker *make) {
        make.left.mas_equalTo(self.shopImageView.mas_right).offset(8);
        make.top.mas_equalTo(self.shopNameLabel.mas_bottom).offset(3);
    }];
    [self.distributionLabel mas_makeConstraints:^(MASConstraintMaker *make) {
        make.left.mas_equalTo(self.salesLabel.mas_right).offset(8);
        make.centerY.mas_equalTo(self.salesLabel.mas_centerY);
    }];
    [self.minPriceLabel mas_makeConstraints:^(MASConstraintMaker *make) {
         make.left.mas_equalTo(self.distributionLabel.mas_right).offset(8);
         make.centerY.mas_equalTo(self.distributionLabel.mas_centerY);
     }];
    [self.shopView addSubview:self.defaultLabel];
    [self.defaultLabel mas_makeConstraints:^(MASConstraintMaker *make) {
        make.top.mas_equalTo(self.salesLabel.mas_bottom).offset(3);
        make.left.mas_equalTo(self.shopImageView.mas_right).offset(8);
    }];
}

- (void)createDiscountView:(NSArray <ShopCouponModel *> *)arr {
    UIView *tmpView = self.shopImageView;
    [self.couponArr makeObjectsPerformSelector:@selector(removeFromSuperview)];
    [self.couponArr removeAllObjects];
    for (NSInteger i = 0; i<(arr.count<4?arr.count:4); i++) {
        UILabel *discountLabel = [UILabel labelWithFont:LZMFont10 textColor:@"C117"];
        discountLabel.textAlignment = NSTextAlignmentCenter;
        [discountLabel setLayerCornerRadius:2 borderWidth:0.5 borderColor:LZMColor(@"C118")];
        [self.shopView addSubview:discountLabel];
        [discountLabel mas_makeConstraints:^(MASConstraintMaker *make) {
            if (i==0) {
                make.left.mas_equalTo(tmpView.mas_right).offset(8);
                make.top.mas_equalTo(self.salesLabel.mas_bottom).offset(5);
            }else {
                make.left.mas_equalTo(tmpView.mas_right).offset(6);
                make.centerY.mas_equalTo(tmpView.mas_centerY);
            }
        }];
        discountLabel.text = [NSString stringWithFormat:@"%@  ", arr[i].couponBriefDesc];
        [self.couponArr addObject:discountLabel];
        tmpView = discountLabel;
    }
}


#pragma mark -CollectionViewDelegate&&UICollectionViewDataSource

- (NSInteger)collectionView:(UICollectionView *)collectionView numberOfItemsInSection:(NSInteger)section {
    if (self.foodViewType == LZMFoodViewTypeRecommend) {
        return self.fineFoodTemporaryGroupModel?self.fineFoodTemporaryGroupModel.fineFoodGoods.count:3;
    } else
        return self.shopModel?self.shopModel.goodsList.count:4;
}


- (__kindof UICollectionViewCell *)collectionView:(UICollectionView *)collectionView cellForItemAtIndexPath:(NSIndexPath *)indexPath {
    LZMFoodCollectionViewCell *cell = [collectionView dequeueReusableCellWithReuseIdentifier:kLZMFoodCollectionViewCell forIndexPath:indexPath];
    if (self.foodViewType == LZMFoodViewTypeRecommend) {
        cell.fineFoodGoodsModel = self.fineFoodTemporaryGroupModel?self.fineFoodTemporaryGroupModel.fineFoodGoods[indexPath.row]:nil;
    } else {
        cell.goodsModel = self.shopModel?self.shopModel.goodsList[indexPath.row]:nil;
        cell.backgroundColor = LZMColor(@"C9");
        [cell hg_setAllCornerWithCornerRadius:4];
    }
    return cell;
}

- (void)collectionView:(UICollectionView *)collectionView didSelectItemAtIndexPath:(NSIndexPath *)indexPath {
    LZMFoodCollectionViewCell *cell = [collectionView cellForItemAtIndexPath:indexPath];
    NSInteger shopId = NSNotFound, groupId = NSNotFound, goodId = NSNotFound;
    if (self.foodViewType == LZMFoodViewTypeRecommend) {
        if (!self.fineFoodTemporaryGroupModel) return;
        FineFoodGoodsModel *model = self.fineFoodTemporaryGroupModel.fineFoodGoods[indexPath.row];
        shopId = model.shopId;
        groupId = model.groupId;
        goodId = model.goodsId;
    } else {
        if (!self.shopModel) return;
        LZMProduct *model = self.shopModel.goodsList[indexPath.row];
        shopId = self.shopModel.shopId.integerValue;
        groupId = model.groupId.integerValue;
        goodId = model.goodsId.integerValue;
    }
    if(shopId == NSNotFound || groupId == NSNotFound || goodId == NSNotFound) {
        LZMLogWarn(@"找不到对应id: shopID:%lu, groupId:%lu, goodId:%lu", shopId, groupId, goodId);
        return;
    }
    LZMFoodStoreDetailController *vc = [LZMFoodStoreDetailController new];
    vc.shopId = shopId;
    [vc scrollToGroupId:groupId goodId:goodId];
    [NSObject.getCurrentVC.navigationController pushViewController:vc animated:YES];
}

- (CGSize)collectionView:(UICollectionView *)collectionView layout:(UICollectionViewLayout *)collectionViewLayout referenceSizeForFooterInSection:(NSInteger)section{
    return CGSizeMake(12, 125);//:CGSizeMake(28, 125);
}
- (UICollectionReusableView *)collectionView:(UICollectionView *)collectionView viewForSupplementaryElementOfKind:(NSString *)kind atIndexPath:(NSIndexPath *)indexPath{
    UICollectionReusableView *reuseView = [collectionView dequeueReusableSupplementaryViewOfKind:UICollectionElementKindSectionFooter withReuseIdentifier:@"Footer" forIndexPath:indexPath];
    reuseView.backgroundColor = LZMColor(@"C11");
    return reuseView;
}

#pragma mark - getter

- (UIView *)shopView {
    if (!_shopView) {
        _shopView = [UIView new];
        _shopView.backgroundColor = [UIColor whiteColor];
        [_shopView bk_whenTapped:^{
            if(self.shopModel) {
                LZMFoodStoreDetailController *vc = [LZMFoodStoreDetailController new];
                vc.shopId = self.shopModel.shopId.integerValue;
                [NSObject.getCurrentVC.navigationController pushViewController:vc animated:YES];
            }
        }];
    }
    return _shopView;
}

- (UIImageView *)shopImageView {
    if (!_shopImageView) {
        _shopImageView = [UIImageView new];
        [_shopImageView hg_setAllCornerWithCornerRadius:4];
    }
    return _shopImageView;
}

- (UILabel *)shopNameLabel {
    if (!_shopNameLabel) {
        _shopNameLabel = [UILabel labelWithFont:LZMFontMedium16 textColor:@"C116"];
        //_shopNameLabel.text = @"鱼你在一起";
    }
    return _shopNameLabel;
}

- (UILabel *)salesLabel {
    if (!_salesLabel) {
        _salesLabel = [UILabel new];
        _salesLabel.font = LZMFont(LZMSize(@"T12"), LZMFontName(@"F1"));
        _salesLabel.textColor = LZMColor(@"C6");
        _salesLabel.text = @"月售3259";
    }
    return _salesLabel;
}

- (UILabel *)defaultLabel {
    if (!_defaultLabel) {
        _defaultLabel = [UILabel new];
        _defaultLabel.font = LZMFont(LZMSize(@"T12"), LZMFontName(@"F1"));
        _defaultLabel.backgroundColor = LZMColor(@"C127");
        _defaultLabel.hidden = YES;
    }
    return _defaultLabel;
}

- (UILabel *)distributionLabel {
    if (!_distributionLabel) {
        _distributionLabel = [UILabel new];
        _distributionLabel.font = LZMFont(LZMSize(@"T12"), LZMFontName(@"F1"));
        _distributionLabel.textColor = LZMColor(@"C6");
     //   _distributionLabel.text = @"免配送费";
    }
    return _distributionLabel;
}

- (UILabel *)minPriceLabel {
    if (!_minPriceLabel) {
        _minPriceLabel = [UILabel new];
        _minPriceLabel.font = LZMFont(LZMSize(@"T12"), LZMFontName(@"F1"));
        _minPriceLabel.textColor = LZMColor(@"C6");
      //  _minPriceLabel.text = @"起送￥20";
    }
    return _minPriceLabel;
}


- (UICollectionView *)collectionView{
    if (!_collectionView) {
        UICollectionViewFlowLayout *layout = [UICollectionViewFlowLayout new];
        layout.minimumInteritemSpacing = 0.f;
        layout.minimumLineSpacing = self.foodViewType==LZMFoodViewTypeRecommend?10.f:6.f;
        layout.scrollDirection = UICollectionViewScrollDirectionHorizontal;
        layout.sectionInset = self.foodViewType==LZMFoodViewTypeRecommend?UIEdgeInsetsMake(12, 12, 6, 2):UIEdgeInsetsMake(12, 12, 12, 0);
        CGFloat cellWidth = (LZMDevWidth - 68)/3;
        CGFloat cellHeight = 125;
        layout.itemSize = CGSizeMake(cellWidth, cellHeight);
        _collectionView = [[UICollectionView alloc] initWithFrame:CGRectZero collectionViewLayout:layout];
        _collectionView.backgroundColor = LZMColor(@"C11");
        _collectionView.delegate = self;
        _collectionView.dataSource = self;
        _collectionView.showsVerticalScrollIndicator = NO;
        _collectionView.showsHorizontalScrollIndicator = NO;
        [_collectionView registerClass:LZMFoodCollectionViewCell.class forCellWithReuseIdentifier:kLZMFoodCollectionViewCell];
        [_collectionView registerClass:[UICollectionReusableView class] forSupplementaryViewOfKind:UICollectionElementKindSectionFooter withReuseIdentifier:@"Footer"];
    }
    return _collectionView;
}

- (UILabel *)titleLable {
    if (!_titleLable) {
       _titleLable = [UILabel labelWithFont:LZMFontMedium18 textColorCNum:customColorNumC4 text:@"今日推荐"];
    }
    return _titleLable;
}

@end

//
//  LZMFoodCollectionViewCell.m
//  LZM_SmartEdifice
//
//  Created by zzstc on 2020/9/1.
//  Copyright © 2020 SZ_LZM. All rights reserved.
//

#import "LZMFoodCollectionViewCell.h"
#import "UIView+HGCorner.h"
#import "LZMFoodGroupModel.h"
#import "LZMProduct.h"
@interface LZMFoodCollectionViewCell ()

@property (nonatomic, strong) UIImageView * coverImgView ; /**< 食物图片 **/
@property (nonatomic, strong) UILabel * nameLabel ; /**< 名称 **/
@property (nonatomic, strong) UILabel * priceLabel ; /**< 价格 **/
@property (nonatomic, strong) UILabel * discountLabel ; /**< 折扣价格 **/
@end

@implementation LZMFoodCollectionViewCell

- (instancetype)initWithFrame:(CGRect)frame {
    self = [super initWithFrame:frame];
    if (self) {
        self.backgroundColor = [UIColor whiteColor];
        [self createSubView];
    }
    return self;
}

- (void)createSubView {
    [self.contentView addSubview:self.coverImgView];
    [self.contentView addSubview:self.nameLabel];
    [self.contentView addSubview:self.discountLabel];
    [self.contentView addSubview:self.priceLabel];
    [self.coverImgView mas_makeConstraints:^(MASConstraintMaker *make) {
        make.top.left.right.mas_equalTo(0);
        make.height.mas_equalTo(77);
    }];
    [self.nameLabel mas_makeConstraints:^(MASConstraintMaker *make) {
        make.top.mas_equalTo(self.coverImgView.mas_bottom).offset(5);
        make.left.mas_equalTo(6);
        make.right.mas_equalTo(-12);
        make.height.mas_greaterThanOrEqualTo(17);
    }];
    [self.discountLabel mas_makeConstraints:^(MASConstraintMaker *make) {
        make.top.mas_equalTo(self.nameLabel.mas_bottom).offset(2);
        make.left.mas_equalTo(6);
    }];
    [self.priceLabel mas_makeConstraints:^(MASConstraintMaker *make) {
        make.left.mas_equalTo(self.discountLabel.mas_right).offset(4);
        make.baseline.mas_equalTo(self.discountLabel);
    }];
 
}

#pragma mark - getter && setter

- (void)setFineFoodGoodsModel:(FineFoodGoodsModel *)fineFoodGoodsModel {
    _fineFoodGoodsModel = fineFoodGoodsModel;
    if (_fineFoodGoodsModel) {
        self.nameLabel.text = _fineFoodGoodsModel.goodsName?:@"";
        [self.coverImgView sd_setImageWithURL:[NSURL URLWithString:_fineFoodGoodsModel.coverImg]];
        self.priceLabel.attributedText = [[NSString stringWithFormat:@"%0.2f",_fineFoodGoodsModel.salePrice/100.f] oldPriceAttributeString];
        self.discountLabel.attributedText =  [self priceAttributeStringWithPrice:[NSString stringWithFormat:@"%0.2f",_fineFoodGoodsModel.discountPrice/100.f]];
        self.coverImgView.backgroundColor = LZMColor(@"C11");
        self.nameLabel.backgroundColor = LZMColor(@"C11");
        self.priceLabel.backgroundColor = LZMColor(@"C11");
        self.discountLabel.backgroundColor = LZMColor(@"C11");
    } else {
        self.coverImgView.backgroundColor = LZMColor(@"C127");
        [self.coverImgView sd_setImageWithURL:nil];
        self.nameLabel.text = @"";
        self.priceLabel.attributedText = [NSMutableAttributedString new];
        self.discountLabel.attributedText = [NSMutableAttributedString new];
        self.priceLabel.text = @"      ";
        self.discountLabel.text = @"     ";
        self.nameLabel.backgroundColor = LZMColor(@"C127");
        self.priceLabel.backgroundColor = LZMColor(@"C127");
        self.discountLabel.backgroundColor = LZMColor(@"C127");
    }
    
}

- (NSMutableAttributedString *)priceAttributeStringWithPrice:(NSString *)price {
 
    NSNumberFormatter *formater = [[NSNumberFormatter alloc] init];
     formater.minimumIntegerDigits = 1;
     formater.minimumFractionDigits = 2;
     formater.maximumFractionDigits = 2;
     NSString *showText = [formater stringFromNumber:@(price.doubleValue)];
     if([showText containsString:@".00"]) {
         showText = [showText stringByReplacingOccurrencesOfString:@".00" withString:@""];
     } else {
         if ([[showText substringFromIndex:showText.length-1] isEqualToString:@"0"]) {
             showText = [showText stringByReplacingCharactersInRange:NSMakeRange(showText.length-1, 1) withString:@""];
         }
     }
     NSArray <NSString *>*strArr = [showText componentsSeparatedByString:@"."];
     showText = [NSString stringWithFormat:@"¥%@", showText];
     NSMutableAttributedString *attr = [[NSMutableAttributedString alloc] initWithString:showText];
     [attr setAttributes:@{NSForegroundColorAttributeName : LZMColor(@"C128"),
                           NSFontAttributeName: [UIFont fontWithName:@"ITCAvantGardeStd-DemiCn" size: 12]
     } range:NSMakeRange(0, strArr.firstObject.length+1)];
     if (strArr.count == 2) {
         [attr setAttributes:@{NSForegroundColorAttributeName : LZMColor(@"C128"),
                                NSFontAttributeName: [UIFont fontWithName:@"ITCAvantGardeStd-DemiCn" size: 10]
          } range:NSMakeRange(1+strArr.firstObject.length, strArr.lastObject.length+1)];
     }
    return attr;
}

- (void)setGoodsModel:(LZMProduct *)goodsModel {
    _goodsModel = goodsModel;
    if (!goodsModel) {
        self.coverImgView.backgroundColor = LZMColor(@"C127");
        [self.coverImgView sd_setImageWithURL:nil];
        return;
    }
    self.nameLabel.text = _goodsModel.goodsName?:@"";
    [self.coverImgView sd_setImageWithURL:[NSURL URLWithString:_goodsModel.coverImg]];
    self.priceLabel.attributedText = [[NSString stringWithFormat:@"%0.2f",_goodsModel.salePrice/100.f] oldPriceAttributeString];
    NSString *showText = [NSString stringWithFormat:@"%0.2f",_goodsModel.discountPrice/100.f];
    if([showText containsString:@".00"]) {
        showText = [showText stringByReplacingOccurrencesOfString:@".00" withString:@""];
    } else {
        if ([[showText substringFromIndex:showText.length-1] isEqualToString:@"0"]) {
            showText = [showText stringByReplacingCharactersInRange:NSMakeRange(showText.length-1, 1) withString:@""];
        }
    }
    self.discountLabel.attributedText =  [self priceAttributeStringWithPrice:[NSString stringWithFormat:@"%0.2f",_goodsModel.discountPrice/100.f]];
}

- (UIImageView *)coverImgView {
    if (!_coverImgView) {
        _coverImgView = [UIImageView new];
        _coverImgView.backgroundColor = [UIColor grayColor];
        [_coverImgView hg_setAllCornerWithCornerRadius:4];
    }
    return _coverImgView;
}

- (UILabel *)nameLabel {
    if (!_nameLabel) {
        _nameLabel = [UILabel labelWithFont:LZMFontMedium12 textColor:@"C119"];
        _nameLabel.text = @" ";
    }
    return _nameLabel;
}

- (UILabel *)priceLabel {
    if (!_priceLabel) {
        _priceLabel = [UILabel labelWithFont:LZMFontMedium10 textColor:@"C3"];
       // _priceLabel.attributedText = [@"￥30.8" oldPriceAttributeString];
    }
    return _priceLabel;
}

- (UILabel *)discountLabel {
    if (!_discountLabel) {
        _discountLabel = [UILabel labelWithFont:LZMFontMedium12 textColor:@"C3"];
    }
    return _discountLabel;
}


@end

//
//  LZMGoodShopCell.m
//  LZM_SmartEdifice
//
//  Created by zzstc on 2020/9/1.
//  Copyright © 2020 SZ_LZM. All rights reserved.
//

#import "LZMGoodShopCell.h"
#import "LZMFoodView.h"
#import "UIView+HGCorner.h"
@interface LZMGoodShopCell ()
@property (nonatomic, strong)LZMFoodView *foodView;
@end

@implementation LZMGoodShopCell

- (instancetype)initWithStyle:(UITableViewCellStyle)style reuseIdentifier:(NSString *)reuseIdentifier {
    self = [super initWithStyle:style reuseIdentifier:reuseIdentifier];
    if (self) {
        [self.contentView addSubview:self.foodView];
        [self.foodView mas_makeConstraints:^(MASConstraintMaker *make) {
            make.left.top.mas_equalTo(12);
            make.right.mas_equalTo(-12);
            make.bottom.mas_equalTo(0);
        }];
        self.backgroundColor = LZMColor(@"C9");
        self.selectionStyle = UITableViewCellSelectionStyleNone;
    }
    return self;
}

- (void)setShopModel:(LZMShopModel *)shopModel {
    _shopModel = shopModel;
    self.foodView.shopModel = _shopModel;
}

- (LZMFoodView *)foodView {
    if (!_foodView) {
        _foodView = [[LZMFoodView alloc]initWithFrame:self.bounds foodType:LZMFoodViewTypeGoodShop];
        [_foodView hg_setAllCornerWithCornerRadius:12];
    }
    return _foodView;
}

@end

//
//  LZMFoodRecommendCollectionViewCell.m
//  LZM_SmartEdifice
//
//  Created by zzstc on 2020/9/2.
//  Copyright © 2020 SZ_LZM. All rights reserved.
//

#import "LZMFoodRecommendCollectionViewCell.h"
#import "UIView+HGCorner.h"
#import "LZMProduct.h"
@interface LZMFoodRecommendCollectionViewCell ()

@property (nonatomic, strong)UIImageView *foodImgView;
@property (nonatomic, strong)UILabel *foodNameLabel;
@property (nonatomic, strong)UILabel *soldLabel;
@property (nonatomic, strong)UILabel *distributionLabel;
@property (nonatomic, strong)UILabel *priceLabel;
@property (nonatomic, strong)UILabel *discountLabel;
@property (nonatomic, strong)UIImageView *shopImgView;
@property (nonatomic, strong)UILabel *shopNameLabel;
@property (nonatomic, strong)UILabel *minPriceLabel;
@property (nonatomic, strong)UIView *lineView;
@end

@implementation LZMFoodRecommendCollectionViewCell

- (instancetype)initWithFrame:(CGRect)frame {
    self = [super initWithFrame:frame];
    if (self) {
        self.backgroundColor = [UIColor whiteColor];
        [self hg_setAllCornerWithCornerRadius:12];
        [self createSubView];
    }
    return self;
}

//- (UICollectionViewLayoutAttributes*)preferredLayoutAttributesFittingAttributes:(UICollectionViewLayoutAttributes*)layoutAttributes {
//    [self setNeedsLayout];
//    [self layoutIfNeeded];
//    CGSize size = [self.contentView systemLayoutSizeFittingSize: layoutAttributes.size];
//    CGRect cellFrame = layoutAttributes.frame;
//    cellFrame.size.height = size.height;
//    cellFrame.size.width = (LZMDevWidth - 29)/2;
//    layoutAttributes.frame= cellFrame;
//    return layoutAttributes;
//}

- (void)createSubView {
    [self.contentView addSubview:self.foodImgView];
    [self.contentView addSubview:self.foodNameLabel];
    [self.contentView addSubview:self.soldLabel];
    [self.contentView addSubview:self.distributionLabel];
    [self.contentView addSubview:self.priceLabel];
    [self.contentView addSubview:self.discountLabel];
    [self.contentView addSubview:self.shopImgView];
    [self.contentView addSubview:self.shopNameLabel];
    [self.contentView addSubview:self.minPriceLabel];
    [self.contentView addSubview:self.lineView];
    [self.foodImgView mas_makeConstraints:^(MASConstraintMaker *make) {
        make.top.left.right.mas_equalTo(0);
        make.height.mas_equalTo(132);
    }];
    [self.foodNameLabel mas_makeConstraints:^(MASConstraintMaker *make) {
        make.top.mas_equalTo(self.foodImgView.mas_bottom).offset(12);
        make.left.mas_equalTo(8);
        make.right.mas_equalTo(-8);
    }];
    [self.soldLabel mas_makeConstraints:^(MASConstraintMaker *make) {
        make.top.mas_equalTo(self.foodNameLabel.mas_bottom).offset(4);
        make.left.mas_equalTo(8);
    }];
    [self.distributionLabel mas_makeConstraints:^(MASConstraintMaker *make) {
        make.left.mas_equalTo(self.soldLabel.mas_right).offset(8);
        make.centerY.mas_equalTo(self.soldLabel.mas_centerY);
    }];
    [self.discountLabel mas_makeConstraints:^(MASConstraintMaker *make) {
        make.top.mas_equalTo(self.soldLabel.mas_bottom).offset(4);
        make.left.mas_equalTo(8);
    }];
    [self.priceLabel mas_makeConstraints:^(MASConstraintMaker *make) {
        make.baseline.mas_equalTo(self.discountLabel);
        make.left.mas_equalTo(self.discountLabel.mas_right).offset(4);
    }];
    [self.lineView mas_makeConstraints:^(MASConstraintMaker *make) {
        make.top.mas_equalTo(self.discountLabel.mas_bottom).offset(8);
        make.left.mas_equalTo(8);
        make.right.mas_equalTo(-8);
        make.height.mas_equalTo(1);
    }];
    [self.shopImgView mas_makeConstraints:^(MASConstraintMaker *make) {
        make.top.mas_equalTo(self.lineView.mas_bottom).offset(8);
        make.left.mas_equalTo(8);
        make.height.width.mas_equalTo(28*LZMWIDTH_SCALE);
        make.bottom.mas_equalTo(-10);
    }];
    [self.shopNameLabel mas_makeConstraints:^(MASConstraintMaker *make) {
        make.top.mas_equalTo(self.lineView.mas_bottom).offset(7);
        make.left.mas_equalTo(self.shopImgView.mas_right).offset(5);
    }];
    [self.minPriceLabel mas_makeConstraints:^(MASConstraintMaker *make) {
        make.left.mas_equalTo(self.shopImgView.mas_right).offset(5);
        make.top.mas_equalTo(self.shopNameLabel.mas_bottom).offset(1);
    }];
}

- (void)setProductModel:(LZMProduct *)productModel {
    _productModel = productModel;
    [self.foodImgView sd_setImageWithURL:[NSURL URLWithString:_productModel.coverImg]];
    self.foodNameLabel.text = _productModel.goodsName;
    self.soldLabel.text = [NSString stringWithFormat:@"已售%ld",_productModel.sales];
    self.distributionLabel.text = _productModel.deliveryFee == 0?@"免配送费":[NSString stringWithFormat:@"配送￥%0.2f",_productModel.deliveryFee/100.f];
    self.priceLabel.attributedText = [[NSString stringWithFormat:@"%0.2f",_productModel.salePrice/100.f] oldPriceAttributeString];
    self.discountLabel.text = [NSString stringWithFormat:@"￥%.2f",_productModel.discountPrice/100.f];
    [self.shopImgView sd_setImageWithURL:[NSURL URLWithString:_productModel.logoImg]];
    self.shopNameLabel.text = _productModel.shopName;
    self.minPriceLabel.text = [NSString stringWithFormat:@"起送￥%0.2f",_productModel.startExpressAmount/100.f];
}

- (UIImageView *)foodImgView {
    if (!_foodImgView) {
        _foodImgView = [UIImageView new];
        _foodImgView.backgroundColor = [UIColor grayColor];
        [_foodImgView hg_setCornerOnTopWithRadius:12];
    }
    return _foodImgView;
}

- (UILabel *)foodNameLabel {
    if (!_foodNameLabel) {
        _foodNameLabel = [UILabel labelWithFont:LZMFontMedium16 textColor:@"C115"];
        _foodNameLabel.numberOfLines = 2;
        _foodNameLabel.text = @"盐焗鸡+港式烧鸭饭经典套餐-送汤";
    }
    return _foodNameLabel;
}

- (UILabel *)soldLabel {
    if (!_soldLabel) {
        _soldLabel = [UILabel new];
        _soldLabel.font = LZMFont(LZMSize(@"T12"), LZMFontName(@"F1"));
        _soldLabel.textColor = LZMColor(@"C6");
        _soldLabel.text = @"已售290";
    }
    return _soldLabel;
}

- (UILabel *)distributionLabel {
    if (!_distributionLabel) {
        _distributionLabel = [UILabel new];
        _distributionLabel.font = LZMFont(LZMSize(@"T12"), LZMFontName(@"F1"));
        _distributionLabel.textColor = LZMColor(@"C6");
        _distributionLabel.text = @"配送￥3";
    }
    return _distributionLabel;
}

- (UILabel *)priceLabel {
    if (!_priceLabel) {
        _priceLabel = [UILabel new];
        _priceLabel.attributedText = [@"￥30.8" oldPriceAttributeString];
    }
    return _priceLabel;
}

- (UILabel *)discountLabel {
    if (!_discountLabel) {
        _discountLabel = [UILabel new];
        _discountLabel.font = [UIFont fontWithName:@"ITCAvantGardeStd-DemiCn" size:16];
        _discountLabel.textColor = LZMColor(@"C128");
    }
    return _discountLabel;
}

- (UIImageView *)shopImgView {
    if (!_shopImgView) {
        _shopImgView = [UIImageView new];
        [_shopImgView hg_setAllCornerWithCornerRadius:4];
    }
    return _shopImgView;
}

- (UILabel *)shopNameLabel {
    if (!_shopNameLabel) {
        _shopNameLabel = [UILabel labelWithFont:LZMFont10 textColor:@"C4"];
        _shopNameLabel.text = @"鱼你在一起";
    }
    return _shopNameLabel;
}

- (UILabel *)minPriceLabel {
    if (!_minPriceLabel) {
        _minPriceLabel = [UILabel labelWithFont:LZMFont10 textColor:@"C6"];
        _minPriceLabel.text = @"起送￥20";
    }
    return _minPriceLabel;
}

- (UIView *)lineView {
    if (!_lineView) {
        _lineView = [UIView new];
        _lineView.backgroundColor = LZMColor(@"C8");
    }
    return _lineView;
}

@end

//
//  LZMHomeStorage.m
//  LZM_SmartEdifice
//
//  Created by Quanhai on 2019/3/16.
//  Copyright © 2019 SZ_LZM. All rights reserved.
//

#import "LZMHomeStorage.h"
#import "LZMCacheManager.h"

NSString *const kHomeCacheFile = @"home/homeCache.db";
NSString *const kHomeCacheBaseKey = @"homeCacheKey";

@interface LZMHomeStorage()

@property (nonatomic, strong) LZMCacheManager * homeCahe ; /**<  **/

@end

@implementation LZMHomeStorage

- (instancetype)initWithUserId:(nonnull NSString *)userId{
    if (self = [super init]) {
        self.userId = userId;
    }
    return self;
}

- (void)setUserId:(NSString *)userId{
    _userId = userId;
    NSString *qrCacheName = [NSString stringWithFormat:@"%@/%@", _userId, kHomeCacheFile];
    self.homeCahe = [[LZMCacheManager alloc] initWithCacheName:qrCacheName cacheSize:LZMCacheSizeNormal];
}

#pragma mark - cache
- (void)saveHomelayoutArry:(NSArray *)layoutArry {
    NSString *key = [NSString stringWithFormat:@"%@_layoutArry", kHomeCacheBaseKey];
    [self.homeCahe saveObject:layoutArry forKey:key];
}
- (NSArray *)getLayoutArry {
    NSString *key = [NSString stringWithFormat:@"%@_layoutArry", kHomeCacheBaseKey];
    return [self.homeCahe getObjectForKey:key];
}

- (void)saveHomeMenusDataArry:(NSArray *)menusDataArry {
    NSString *key = [NSString stringWithFormat:@"%@_menusDataArry", kHomeCacheBaseKey];
    [self.homeCahe saveObject:menusDataArry forKey:key];
}
- (NSArray *)getMenusDataArry {
    NSString *key = [NSString stringWithFormat:@"%@_menusDataArry", kHomeCacheBaseKey];
    return [self.homeCahe getObjectForKey:key];
}

- (void)saveHomeToolGroup:(NSArray<HomePageItem *> *)toolGroup {
    NSString *key = [NSString stringWithFormat:@"%@_toolGroup", kHomeCacheBaseKey];
    [self.homeCahe saveObject:toolGroup forKey:key];
}
- (NSArray<HomePageItem *> *)getToolGroup {
    NSString *key = [NSString stringWithFormat:@"%@_toolGroup", kHomeCacheBaseKey];
    return [self.homeCahe getObjectForKey:key];
}


- (void)saveHomePartitionGroup:(NSArray<HomePageEntrance *> *)partitionGroup {
    NSString *key = [NSString stringWithFormat:@"%@_partitionGroup", kHomeCacheBaseKey];
    [self.homeCahe saveObject:partitionGroup forKey:key];
}
- (NSArray<HomePageEntrance *> *)getPartitionGroup {
    NSString *key = [NSString stringWithFormat:@"%@_partitionGroup", kHomeCacheBaseKey];
    return [self.homeCahe getObjectForKey:key];
}

- (void)saveHomeBanners:(NSArray <LZMBanner *> *)banners{
    NSString *key = [NSString stringWithFormat:@"%@_banner", kHomeCacheBaseKey];
    [self.homeCahe saveObject:banners forKey:key];
}
- (NSArray <LZMBanner *> *)getHomeBanners{
    NSString *key = [NSString stringWithFormat:@"%@_banner", kHomeCacheBaseKey];
    return [self.homeCahe getObjectForKey:key];
}

- (void)saveHomeGroups:(NSArray <LZMProductGroup *> *)groups{
    NSString *key = [NSString stringWithFormat:@"%@_group", kHomeCacheBaseKey];
    [self.homeCahe saveObject:groups forKey:key];
}
- (NSArray <LZMProductGroup *> *)getHomeGroups{
    NSString *key = [NSString stringWithFormat:@"%@_group", kHomeCacheBaseKey];
    return [self.homeCahe getObjectForKey:key];
}

- (void)saveHomeNotifi:(NSArray <NSString *> *)notifi{
    NSString *key = [NSString stringWithFormat:@"%@_notifi", kHomeCacheBaseKey];
    [self.homeCahe saveObject:notifi forKey:key];
}
- (NSArray <NSString *> *)getHomeNotifi{
    NSString *key = [NSString stringWithFormat:@"%@_notifi", kHomeCacheBaseKey];
    return [self.homeCahe getObjectForKey:key];
}


- (void)saveHomeUnions:(NSArray <LZMHomePageUnion *> *)unions{
    NSString *key = [NSString stringWithFormat:@"%@_unions", kHomeCacheBaseKey];
    [self.homeCahe saveObject:unions forKey:key];
}
- (NSArray <LZMHomePageUnion *> *)getHomeUnions{
    NSString *key = [NSString stringWithFormat:@"%@_unions", kHomeCacheBaseKey];
    return [self.homeCahe getObjectForKey:key];
}


- (void)saveHomeNews:(NSArray <LZMNews *> *)lzmNews{
    NSString *key = [NSString stringWithFormat:@"%@_news", kHomeCacheBaseKey];
    [self.homeCahe saveObject:lzmNews forKey:key];
}
- (NSArray <LZMNews *> *)getHomeNews{
    NSString *key = [NSString stringWithFormat:@"%@_news", kHomeCacheBaseKey];
    return [self.homeCahe getObjectForKey:key];
}

- (void)saveHomeActivities:(NSArray <LZMFoundOrTherrModel *> *)activities{
    NSString *key = [NSString stringWithFormat:@"%@_homeactivity", kHomeCacheBaseKey];
    [self.homeCahe saveObject:activities forKey:key];
}
- (NSArray <LZMFoundOrTherrModel *> *)getHomeActivites{
    NSString *key = [NSString stringWithFormat:@"%@_homeactivity", kHomeCacheBaseKey];
    return [self.homeCahe getObjectForKey:key];
}

@end

//
//  LZMNewService.m
//  LZM_SmartEdifice
//
//  Created by zzstc on 2019/12/30.
//  Copyright © 2019 SZ_LZM. All rights reserved.
//

#import "LZMNewService.h"
#import "TTKFileManager.h"

#define kHaveStr @"YES"

@implementation LZMNewService

+ (BOOL)checkHave:(NSString *)str
{
    if ([str isEqualToString:kHaveStr]) {
        return true;
    }
    
    return false;
}

+ (BOOL)getHaveWithKey:(NSString *)key
{
    return [self checkHave:[TTKFileManager getObjectWithFileName:key]];
}

/// 首页物业
+ (BOOL)getHomeTenementNew {
    return [self getHaveWithKey:kMainTenementNew];
}

/// 首页物业
+ (void)saveHomeTenementNewState {
    [TTKFileManager saveObject:kHaveStr fileName:kMainTenementNew];
}

/// 物业租赁
+ (BOOL)getTenementRentNew
{
    return [self getHaveWithKey:kTenementRentNew];
}

/// 物业租赁
+ (void)saveTenementRentNewState
{
    [TTKFileManager saveObject:kHaveStr fileName:kTenementRentNew];
}

/// 物品放行
+ (BOOL)getGoodsReleaseNew
{
    return [self getHaveWithKey:kGoodsReleaseNew];
}

/// 物品放行
+ (void)saveGoodsReleaseNewState
{
    [TTKFileManager saveObject:kHaveStr fileName:kGoodsReleaseNew];
}

@end

//
//  LZMHomePageService.m
//  LZM_SmartEdifice
//
//  Created by Quanhai on 2019/2/25.
//  Copyright © 2019 SZ_LZM. All rights reserved.
//

#import "LZMHomePageService.h"

@implementation LZMHomePageService

+ (void)getHomeMenusDataSuccess:(ReqSuccess)success failureHandle:(ReqFailed)failureBlock {
    NSString *requestUrl = [NSString stringWithFormat:@"%@%@", KReqHomeMenus,@"10"];
    [LZMNetworking GET:requestUrl parameters:@{@"isIgnoreNetErrorToast":@true} success:success failed:failureBlock];
}

+ (void)getHomePageBannerSuccess:(ReqSuccess)success failureHandle:(ReqFailed)failureBlock{
    NSString *requestUrl = [NSString stringWithFormat:@"%@1", kReqBanner];
    [LZMNetworking GET:requestUrl parameters:@{@"isIgnoreNetErrorToast":@true} success:success failed:failureBlock];
}

+ (void)getHomePagePublicNotifSuccess:(ReqSuccess)success failureHandle:(ReqFailed)failureBlock{
    NSString *requestUrl = [NSString stringWithFormat:@"%@", kReqNotice];
    [LZMNetworking GET:requestUrl parameters:@{@"isIgnoreNetErrorToast":@true} success:success failed:failureBlock];
}

+ (void)getHomePageProductGroupSuccess:(ReqSuccess)success failureHandle:(ReqFailed)failureBlock{
    NSString *requestUrl = [NSString stringWithFormat:@"%@10",kReqProductGroups];
    [LZMNetworking GET:kReqProductGroups parameters:@{@"isIgnoreNetErrorToast":@true} success:success failed:failureBlock];
}

+ (void)getHomePageProductsWithGroupId:(NSString *)groupId success:(ReqSuccess)success failureHandle:(ReqFailed)failureBlock{
    NSString *requestUrl = [NSString stringWithFormat:@"%@%@/goods?pageNum=1&pageSize=3", kReqGroupProducts, groupId];
    [LZMNetworking GET:requestUrl parameters:nil success:success failed:failureBlock];
}

+ (void)getCompanyUnionSuccess:(ReqSuccess)success failureHandle:(ReqFailed)failureBlock{
    NSString *requestUrl = [NSString stringWithFormat:@"%@", kReqUnionServices];
    [LZMNetworking GET:requestUrl parameters:@{@"isIgnoreNetErrorToast":@true} success:success failed:failureBlock];
}

+ (void)getNewsSuccess:(ReqSuccess)success failureHandle:(ReqFailed)failureBlock{
    NSString *requestUrl = [NSString stringWithFormat:@"%@?fromHome=1&pageNum=%d&pageSize=%d",kReqDiscoveryList, 1, 3];
    [LZMNetworking GET:requestUrl parameters:@{@"isIgnoreNetErrorToast":@true} success:success failed:failureBlock];
}


+ (void)getAppUpgradeInfoSuccess:(ReqSuccess)success failureHandle:(ReqFailed)failureBlock{
    NSDictionary *infoDictionary = [[NSBundle mainBundle] infoDictionary];
    NSString *appVersion = [infoDictionary objectForKey:@"CFBundleShortVersionString"];
    NSString *requestUrl = [NSString stringWithFormat:@"%@?app=12&sourceVersion=%@&appearType=1", kReqAppUpgrade, appVersion];
    [LZMNetworking GET:requestUrl parameters:@{@"isIgnoreNetErrorToast":@true} success:success failed:failureBlock];
}


+ (void)getHomePagePatchRequests{
    LZMRequest *publicNotifRequest = [[LZMRequest alloc] initMethod:LZMRequestMethodGET withApi:kReqNotice params:nil];
    NSString *groupRequestUrl = [NSString stringWithFormat:@"%@10",kReqProductGroups];
    LZMRequest *groupRequest = [[LZMRequest alloc] initMethod:LZMRequestMethodGET withApi:groupRequestUrl params:nil];
    LZMRequest *unionRequest = [[LZMRequest alloc] initMethod:LZMRequestMethodGET withApi:kReqUnionServices params:nil];
    NSString *newsRequestUrl = [NSString stringWithFormat:@"%@?pageNum=%d&pageSize=%d",kReqDiscoveryList, 1, 3];
    LZMRequest *newsRequest = [[LZMRequest alloc] initMethod:LZMRequestMethodGET withApi:newsRequestUrl params:nil];
    
    [LZMNetworking sendPatchRequests:@[publicNotifRequest, groupRequest, unionRequest, newsRequest] finished:^(NSArray<LZMRequest *> * results) {
        NSLog(@"finished patch request: %@", results);
    }];
}


@end

//
//  LZMNewView.m
//  LZM_SmartEdifice
//
//  Created by zzstc on 2019/12/30.
//  Copyright © 2019 SZ_LZM. All rights reserved.
//

#import "LZMNewView.h"
#import "UIView+HGCorner.h"

@interface LZMNewView ()

@property (nonatomic, strong) UILabel *newLabel;

@property (nonatomic, strong) CAShapeLayer *bgLayer;

@end

@implementation LZMNewView

+ (instancetype)LZMNewView
{
    LZMNewView *view = [LZMNewView new];
    
    view.frame = CGRectMake(0, 0, 30, 14);
    
    return view;
}

- (instancetype)initWithFrame:(CGRect)frame
{
    self = [super initWithFrame:frame];
    if (self) {
        [self variableInit];
        [self subViewInit];
    }
    return self;
}

- (void)layoutSubviews
{
    [super layoutSubviews];
    
    [self reloadMaskLayerPath];
}

#pragma mark - 页面初始化

/**
 变量初始化
 */
- (void)variableInit
{
//    self.backgroundColor = kCustomColor(customColorNumC3);
}

/**
 页面初始化
 */
- (void)subViewInit
{
    //New
    [self addSubview:self.newLabel];
    [self.newLabel mas_makeConstraints:^(MASConstraintMaker *make) {
        make.edges.mas_equalTo(self);
    }];
}

/// 控制new视图是否展示
/// @param hidden 隐藏
/// @param view 父视图
+ (LZMNewView *)LZMNewViewHidden:(BOOL)hidden onView:(UIView *)view
{
    LZMNewView *newView;
    for (UIView *subView in view.subviews) {
        if ([subView isKindOfClass:[LZMNewView class]]) {
            subView.hidden = hidden;
            newView = subView;
        }
    }
    
    if (newView == nil) {
        newView = [LZMNewView LZMNewView];
        newView.hidden = hidden;
        [view addSubview:newView];
    }
    
    return newView;
}
#pragma mark - 视图懒加载
- (UILabel *)newLabel
{
    if (_newLabel == nil) {
        _newLabel = [UILabel labelWithFont:[UIFont boldSystemFontOfSize:9] textColorCNum:customColorNumC11];
        _newLabel.text = @"NEW";
        _newLabel.textAlignment = NSTextAlignmentCenter;
    }
    
    return _newLabel;
}

- (CAShapeLayer *)bgLayer
{
    if (_bgLayer == nil) {
        _bgLayer = [CAShapeLayer layer];
        [self.layer insertSublayer:_bgLayer atIndex:0];
        
        _bgLayer.fillColor = kCustomColor(customColorNumC3).CGColor;
        _bgLayer.strokeColor = kCustomColor(customColorNumC11).CGColor;
    }
    
    return _bgLayer;
}
#pragma mark - get / set

#pragma mark - 网络请求
#pragma mark - 代理事件
#pragma mark - 通知事件
#pragma mark - 点击事件
#pragma mark - 其他方法

/// 刷新遮罩
- (void)reloadMaskLayerPath
{
    UIBezierPath *path = [UIBezierPath bezierPathWithRoundedRect:self.bounds byRoundingCorners:(UIRectCornerTopLeft | UIRectCornerTopRight | UIRectCornerBottomRight) cornerRadii:CGSizeMake(self.height / 2, self.height / 2)];
    
    CAShapeLayer *layer = self.bgLayer;
    layer.frame = CGRectMake(0, 0, self.width, self.height);
    layer.path = path.CGPath;
}

#pragma mark - 接口

@end

//
//  LZMNotifAlertView.m
//  Louzhangmen
//
//  Created by Quanhai on 2018/6/22.
//  Copyright © 2018年 Shenzhen Zhongzheng Information Technology Co., Ltd. All rights reserved.
//

#import "LZMNotifAlertView.h"

CGFloat const kNotifMinHeight = 270.f;

@interface LZMNotifAlertView()

@property (nonatomic, strong) UIView * maskView ; /**< <# #> **/
@property (nonatomic, strong) UIView * contentView ; /**< <# #> **/
@property (nonatomic, strong) UIImageView * imageView ; /**< <# #> **/
@property (nonatomic, strong) UILabel * titleLabel ; /**< <# #> **/

@property (nonatomic, strong) UIScrollView * scrollView ; /**< <# #> **/
@property (nonatomic, strong) UILabel * notifLabel ; /**< <# #> **/
@property (nonatomic, strong) UIButton * closeBtn ; /**< LZM_notif_close **/

@property (nonatomic, assign) CGFloat leftOffset ; /**< <# #> **/
@property (nonatomic, assign) CGFloat kNotifiMaxHeight ; /**< <# #> **/

@end

@implementation LZMNotifAlertView

+ (LZMNotifAlertView *)notifAlertView{
    LZMNotifAlertView *alertView = [[LZMNotifAlertView alloc] initWithFrame:[UIScreen mainScreen].bounds];
    
    
    return alertView;
}

+ (void)showAlertViewWithNotif:(LZMAlertNotifi *)notif{
    LZMNotifAlertView *alertView = [[LZMNotifAlertView alloc] initWithFrame:[UIScreen mainScreen].bounds];
    alertView.notif = notif;
    UIWindow *currentWindow = [UIApplication sharedApplication].delegate.window;
    [currentWindow addSubview:alertView];

    [alertView animationWithView:alertView.contentView];
}

- (void)showAlertView{
    UIWindow *currentWindow = [UIApplication sharedApplication].delegate.window;
    [currentWindow addSubview:self];
    
    [self animationWithView:self.contentView];
}

// 动画
- (void)animationWithView:(UIView *)contentView {
    CABasicAnimation*pulse = [CABasicAnimation animationWithKeyPath:@"transform.scale"];
    pulse.timingFunction= [CAMediaTimingFunction functionWithName:kCAMediaTimingFunctionEaseInEaseOut];
    pulse.duration = 0.3f;
    pulse.repeatCount= 1;
//    pulse.autoreverses= YES;
    pulse.fromValue= [NSNumber numberWithFloat:0.2];
    pulse.toValue= [NSNumber numberWithFloat:1.03];
    [contentView.layer addAnimation:pulse forKey:nil];
}

- (void)alertViewDismiss{
    [self.contentView removeFromSuperview];
    [self.closeBtn removeFromSuperview];
    [self removeFromSuperview];
}

- (instancetype)initWithFrame:(CGRect)frame{
    if (self = [super initWithFrame:frame]) {
        [self setupContents];
    }
    return self;
}

- (void)setupContents{
    self.maskView = [[UIView alloc] init];
    self.maskView.backgroundColor = [UIColor colorWithWhite:0 alpha:0.5];
    UITapGestureRecognizer *tap = [[UITapGestureRecognizer alloc] initWithTarget:self action:@selector(alertViewDismiss)];
    [self.maskView addGestureRecognizer:tap];
    [self addSubview:self.maskView];
    [self.maskView mas_makeConstraints:^(MASConstraintMaker *make) {
        (void)make.edges;
    }];
    
    self.leftOffset = 48.f;
    self.kNotifiMaxHeight = LZMDevHeight/2;
    
    self.contentView = [[UIView alloc] init];
    self.contentView.backgroundColor = [UIColor whiteColor];
    self.contentView.layer.cornerRadius = 20.f;
    self.contentView.layer.masksToBounds = YES;
    [self addSubview:self.contentView];
    [self.contentView mas_makeConstraints:^(MASConstraintMaker *make) {
        make.centerX.mas_equalTo(self.mas_centerX);
        make.centerY.mas_equalTo(self.mas_centerY);
        make.left.mas_equalTo(self.mas_left).mas_offset(self.leftOffset);
    }];
    
    self.imageView = [[UIImageView alloc] init];
    self.imageView.backgroundColor = LZMColor(@"C11");
    self.imageView.contentMode = UIViewContentModeScaleAspectFill;
    self.imageView.layer.masksToBounds = YES;

    [self.contentView addSubview:self.imageView];
    [self.imageView mas_makeConstraints:^(MASConstraintMaker *make) {
        (void)make.left.top.right;
        make.height.mas_equalTo(80.f);
    }];
    /** 分割线 */
    [self.imageView setBottomBorderWithColor:LZMColor(@"C8") width:LZMDevWidth-self.leftOffset*3 height:1.f];
    
    self.titleLabel = [[UILabel alloc] init];
    self.titleLabel.numberOfLines = 2;
    self.titleLabel.textColor = LZMColor(@"C12");
    self.titleLabel.font = LZMFontMedium16;
    self.titleLabel.textAlignment = NSTextAlignmentCenter;
    [self.imageView addSubview:self.titleLabel];
    [self.titleLabel mas_makeConstraints:^(MASConstraintMaker *make) {
        make.centerY.mas_equalTo(self.imageView.mas_centerY);
        make.left.mas_equalTo(self.imageView).offset(20.f);
        make.right.mas_equalTo(self.imageView).offset(-20.f);
    }];
    
    self.scrollView = [[UIScrollView alloc] init];
    self.scrollView.backgroundColor = [UIColor whiteColor];
    self.scrollView.showsVerticalScrollIndicator = true;
    self.scrollView.showsHorizontalScrollIndicator = false;
    [self.contentView addSubview:self.scrollView];
    [self.scrollView mas_makeConstraints:^(MASConstraintMaker *make) {
        make.centerX.mas_equalTo(self.contentView.mas_centerX);
        make.left.mas_equalTo(self.contentView.mas_left).mas_offset(0.f);
        make.top.mas_equalTo(self.imageView.mas_bottom).mas_offset(0.f);
        make.bottom.mas_equalTo(self.contentView.mas_bottom);
        make.height.mas_greaterThanOrEqualTo(kNotifMinHeight);
    }];
    
    self.notifLabel = [[UILabel alloc] init];
    self.notifLabel.numberOfLines = 0;
    self.notifLabel.textColor = LZMColor(@"C4");
    self.notifLabel.font = LZMFont14;
    [self.scrollView addSubview:self.notifLabel];
    [self.notifLabel mas_makeConstraints:^(MASConstraintMaker *make) {
        make.top.mas_equalTo(self.scrollView.mas_top).mas_offset(18.f);
        (void)make.left.mas_equalTo(self.scrollView.mas_left).mas_offset(30.f-5);
        make.width.mas_equalTo(self.scrollView.mas_width).offset(-30.f*2+10);
    }];
    
    self.closeBtn = [[UIButton alloc] init];
    [self.closeBtn addTarget:self action:@selector(alertViewDismiss) forControlEvents:UIControlEventTouchUpInside];
    [self.closeBtn setImage:[UIImage imageNamed:@"ic_close_white"] forState:UIControlStateNormal];
    [self addSubview:self.closeBtn];
    [self.closeBtn mas_makeConstraints:^(MASConstraintMaker *make) {
        make.centerX.mas_equalTo(self.mas_centerX);
        make.top.mas_equalTo(self.contentView.mas_bottom).mas_offset(15.f);
        make.width.height.mas_equalTo(40.f);
    }];
}

- (void)setNotif:(LZMAlertNotifi *)notif{
    _notif = notif;
    
    self.titleLabel.text = _notif.title;
    self.notifLabel.text = _notif.content;
    CGSize textSize = [self.notifLabel sizeThatFits:CGSizeMake(LZMDevWidth -self.leftOffset*2 -30.f*2, 10)];
    CGFloat height = textSize.height;
    height = MAX(height, kNotifMinHeight);
    height = MIN(height, _kNotifiMaxHeight);
    
    [self.scrollView setContentSize:CGSizeMake(textSize.width+30.f*2, textSize.height +30.f)];
}


@end

//
//  LZMUpdateView.m
//  Louzhangmen
//
//  Created by Quanhai on 2018/9/21.
//  Copyright © 2018年 Shenzhen Zhongzheng Information Technology Co., Ltd. All rights reserved.
//

#import "LZMUpdateView.h"
#import "HZGradientButton.h"
#import "HZGradientImageView.h"
#import "NSObject+ViewController.h"
#import <StoreKit/StoreKit.h>

@interface LZMUpdateView()
<
SKStoreProductViewControllerDelegate,
UITextViewDelegate
>
@property (nonatomic, strong) UIView * maskView ; /**< <# #> **/
@property (nonatomic, strong) UIView * contentView ; /**< <# #> **/
@property (nonatomic, strong) UIImageView * imageView ; /**< lzm_notifi_head **/
@property (nonatomic, strong) UILabel * titleLabel ; /**< <# #> **/

@property (nonatomic, strong) UITextView * updateInfoLabel ; /**< <# #> **/
@property (nonatomic, strong) UIButton * closeBtn ; /**< LZM_notif_close **/
@property (nonatomic, strong) HZGradientButton * updateBtn ; /**< <# #> **/

/// 弹框底部图片
@property (nonatomic, strong) UIImageView *bottomImageview;

@end

@implementation LZMUpdateView

//
//  LZMNotifAlertView.m
//  Louzhangmen
//
//  Created by Quanhai on 2018/6/22.
//  Copyright © 2018年 Shenzhen Zhongzheng Information Technology Co., Ltd. All rights reserved.
//


+ (LZMUpdateView *)updateAlertView{
    LZMUpdateView *alertView = [[LZMUpdateView alloc] initWithFrame:[UIScreen mainScreen].bounds];
    
    return alertView;
}

- (void)alertInCurrentView{
    UIWindow *window = [UIApplication sharedApplication].delegate.window;
    [window addSubview:self];
}

- (void)showAlertView{
    [self alertInCurrentView];
}

- (void)alertViewDismiss{
    [self.contentView removeFromSuperview];
    [self.closeBtn removeFromSuperview];
    [self removeFromSuperview];
    if (self.updateAlertViewBlock) {
        self.updateAlertViewBlock();
    }
}


- (instancetype)initWithFrame:(CGRect)frame{
    if (self = [super initWithFrame:frame]) {
        [self setupContents];
    }
    return self;
}


- (void)setupContents{
    self.maskView = [[UIView alloc] init];
    self.maskView.backgroundColor = [UIColor colorWithWhite:0 alpha:0.5];
    UITapGestureRecognizer *tap = [[UITapGestureRecognizer alloc] initWithTarget:self action:@selector(alertViewDismiss)];
    [self.maskView addGestureRecognizer:tap];
    [self addSubview:self.maskView];
    [self.maskView mas_makeConstraints:^(MASConstraintMaker *make) {
        (void)make.edges;
    }];
        
    self.contentView = [[UIView alloc] init];
    self.contentView.backgroundColor = [UIColor whiteColor];
//    self.contentView.layer.cornerRadius = 10.f;
    self.contentView.layer.masksToBounds = YES;
    [self addSubview:self.contentView];
    [self.contentView mas_makeConstraints:^(MASConstraintMaker *make) {
        make.centerX.mas_equalTo(self.mas_centerX);
        make.centerY.mas_equalTo(self.mas_centerY);
        make.width.mas_equalTo(LZMSCREEN_WIDTH_SCALE(280));
        make.height.mas_equalTo(240);
    }];
    
    self.imageView = [[UIImageView alloc] init];
    self.imageView.contentMode = UIViewContentModeScaleAspectFill;
    self.imageView.image = LZMImage(@"img_update_top");
    self.imageView.layer.masksToBounds = YES;
    [self addSubview:self.imageView];
    [self.imageView mas_makeConstraints:^(MASConstraintMaker *make) {
        make.left.right.mas_equalTo(self.contentView);
        make.bottom.mas_equalTo(self.contentView.mas_top);
        make.height.mas_equalTo(self.contentView.mas_width).multipliedBy(160 / 280.0);
    }];
    
    self.titleLabel = [[UILabel alloc] init];
    self.titleLabel.numberOfLines = 1;
    self.titleLabel.textColor = kCustomColor(customColorNumC4);
    self.titleLabel.font = LZMFontMedium16;
    self.titleLabel.textAlignment = NSTextAlignmentLeft;
    [self.contentView addSubview:self.titleLabel];
    [self.titleLabel mas_makeConstraints:^(MASConstraintMaker *make) {
        make.left.mas_equalTo(self.contentView.mas_left).mas_offset(30.f);
        make.right.mas_equalTo(self.contentView.mas_right).mas_offset(-30);
        make.top.mas_offset(11);
    }];
    
    self.updateInfoLabel = [[UITextView alloc] init];
//    self.updateInfoLabel.enabl = NO;
    self.updateInfoLabel.textColor = LZMColor(@"C5");
    self.updateInfoLabel.font = LZMFont12;
    self.updateInfoLabel.delegate = self;
    [self.contentView addSubview:self.updateInfoLabel];
    [self.updateInfoLabel mas_makeConstraints:^(MASConstraintMaker *make) {
        make.left.mas_equalTo(self.contentView.mas_left).mas_offset(30.f);
        make.right.mas_equalTo(self.contentView.mas_right).mas_offset(-30);
        make.top.mas_equalTo(self.titleLabel.mas_bottom).mas_offset(12.f);
        make.height.mas_equalTo(110);
    }];
    
    self.updateBtn = [[HZGradientButton alloc] init];
    [self.updateBtn setTitle:@"立即更新" forState:UIControlStateNormal];
    [self.updateBtn setTitleColor:[UIColor whiteColor] forState:UIControlStateNormal];
    self.updateBtn.disableGradient = YES;
    self.updateBtn.enabled = YES;
    self.updateBtn.titleLabel.font = LZMFontMedium15;
    self.updateBtn.layer.cornerRadius = 2.f;
    self.updateBtn.layer.masksToBounds = YES;
    [self.updateBtn addTarget:self action:@selector(updatePush) forControlEvents:UIControlEventTouchUpInside];
    [self.contentView addSubview:self.updateBtn];
    [self.updateBtn mas_makeConstraints:^(MASConstraintMaker *make) {
        make.top.mas_equalTo(self.updateInfoLabel.mas_bottom).mas_offset(27.f);
        make.height.mas_equalTo(44.f*LZMWIDTH_SCALE);
        make.left.mas_equalTo(self.contentView.mas_left).mas_offset(30.f);
        make.centerX.mas_equalTo(self.contentView);
//        make.bottom.mas_equalTo(self.contentView.mas_bottom).mas_offset(-30.f);
    }];
    
    self.bottomImageview = [UIImageView new];
    self.bottomImageview.image = LZMImage(@"img_update_bottom");
    [self addSubview:self.bottomImageview];
    [self.bottomImageview mas_makeConstraints:^(MASConstraintMaker *make) {
        make.left.right.mas_equalTo(self.contentView);
        make.top.mas_equalTo(self.contentView.mas_bottom);
        make.height.mas_equalTo(self.contentView.mas_width).multipliedBy(20 / 280.0);
    }];
    
    self.closeBtn = [[UIButton alloc] init];
    [self.closeBtn addTarget:self action:@selector(alertViewDismiss) forControlEvents:UIControlEventTouchUpInside];
    [self.closeBtn setImage:[UIImage imageNamed:@"update_close"] forState:UIControlStateNormal];
    [self addSubview:self.closeBtn];
    [self.closeBtn mas_makeConstraints:^(MASConstraintMaker *make) {
        make.top.mas_equalTo(self.bottomImageview.mas_bottom).mas_offset(15);
        make.centerX.mas_equalTo(self.contentView);
        make.width.height.mas_equalTo(40.f);
    }];
}

- (void)setUpdateModel:(LZMAPPVersionModel *)updateModel{
    _updateModel = updateModel;
    self.titleLabel.text = [NSString stringWithFormat:@"发现新版本 %@", _updateModel.targetVersion];
    
    NSMutableParagraphStyle *paragraph = [[NSMutableParagraphStyle alloc] init];
    paragraph.lineSpacing = 5.f;
    NSMutableAttributedString *attributeString = [[NSMutableAttributedString alloc] initWithString:_updateModel.message attributes:@{NSFontAttributeName: LZMFont12, NSParagraphStyleAttributeName :paragraph, NSForegroundColorAttributeName : kCustomColor(customColorNumC5)}];
    self.updateInfoLabel.attributedText = attributeString;
    self.closeBtn.hidden = _updateModel.isForce;
    self.maskView.userInteractionEnabled = !_updateModel.isForce;
}


- (void)updatePush{
    NSString *appStoreUrl = [NSString stringWithFormat:@"%@%@?mt=8", kAppStoreUrl, kAPPId];
    NSURL *url = [NSURL URLWithString:appStoreUrl];
    if ([[UIApplication sharedApplication] canOpenURL:url]){
        [self alertViewDismiss];
        [[UIApplication sharedApplication] openURL:url];
    }
}

#pragma mark - delegate
- (BOOL)textViewShouldBeginEditing:(UITextView *)textView
{
    return false;
}

@end

//
//  LZMHomepageHeader.m
//  Louzhangmen
//
//  Created by Quanhai on 2018/8/16.
//  Copyright © 2018年 Shenzhen Zhongzheng Information Technology Co., Ltd. All rights reserved.
//

#import "LZMHomepageHeader.h"

@interface LZMHomepageHeader()

@property (nonatomic, strong) UIView * leftView ; /**< <# #> **/
@property (nonatomic, strong) UILabel * titleLabel ; /**< <# #> **/
@property (nonatomic, strong) UIButton * moreBtn ; /**< <# #> **/
@property (nonatomic, strong) UIView * sepratorView ; /**< <# #> **/

@end


@implementation LZMHomepageHeader

- (instancetype)initWithFrame:(CGRect)frame{
    if (self = [super initWithFrame:frame]) {
        [self setupSubviews];
    }
    return self;
}


- (void)setupSubviews{
    self.backgroundColor = [UIColor whiteColor];
    self.leftView = [[UIView alloc] init];
    self.leftView.backgroundColor = LZMColor(@"C1");
//    [self addSubview:self.leftView];
//    [self.leftView mas_makeConstraints:^(MASConstraintMaker *make) {
//        make.left.mas_equalTo(self.mas_left).mas_offset(15.f);
//        make.centerY.mas_equalTo(self.mas_centerY);
//        make.size.mas_equalTo(CGSizeMake(2.f, 10.f));
////        make.top.mas_equalTo(self.mas_top).mas_offset();
//    }];
    
    self.titleLabel = [[UILabel alloc] init];
    self.titleLabel.font = LZMFont(LZMSize(@"T1"), LZMFontName(@"F2"));
    self.titleLabel.textColor = LZMColor(@"C4");
    [self addSubview:self.titleLabel];
    [self.titleLabel mas_makeConstraints:^(MASConstraintMaker *make) {
        make.left.mas_equalTo(12);
        make.top.mas_equalTo(24);
        make.bottom.mas_equalTo(0);
    }];
    
    self.moreBtn = [[UIButton alloc] initWithFrame:CGRectMake(self.bounds.size.width - 44, (self.height-32), 32, 32)];
 //   [self.moreBtn setTitle:@"更多" forState:UIControlStateNormal];
  //  [self.moreBtn setTitleColor:LZMColor(@"C4") forState:UIControlStateNormal];
   // self.moreBtn.titleLabel.font = LZMFont(LZMSize(@"T5"), LZMFontName(@"F1"));
    [self.moreBtn setImage:[UIImage imageNamed:@"lzm_icon_custom_right_black"] forState:UIControlStateNormal];
    [self.moreBtn addTarget:self action:@selector(moreBtnAction:) forControlEvents:UIControlEventTouchUpInside];
  //  self.moreBtn.imageEdgeInsets = UIEdgeInsetsMake(0, 55-18, 0, 0);
  //  self.moreBtn.titleEdgeInsets = UIEdgeInsetsMake(0, -15, 0, 18);
    [self addSubview:self.moreBtn];
    self.moreBtn.hidden = YES;
    
    self.sepratorView = [[UIView alloc] initWithFrame:CGRectMake(0, self.bounds.size.height-0.5, self.bounds.size.width, 1)];
    self.sepratorView.backgroundColor = LZMColor(@"C8");
    [self addSubview:self.sepratorView];
    self.sepratorView.hidden = YES;
}

- (void)setTitle:(NSString *)title{
    _title = title;
    self.titleLabel.text = _title;
}

- (void)setShowMoreAccess:(BOOL)showMoreAccess{
    _showMoreAccess = showMoreAccess;
    self.moreBtn.hidden = !_showMoreAccess;
}

- (void)setShowSeprator:(BOOL)showSeprator{
    _showSeprator = showSeprator;
    self.sepratorView.hidden = !_showSeprator;
}

- (void)setCateIndex:(NSInteger)cateIndex{
    if (_cateIndex == cateIndex){
        return;
    }else if(_cateIndex <cateIndex){
        // 向左滑
        [self rotateWithWise:YES];
    }else{
        // 向右滑
        [self rotateWithWise:NO];
    }
    _cateIndex = cateIndex;
}

// 是否顺时针翻转leftView
- (void)rotateWithWise:(BOOL)clockWise{
    CGFloat angle = clockWise? M_PI : -M_PI;
    CABasicAnimation *rotateAnimation = [CABasicAnimation animationWithKeyPath:@"transform.rotation.z"];
    rotateAnimation.duration = 0.1f;
    rotateAnimation.toValue = @(angle);
    [self.leftView.layer addAnimation:rotateAnimation forKey:@"rotation"];
}


- (void)moreBtnAction:(UIButton *)button{
    if (self.delegate && [self.delegate respondsToSelector:@selector(homepageHeaderTapped:)]){
        [self.delegate homepageHeaderTapped:self];
    }
}

- (void)setFrame:(CGRect)frame {
   if (frame.size.height > 1) frame.size.height += 1;
    [super setFrame:frame];
}

@end

//
//  LZMHomeTableHeaderView.m
//  LZM_SmartEdifice
//
//  Created by Quanhai on 2019/2/25.
//  Copyright © 2019 SZ_LZM. All rights reserved.
//

#import "LZMHomePageTableView.h"

@implementation LZMHomePageTableView

- (UIView *)hitTest:(CGPoint)point withEvent:(UIEvent *)event{
    CGPoint touchPointInNext = [self convertPoint:point toView:_nextView];
    CGPoint touchPointInResonse = [self convertPoint:point toView:_responseView];
    UIView *canNextView = [_responseView hitTest:touchPointInResonse withEvent:event];
    if (canNextView){
        UIView *view = [_nextView hitTest: touchPointInNext withEvent: event];
        if (view)
            return view;
    }
    
    return [super hitTest:point withEvent:event];
}

@end

//
//  HompeItemTableViewCell.m
//  LZM_SmartEdifice
//
//  Created by Quanhai on 2019/2/25.
//  Copyright © 2019 SZ_LZM. All rights reserved.
//

#import "HompeItemTableViewCell.h"
#import "UIView+Border.h"
#import "LZMNewView.h"
#import "LZMNewService.h"
#import "LHGroupListBodyItemView.h"

NSString *const kHomePageItemCellIdentifer = @"HomePageItemCellIdentifer";

@interface HompeItemTableViewCell()


@end

@implementation HompeItemTableViewCell

- (instancetype)initWithStyle:(UITableViewCellStyle)style reuseIdentifier:(NSString *)reuseIdentifier{
    if (self = [super initWithStyle:style reuseIdentifier:reuseIdentifier]) {
        self.selectionStyle = UITableViewCellSelectionStyleNone;
        [self setupSubviews];
    }
    return self;
}

- (void)setupSubviews{
    self.backgroundColor = [UIColor clearColor];
   // self.contentView.backgroundColor = [UIColor whiteColor];
    self.clipsToBounds = YES;
   // [self.contentView setBottomBorderWithColor:LZMColor(@"C10") width:LZMDevWidth height:1];
}

- (void)layoutSubviews{
    [super layoutSubviews];
    if (self.bounds.size.width == LZMDevWidth){
//        UIBezierPath *maskPath = [UIBezierPath bezierPathWithRoundedRect:self.bounds byRoundingCorners:UIRectCornerTopLeft|UIRectCornerTopRight cornerRadii:CGSizeMake(20.f, 20.f)];
//        /** 创建Layer */
//        CAShapeLayer *maskLayer = [[CAShapeLayer alloc] init];
//        maskLayer.frame = self.bounds;
//        /** 赋值 */
//        maskLayer.path = maskPath.CGPath;
//        self.layer.mask = maskLayer;
    }
}

/**
 点击事件
 
 @param index 下标
 */
- (void)LHGroupListViewDidselectWithIndex:(NSInteger)index
{
    NSLog(@"点击了第%ld", index);
    BLOCK_EXEC(self.selectBlock, index);
    
    LHGroupListBodyItemView *view = [self.listView.bodyView getItemContentViewWithIndex:index];
    [self saveNewWithIndex:index view:view.contentView];
}

- (LHGroupListStyle *)defaultStyle
{
    LHGroupListBodyStyle *body = [LHGroupListBodyStyle new];
    body.singleLine = NO;
    body.styleType = LHUIStyleType10;
    
    LHGroupListStyle *style = [LHGroupListStyle new];
    style.bodyStyle = body;
    
    return style;
}

/**
 获取视图
 
 @param index 下标
 @return 视图
 */
- (UIView *_Nonnull)LHGroupListItemViewItemWithIndex:(NSInteger)index
{
    LHUIStyleModel *model = [self getStyleModelWithIndex:index];
    
    UIView *view = [LHUIStyle getStyleViewWithStyle:self.style.bodyStyle.styleType model:model];
    
    [self checkNewWithIndex:index view:view];
    
    return view;
}

/// 检查是否显示红点
/// @param index 下标
/// @param view 需要添加new的视图
- (void)checkNewWithIndex:(NSInteger)index view:(UIView *)view
{
    //只有储能
    if ([SingleDataHelper sharedSingleDataHelper].isCompany_ZGCN) {
        HomePageItem *jumpModel = [self.items objectAtIndex:index];
        
        BOOL hidden = true;
        if (jumpModel.jumpType == 1504) {//物业
            if (![LZMNewService getHomeTenementNew]) {
                hidden = false;
            }
        }
        
        LZMNewView *newView = [LZMNewView LZMNewViewHidden:hidden onView:view];
        [newView mas_makeConstraints:^(MASConstraintMaker *make) {
            make.right.mas_equalTo(view.mas_right).mas_offset(3);
            make.top.mas_offset(-4);
            make.width.mas_equalTo(newView.width);
            make.height.mas_equalTo(newView.height);
        }];
    }
}

/// 清除New
/// @param index 下标
/// @param view 视图
- (void)saveNewWithIndex:(NSInteger)index view:(UIView *)view
{
    //只有储能
    if ([SingleDataHelper sharedSingleDataHelper].isCompany_ZGCN) {
        HomePageItem *jumpModel = [self.items objectAtIndex:index];
        
        if (jumpModel.jumpType == 1504) {//物业
            if (![LZMNewService getHomeTenementNew]) {
                [LZMNewService saveHomeTenementNewState];
            }
        }
        
        [LZMNewView LZMNewViewHidden:true onView:view];
    }
}
#pragma mark - setter getter
- (void)setItems:(NSArray<HomePageItem *> *)items{
    _items = items;
    [self.styleItemModelArray removeAllObjects];
    
    for (HomePageItem *item in _items) {
        LHUIStyleModel *newModel = [LHUIStyleModel new];
        newModel.title = item.title;
        newModel.imageNamed = item.icon;
        newModel.imageUrl = item.iconUrl;
        
        [self.styleItemModelArray addObject:newModel];
    }
    
    [self reloadFrame];
}
//解决首页cell设置圆角后出现缝隙
- (void)setFrame:(CGRect)frame {
    if (frame.size.height > 1) frame.size.height += 1;
    [super setFrame:frame];
}

@end

//
//  HomePageNotifiTableViewCell.m
//  LZM_SmartEdifice
//
//  Created by Quanhai on 2019/2/25.
//  Copyright © 2019 SZ_LZM. All rights reserved.
//

#import "HomePageNotifiTableViewCell.h"
#import "UIView+HGCorner.h"
NSString *const kHomePagePublicNotifiCellIdentifer = @"HomePagePublicNotifiCellIdentifer";

@interface HomePageNotifiTableViewCell()

@property (nonatomic, strong) ScrollNotifiView * notifView ; /**< 公告 **/

@end

@implementation HomePageNotifiTableViewCell

- (instancetype)initWithStyle:(UITableViewCellStyle)style reuseIdentifier:(NSString *)reuseIdentifier{
    if (self = [super initWithStyle:style reuseIdentifier:reuseIdentifier]) {
        self.selectionStyle = UITableViewCellSelectionStyleNone;
        [self setupSubviews];
    }
    return self;
}

- (void)setupSubviews{
    _notifiHeight = 40.f;
    self.contentView.backgroundColor = [UIColor whiteColor];
    self.contentView.layer.masksToBounds = YES;
    [self.contentView addSubview:self.notifView];
    [self.notifView mas_makeConstraints:^(MASConstraintMaker *make) {
        make.edges.mas_equalTo(0);
        make.height.mas_equalTo(1.f);
    }];
    self.notifView.isLeftImgVisable = NO;
}


#pragma mark - setter getter
- (void)setNotifis:(NSArray<NSString *> *)notifis{
    _notifis = notifis;
    self.notifView.notifis = _notifis;
    self.notifView.isLeftImgVisable = (_notifis.count != 0);
    CGFloat height = (_notifis.count == 0)?1.f: self.notifiHeight;
    [self.notifView mas_remakeConstraints:^(MASConstraintMaker *make) {
        make.left.top.mas_equalTo(12);
        make.right.bottom.mas_equalTo(-12);
        make.height.mas_equalTo(height);
    }];
}

- (void)setDelegate:(id<ScrollNotifiViewDelegate>)delegate{
    self.notifView.deleagte = delegate;
}

- (ScrollNotifiView *)notifView{
    if (!_notifView) {
        _notifView = [[ScrollNotifiView alloc] initWithImageSize:CGSizeMake(30, 18)];
        _notifView.leftImage = @"lzm_home_notice";
        _notifView.rightImage = @"lzm_icon_custom_right_black";
        _notifView.notifiTitleFont = LZMFont(LZMSize(@"T5"), LZMFontName(@"F1"));
        _notifView.notifiTitleColor = LZMColor(@"C4");
        _notifView.isAccessImgVisable = YES;
        _notifView.backgroundColor = LZMColor(@"C112");
        [_notifView hg_setAllCornerWithCornerRadius:8];
    }
    return _notifView;
}

//解决首页cell设置圆角后出现缝隙
- (void)setFrame:(CGRect)frame {
    if (frame.size.height > 1) frame.size.height += 1;
    [super setFrame:frame];
}
@end

//
//  HomeEntranceTableViewCell.m
//  LZM_SmartEdifice
//
//  Created by Quanhai on 2019/2/25.
//  Copyright © 2019 SZ_LZM. All rights reserved.
//

#import "HomeEntranceTableViewCell.h"

NSString *const kHomePageEntranceCellIdentifier = @"HomePageEntranceCellIdentifier";

@interface HomeEntranceTableViewCell()
<
MutiIconsViewDelegate
>
@property (nonatomic, strong) LZMHomeItemsView * itemsView ; /**< items view **/

@end

@implementation HomeEntranceTableViewCell

- (instancetype)initWithStyle:(UITableViewCellStyle)style reuseIdentifier:(NSString *)reuseIdentifier{
    if (self = [super initWithStyle:style reuseIdentifier:reuseIdentifier]) {
        self.selectionStyle = UITableViewCellSelectionStyleNone;
    }
    return self;
}

- (LHGroupListStyle *)defaultStyle
{
    LHGroupListBodyStyle *body = [LHGroupListBodyStyle new];
    body.itemNum = self.styleItemModelArray.count;
    body.singleLine = NO;
    body.styleType = LHUIStyleType12;
    
    LHGroupListStyle *style = [LHGroupListStyle new];
    style.bodyStyle = body;
    
    return style;
}

/**
 点击事件
 
 @param index 下标
 */
- (void)LHGroupListViewDidselectWithIndex:(NSInteger)index
{
    NSLog(@"点击了第%ld", index);
    BLOCK_EXEC(self.selectBlock, index);
}
#pragma mark - setter getter
- (void)setEntrances:(NSArray<HomePageEntrance *> *)entrances{
    _entrances = entrances;
    
    [self.styleItemModelArray removeAllObjects];
    
    for (HomePageEntrance *item in entrances) {
        LHUIStyleModel *newModel = [LHUIStyleModel new];
        newModel.imageNamed = item.icon;
        newModel.imageUrl = item.iconUrl;
        newModel.title = item.title;
        newModel.describe = item.Description;
        
        [self.styleItemModelArray addObject:newModel];
    }
    
    [self reloadFrame];
}
//解决首页cell设置圆角后出现缝隙
- (void)setFrame:(CGRect)frame {
    if (frame.size.height > 1) frame.size.height += 1;
    [super setFrame:frame];
}

@end

//
//  HomePageProductGroupCell.m
//  LZM_SmartEdifice
//
//  Created by Quanhai on 2019/2/25.
//  Copyright © 2019 SZ_LZM. All rights reserved.
//

#import "HomePageProductGroupCell.h"
#import "HomePageProductGroupView.h"
#import "LZMPageControl.h"
#import "HZProxyTimer.h"
#import "LZMHomePageService.h"

NSString *const kHomePageGroupCollectionCellIdentifer = @"homePageGroupCellIdentifer";


@interface HomePageGroupColletionCell : UICollectionViewCell
@property (nonatomic, strong) HomePageProductGroupView * groupView ; /**< groupView **/

@end
@implementation HomePageGroupColletionCell
- (instancetype)initWithFrame:(CGRect)frame{
    if (self = [super initWithFrame:frame]) {
        [self setupSubviews];
    }
    return self;
}
- (void)setupSubviews{
    [self.contentView addSubview:self.groupView];
    [self.groupView mas_makeConstraints:^(MASConstraintMaker *make) {
        (void)make.edges;
    }];
}
- (HomePageProductGroupView *)groupView{
    if (!_groupView) {
        _groupView = [[HomePageProductGroupView alloc] initWithFrame:self.bounds];
    }
    return _groupView;
}
@end

CGFloat kHomePageGroupPageControlHeight = 18.f;
NSString *const kHomePageProductGroupCellIdenitfer = @"homePageProductGroupCellIdenitifer";

@interface HomePageProductGroupCell ()
<
UICollectionViewDelegate,
UICollectionViewDataSource,
HomePageProductViewDelegate
>
@property (nonatomic, assign) CGFloat cellHeight ; /**<  **/
@property (nonatomic, strong) UICollectionView * collectionView ; /**<  **/
@property (nonatomic, strong) LZMPageControl * pageControl ; /**< pageControl **/
@property (nonatomic, strong) NSMutableArray <NSArray <LZMProduct *> *> * groupProducts ; /**<  **/
//
@property (nonatomic, copy) NSString *timerDes ; /**< timer描述 **/
//@property (nonatomic, assign) NSInteger dragStatus ; /**< 滑动状态 , 0 未drag， 1 drag 开始， 2 drag 结束 **/
@property (nonatomic, assign) BOOL canAutoScroll ; /**< 是否可以自滚动 **/
@property (nonatomic, weak) NSTimer *timer;
@property (nonatomic, assign) CGFloat rollingX;
@end


@implementation HomePageProductGroupCell
- (instancetype)initWithStyle:(UITableViewCellStyle)style reuseIdentifier:(NSString *)reuseIdentifier{
    if (self = [super initWithStyle:style reuseIdentifier:reuseIdentifier]) {
        self.selectionStyle = UITableViewCellSelectionStyleNone;
        [self setupSubviews];
    }
    return self;
}

- (void)setupSubviews{
    self.backgroundColor = [UIColor whiteColor];
    self.cellHeight = [HomePageProductGroupView evaluateHeightForWidth:LZMDevWidth];
    [self.contentView addSubview:self.collectionView];
    [self.collectionView mas_makeConstraints:^(MASConstraintMaker *make) {
        (void)make.left.right;
        make.top.equalTo(@12);
        make.height.mas_equalTo(self.cellHeight);
    }];
    [self.contentView addSubview:self.pageControl];
    [self.pageControl mas_makeConstraints:^(MASConstraintMaker *make) {
        make.centerX.mas_equalTo(self.contentView);
        make.bottom.mas_equalTo(self.contentView.mas_bottom).mas_offset(-8.f);
        make.size.mas_equalTo(CGSizeZero);
        make.top.mas_equalTo(self.collectionView.mas_bottom).mas_offset(5.f);
    }];
    [self.collectionView registerClass:[HomePageGroupColletionCell class] forCellWithReuseIdentifier:kHomePageGroupCollectionCellIdentifer];
}

- (void)dealloc
{
    [self.timer invalidate];
    self.timer = nil;
}

#pragma mark - actions
- (void)viewDidAppearbeginScrolling{
    if (self.timerDes){
        self.canAutoScroll = (self.groupProducts.count > 1);
        [self stratTimerTask];
    }
}
- (void)viewWillDisappearEndScrolling{
    if (self.timerDes){
        self.canAutoScroll = NO;
        [self pauseTimer];
    }
}

/** 页面开始 */
- (void)stratTimerTask {
    /** 2秒后在开始滚动 */
    if (self.groupProducts.count > 1) {
        [self performSelector:@selector(stratTimer) withObject:nil afterDelay:2];
    }
}
- (void)stratTimer {
    /** 执行定时器开启 */
    [_timer setFireDate:[NSDate date]];
}

/** 页面暂停 */
- (void)pauseTimer {
    /** 先取消performSelector任务，防止重复点击tabBar切换造成任务延时无限滚动 */
    if (self.groupProducts.count <= 1) {return;}
    [[self class] cancelPreviousPerformRequestsWithTarget:self];
    /** 执行定时器暂停 */
    [_timer setFireDate:[NSDate distantFuture]];
    /** 防止滚动到一半 */
    dispatch_async(dispatch_get_main_queue(), ^{
        if (_rollingX >= LZMDevWidth){
            [self.collectionView setContentOffset:CGPointMake(LZMDevWidth, 0) animated:YES];
        }else{
            [self.collectionView setContentOffset:CGPointMake(0, 0) animated:YES];
        }
    });
}

#pragma mark - delegate
- (void)homePageSelectedProduct:(LZMProduct *)product{
    if ([self.delegate respondsToSelector:@selector(groupProductSelected:)]){
        [self.delegate groupProductSelected:product];
    }
}

- (void)scrollViewDidScroll:(UIScrollView *)scrollView{
    CGFloat offsetX = scrollView.contentOffset.x;
    _rollingX = offsetX;
    NSInteger index = offsetX/LZMDevWidth;
    if (index >= 0 && index < self.groups.count){
        self.pageControl.currentPage = index;
        if (_groupIndex != index){
            _groupIndex = index;
            if (self.groupIndexChanged){
                self.groupIndexChanged(self.groupIndex);
            }
        }
    }
}

- (void)scrollViewWillBeginDragging:(UIScrollView *)scrollView{
    if (scrollView == self.collectionView){
        self.canAutoScroll = NO;
    }
}
- (void)scrollViewDidEndDragging:(UIScrollView *)scrollView willDecelerate:(BOOL)decelerate{
    if (scrollView == self.collectionView){
        _rollingX = scrollView.contentOffset.x;
        dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(3 * NSEC_PER_SEC)), dispatch_get_main_queue(), ^{
           self.canAutoScroll = YES;
        });
    }
}

#pragma mark - 自滚动
- (void)scrollCollectionView{
    self.canAutoScroll = (self.groups.count > 1);
    if(!_timerDes && self.canAutoScroll){
        [self setTimer];
    }
}

- (void)setTimer{
    self.timerDes = @"timer已初始化";
    _timer = [HZProxyTimer scheduledTimerWithTimeInterval:3 target:self selector:@selector(scrollGroup) userInfo:nil repeats:YES];
    [[NSRunLoop currentRunLoop] addTimer:_timer forMode:NSRunLoopCommonModes];
    dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(1.5 * NSEC_PER_SEC)), dispatch_get_global_queue(0, 0), ^{
        [_timer fire];
    });
}

- (void)scrollGroup{
    if (self.canAutoScroll){
        dispatch_async(dispatch_get_main_queue(), ^{
            if (self.collectionView.contentOffset.x >= LZMDevWidth){
                [self.collectionView setContentOffset:CGPointMake(0, 0) animated:YES];  // 向第0个滚
            }else{
                [self.collectionView setContentOffset:CGPointMake(LZMDevWidth, 0) animated:YES]; // 向第1个滚
            }
        });
    }
}

#pragma mark -  datasource
- (NSInteger)collectionView:(UICollectionView *)collectionView numberOfItemsInSection:(NSInteger)section{
    return self.groups.count;
}

- (__kindof UICollectionViewCell *)collectionView:(UICollectionView *)collectionView cellForItemAtIndexPath:(NSIndexPath *)indexPath{
    HomePageGroupColletionCell *cell = [collectionView dequeueReusableCellWithReuseIdentifier:kHomePageGroupCollectionCellIdentifer forIndexPath:indexPath];
    cell.groupView.delegate = self;
    cell.groupView.products = self.groups[indexPath.row].goods;
    return cell;
}


#pragma mark - setter getter
- (void)setGroups:(NSArray<LZMProductGroup *> *)groups{
    _groups = groups;
    NSMutableArray *groupProducts = [NSMutableArray array];
   // for (LZMProductGroup *group in _groups) {
//        [LZMHomePageService getHomePageProductsWithGroupId:group.groupId success:^(id  _Nullable responseObj, NSString * _Nullable message, NSInteger statusCode, NSUInteger responseCode) {
//            NSArray <LZMProduct *> *products = [LZMProduct mj_objectArrayWithKeyValuesArray:responseObj[@"list"]];
//            [groupProducts addObject:products];
//            [self reloadData:groupProducts];
//        } failureHandle:^(NSError * _Nullable error, NSString * _Nullable message, NSInteger statusCode, NSUInteger responseCode) {
//            [groupProducts addObject:@[]];
//            [self reloadData:groupProducts];
//        }];
  //  }
    self.pageControl.numberOfPages = self.groups.count;
    CGSize size = [self.pageControl sizeForNumberOfPages:self.groups.count];
    [self.pageControl mas_updateConstraints:^(MASConstraintMaker *make) {
        make.size.mas_equalTo(size);
    }];
    [self.collectionView reloadData];
    [self scrollCollectionView];
}

- (void)reloadData:(NSMutableArray <NSArray <LZMProduct *> *> *)groupProducts{
    if (groupProducts.count != self.groups.count){
        return ;
    }
    self.groupProducts = [NSMutableArray array];
    for (LZMProductGroup *group in self.groups) {
        for (NSArray <LZMProduct *> *products in groupProducts) {
            LZMProduct *product = [products firstObject];
            if ([product.groupId isEqualToString:group.groupId]){
                [self.groupProducts addObject:products];
            }
        }
    }
    [self.collectionView reloadData];
    [self scrollCollectionView];
}

- (UICollectionView *)collectionView{
    if (!_collectionView) {
        UICollectionViewFlowLayout *layout = [[UICollectionViewFlowLayout alloc] init];
        layout.scrollDirection = UICollectionViewScrollDirectionHorizontal;
        layout.itemSize = CGSizeMake(LZMDevWidth, self.cellHeight);
        layout.minimumLineSpacing = 0;
        layout.minimumInteritemSpacing = 0;
        layout.sectionInset = UIEdgeInsetsZero;
        _collectionView = [[UICollectionView alloc] initWithFrame:self.bounds collectionViewLayout:layout];
        _collectionView.backgroundColor = [UIColor clearColor];
        _collectionView.pagingEnabled = YES;
        _collectionView.showsHorizontalScrollIndicator = NO;
        _collectionView.delegate = self;
        _collectionView.dataSource = self;
    }
    return _collectionView;
}

- (LZMPageControl *)pageControl{
    if (!_pageControl) {
        _pageControl = [[LZMPageControl alloc] initWithStyle:LZMPageControlStyleLineCenter];
    }
    return _pageControl;
}

//解决首页cell设置圆角后出现缝隙
- (void)setFrame:(CGRect)frame {
    if (frame.size.height > 1) frame.size.height += 1;
    [super setFrame:frame];
}

@end

//
//  HomePageProductGroupView.m
//  LZM_SmartEdifice
//
//  Created by Quanhai on 2019/2/26.
//  Copyright © 2019 SZ_LZM. All rights reserved.
//

#import "HomePageProductGroupView.h"
#import "HomePageProductView.h"

CGFloat const kProductViewMargin = 12.f;
CGFloat const kProductViewItemSpace  = 6.f;


@interface HomePageProductGroupView ()

@property (nonatomic, strong) HomePageProductView * productView1 ; /**< 1 **/
@property (nonatomic, strong) HomePageProductView * productView2 ; /**< 2 **/
@property (nonatomic, strong) HomePageProductView * productView3 ; /**< 3 **/
@property (nonatomic, assign) CGFloat singleWidth ; /**< <# #> **/

@end

@implementation HomePageProductGroupView

- (instancetype)initWithFrame:(CGRect)frame{
    if (self = [super initWithFrame:frame]) {
        [self setupSubviews];
    }
    return self;
}

- (void)setupSubviews{
    self.singleWidth = (self.bounds.size.width - 2*kProductViewMargin - 2*kProductViewItemSpace)/3;
    
    [self addSubview:self.productView1];
    [self.productView1 mas_makeConstraints:^(MASConstraintMaker *make) {
        make.left.mas_equalTo(self).mas_offset(kProductViewMargin);
        make.width.mas_equalTo(self.singleWidth);
        (void)make.top.bottom;
    }];
    
    [self addSubview:self.productView2];
    [self.productView2 mas_makeConstraints:^(MASConstraintMaker *make) {
        make.left.mas_equalTo(self.productView1.mas_right).mas_offset(kProductViewItemSpace);
        make.width.mas_equalTo(self.singleWidth);
        (void)make.top.bottom;
    }];
    
    [self addSubview:self.productView3];
    [self.productView3 mas_makeConstraints:^(MASConstraintMaker *make) {
        make.left.mas_equalTo(self.productView2.mas_right).mas_offset(kProductViewItemSpace);
        make.width.mas_equalTo(self.singleWidth);
        (void)make.top.bottom;
    }];
    
    UITapGestureRecognizer *tap1 = [[UITapGestureRecognizer alloc] initWithTarget:self action:@selector(productSelected:)];
    [self.productView1 addGestureRecognizer:tap1];
    UITapGestureRecognizer *tap2 = [[UITapGestureRecognizer alloc] initWithTarget:self action:@selector(productSelected:)];
    [self.productView2 addGestureRecognizer:tap2];
    UITapGestureRecognizer *tap3 = [[UITapGestureRecognizer alloc] initWithTarget:self action:@selector(productSelected:)];
    [self.productView3 addGestureRecognizer:tap3];
}

+ (CGFloat)evaluateHeightForWidth:(CGFloat)width{
    CGFloat singleWidth = (width - 2*kProductViewMargin - 2*kProductViewItemSpace)/3;
    return singleWidth+24.f;
}

#pragma mark - actions
- (void)productSelected:(UITapGestureRecognizer *)tap{
    if (tap.view.tag >= self.products.count){
        return;
    }
    LZMProduct *product = self.products[tap.view.tag];
    if ([self.delegate respondsToSelector:@selector(homePageSelectedProduct:)]){
        [self.delegate homePageSelectedProduct:product];
    }
}


#pragma mark - setter getter
- (void)setProducts:(NSArray<LZMProduct *> *)products{
    _products = products;
    if (_products.count > 0){
        self.productView1.hidden = NO;
        LZMProduct *product1 = [_products firstObject];
        self.productView1.imageUrl = product1.coverImg;
        self.productView1.title = product1.goodsName;
        self.productView1.priceDes = [NSString descriptionWithPrice:product1.discountPrice];
        self.productView1.originPrice = [NSString atttributeStringWithOriginPrice:product1.salePrice];
        if (_products.count >1){
            self.productView2.hidden = NO;
            LZMProduct *product2 = [_products objectAtIndex:1];
            self.productView2.imageUrl = product2.coverImg;
            self.productView2.title = product2.goodsName;
            self.productView2.priceDes = [NSString descriptionWithPrice:product2.discountPrice];
            self.productView2.originPrice = [NSString atttributeStringWithOriginPrice:product2.salePrice];
            if (_products.count > 2){
                self.productView3.hidden = NO;
                LZMProduct *product3 = [_products objectAtIndex:2];
                self.productView3.imageUrl = product3.coverImg;
                self.productView3.title = product3.goodsName;
                self.productView3.priceDes = [NSString descriptionWithPrice:product3.discountPrice];
                self.productView3.originPrice = [NSString atttributeStringWithOriginPrice:product3.salePrice];
            }else{
                self.productView3.hidden = YES;
            }
        }else{
            self.productView2.hidden = YES;
            self.productView3.hidden = YES;
        }
    }else{
        self.productView1.hidden = YES;
        self.productView2.hidden = YES;
        self.productView3.hidden = YES;
    }
    
}

- (HomePageProductView *)productView1{
    if (!_productView1) {
        _productView1 = [[HomePageProductView alloc] init];
        _productView1.tag = 0;
    }
    return _productView1;
}

- (HomePageProductView *)productView2{
    if (!_productView2) {
        _productView2 = [[HomePageProductView alloc] init];
        _productView2.tag = 1;
    }
    return _productView2;
}

- (HomePageProductView *)productView3{
    if (!_productView3) {
        _productView3 = [[HomePageProductView alloc] init];
        _productView3.tag = 2;
    }
    return _productView3;
}

@end

//
//  HomePageProductCollectionViewCell.m
//  LZM_SmartEdifice
//
//  Created by Quanhai on 2019/2/26.
//  Copyright © 2019 SZ_LZM. All rights reserved.
//

#import "HomePageProductView.h"

@interface HomePageProductView()

@property (nonatomic, strong) YYAnimatedImageView * imageView ; /**< 图标 **/
@property (nonatomic, strong) UILabel * titleLabel ; /**< 标题 **/
@property (nonatomic, strong) UILabel * priceLabel ; /**< 价格 **/
@property (nonatomic, strong) UILabel * originPriceLabel ; /**< 折扣价 **/
@property (nonatomic, assign) CGFloat width ; /**< 宽度 **/

@end

@implementation HomePageProductView

- (instancetype)initWithWidth:(CGFloat)width{
    if (self = [super init]) {
        self.width = width;
//        self.height = self.width + 48.f;
        [self setupSubviews];
    }
    return self;
}

- (instancetype)initWithFrame:(CGRect)frame{
    if (self = [super initWithFrame:frame]) {
        self.width = frame.size.width;
//        self.height = self.width + 48.f;
        [self setupSubviews];
    }
    return self;
}

- (instancetype)init{
    if (self = [super init]) {
        [self setupSubviews];
    }
    return self;
}

- (void)setupSubviews{
    [self addSubview:self.imageView];
    CGFloat imgHeight = self.width - LZMSCREEN_WIDTH_SCALE(35);
    [self.imageView mas_makeConstraints:^(MASConstraintMaker *make) {
        (void)make.left.top.right;
        make.height.mas_equalTo(self.imageView.mas_width).offset(LZMSCREEN_WIDTH_SCALE(-35));
    }];
    [self addSubview:self.titleLabel];
    [self.titleLabel mas_makeConstraints:^(MASConstraintMaker *make) {
        make.left.mas_equalTo(self);
        make.right.mas_equalTo(self);
        make.top.mas_equalTo(self.imageView.mas_bottom).mas_offset(8.f);
    }];
    [self addSubview:self.priceLabel];
    [self.priceLabel mas_makeConstraints:^(MASConstraintMaker *make) {
        make.left.mas_equalTo(self);
        make.top.mas_equalTo(self.titleLabel.mas_bottom).mas_offset(4.f);
        make.bottom.mas_equalTo(self.mas_bottom).mas_offset(-5.f);
    }];
    [self addSubview:self.originPriceLabel];
    [self.originPriceLabel mas_makeConstraints:^(MASConstraintMaker *make) {
        make.left.mas_equalTo(self.priceLabel.mas_right).mas_offset(6.f);
        make.top.mas_equalTo(self.titleLabel.mas_bottom).mas_offset(7.f);
        make.baseline.mas_equalTo(self.priceLabel.mas_baseline);
    }];
}

#pragma mark - setter getter
- (void)setImageUrl:(NSString *)imageUrl{
    _imageUrl = imageUrl;
    if (!_imageUrl){
        self.imageView.image = kProductPlaceholderImage;
        return;
    }
    [self.imageView setImageWithURL:[NSURL URLWithString:_imageUrl] placeholder:kProductPlaceholderImage];
}

- (void)setTitle:(NSString *)title{
    _title = title;
    self.titleLabel.text = _title;
}

- (void)setPriceDes:(NSString *)priceDes{
    _priceDes = priceDes;
    self.priceLabel.attributedText = [self priceAttributeStringWithPrice:_priceDes];
}

- (void)setOriginPrice:(NSAttributedString *)originPrice{
    _originPrice = originPrice;
    self.originPriceLabel.attributedText = _originPrice;
}

- (NSMutableAttributedString *)priceAttributeStringWithPrice:(NSString *)price {
 
     NSString *showText = price;
     if([showText containsString:@".00"]) {
         showText = [showText stringByReplacingOccurrencesOfString:@".00" withString:@""];
     } else {
         if ([[showText substringFromIndex:showText.length-1] isEqualToString:@"0"]) {
             showText = [showText stringByReplacingCharactersInRange:NSMakeRange(showText.length-1, 1) withString:@""];
         }
     }
     NSArray <NSString *>*strArr = [showText componentsSeparatedByString:@"."];
     NSMutableAttributedString *attr = [[NSMutableAttributedString alloc] initWithString:showText];
     [attr setAttributes:@{NSForegroundColorAttributeName : LZMColor(@"C128"),
                           NSFontAttributeName: [UIFont fontWithName:@"ITCAvantGardeStd-DemiCn" size: 14]
     } range:NSMakeRange(0, strArr.firstObject.length)];
     if (strArr.count == 2) {
         [attr setAttributes:@{NSForegroundColorAttributeName : LZMColor(@"C128"),
                                NSFontAttributeName: [UIFont fontWithName:@"ITCAvantGardeStd-DemiCn" size: 10]
          } range:NSMakeRange(strArr.firstObject.length, strArr.lastObject.length+1)];
     }
    return attr;
}

- (YYAnimatedImageView *)imageView{
    if (!_imageView) {
        _imageView = [[YYAnimatedImageView alloc] init];
        _imageView.contentMode = UIViewContentModeScaleAspectFill;
        _imageView.layer.cornerRadius = 8.f;
        _imageView.layer.masksToBounds = YES;
    }
    return _imageView;
}

- (UILabel *)titleLabel{
    if (!_titleLabel) {
        _titleLabel = [[UILabel alloc] init];
        _titleLabel.font = LZMFont(LZMSize(@"T4"), LZMFontName(@"F1"));
        _titleLabel.textColor = LZMColor(@"C4");
    }
    return _titleLabel;
}
- (UILabel *)priceLabel{
    if (!_priceLabel) {
        _priceLabel = [[UILabel alloc] init];
        _priceLabel.font = LZMFont(LZMSize(@"T4"), LZMFontName(@"F2"));
        _priceLabel.textColor = LZMColor(@"C3");
    }
    return _priceLabel;
}
- (UILabel *)originPriceLabel{
    if (!_originPriceLabel) {
        _originPriceLabel = [[UILabel alloc] init];
        //_originPriceLabel.font = LZMFont(LZMSize(@"T5"), LZMFontName(@"F1"));
    }
    return _originPriceLabel;
}

@end

//
//  HomePageLZMServiceCell.m
//  LZM_SmartEdifice
//
//  Created by Quanhai on 2019/2/26.
//  Copyright © 2019 SZ_LZM. All rights reserved.
//

#import "HomePageLZMServiceCell.h"

NSString * kHomePageLZMServiceCellIdentifer = @"homePageLZMServiceCell";

@interface HomePageLZMServiceCell  ()

@property (nonatomic, strong) UIImageView * serviceImageView ; /**<  **/

@end

@implementation HomePageLZMServiceCell

- (instancetype)initWithStyle:(UITableViewCellStyle)style reuseIdentifier:(NSString *)reuseIdentifier{
    if (self = [super initWithStyle:style reuseIdentifier:reuseIdentifier]) {
        self.selectionStyle = UITableViewCellSelectionStyleNone;
        [self setupSubviews];
    }
    return self;
}

- (void)setupSubviews{
    self.backgroundColor = [UIColor whiteColor];
    [self.contentView addSubview:self.serviceImageView];
    [self.serviceImageView mas_makeConstraints:^(MASConstraintMaker *make) {
        make.edges.mas_equalTo(UIEdgeInsetsMake(12, 12, 12, 12));
        make.height.equalTo(@(111));
    }];
}

- (void)setImageName:(NSString *)imageName{
    _imageName = imageName;
    if ([imageName hasPrefix:@"http"]){
        [[SDWebImageDownloader sharedDownloader] downloadImageWithURL:[NSURL URLWithString:imageName] options:SDWebImageDownloaderUseNSURLCache progress:nil completed:^(UIImage * _Nullable image, NSData * _Nullable data, NSError * _Nullable error, BOOL finished) {
            if (!error && image) {
                CGFloat width = LZMDevWidth - 24;
                CGFloat height = width * (image.size.height / image.size.width);
                dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(0.0 * NSEC_PER_SEC)), dispatch_get_main_queue(), ^{
                    [self.serviceImageView mas_remakeConstraints:^(MASConstraintMaker *make) {
                        make.edges.mas_equalTo(UIEdgeInsetsMake(12, 12, 12, 12));
                        make.height.equalTo(@(height));
                    }];
                    self.serviceImageView.image = image;
                    [self layoutIfNeeded];
                });
            } else {
                UIImage *place_image = LZMImage(@"home_admin_shop_img");
                CGFloat width = LZMDevWidth - 24;
                CGFloat height = width * (place_image.size.height / place_image.size.width);
                dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(0.0 * NSEC_PER_SEC)), dispatch_get_main_queue(), ^{
                    [self.serviceImageView mas_remakeConstraints:^(MASConstraintMaker *make) {
                        make.edges.mas_equalTo(UIEdgeInsetsMake(12, 12, 12, 12));
                        make.height.equalTo(@(height));
                    }];
                    self.serviceImageView.image = image;
                    [self layoutIfNeeded];
                });
            }
        }];
    } else {
        UIImage *image = LZMImage(@"home_admin_shop_img");
        CGFloat width = LZMDevWidth - 24;
        CGFloat height = width * (image.size.height / image.size.width);
        dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(0.0 * NSEC_PER_SEC)), dispatch_get_main_queue(), ^{
            [self.serviceImageView mas_remakeConstraints:^(MASConstraintMaker *make) {
                make.edges.mas_equalTo(UIEdgeInsetsMake(12, 12, 12, 12));
                make.height.equalTo(@(height));
            }];
            self.serviceImageView.image = image;
            [self layoutIfNeeded];
        });
    }
    
}

- (UIImageView *)serviceImageView{
    if (!_serviceImageView) {
        _serviceImageView = [[UIImageView alloc] init];
        _serviceImageView.contentMode = UIViewContentModeScaleToFill;
        _serviceImageView.clipsToBounds = YES;
        _serviceImageView.layer.cornerRadius = 4;
    }
    return _serviceImageView;
}

//解决首页cell设置圆角后出现缝隙
- (void)setFrame:(CGRect)frame {
    if (frame.size.height > 1) frame.size.height += 1;
    [super setFrame:frame];
}

@end

//
//  HomePageCompanyUnionCell.m
//  LZM_SmartEdifice
//
//  Created by Quanhai on 2019/2/26.
//  Copyright © 2019 SZ_LZM. All rights reserved.
//

#import "HomePageCompanyUnionCell.h"

NSString *const kHomePageCompanyUnionCell = @"homePageCompanyUnionCell";

CGFloat const kHomePageUnionRatio = 60.f/80;
CGFloat const kHomePageUnionCellHorMargin = 15.f;
CGFloat const kHomePageUnionCellVerMargin = 10.f;
CGFloat const kHomePageUnionCellSpace = 10.f;

@interface HomePageCompanyUnionCell()

@end

@implementation HomePageCompanyUnionCell

- (instancetype)initWithStyle:(UITableViewCellStyle)style reuseIdentifier:(NSString *)reuseIdentifier{
    if (self = [super initWithStyle:style reuseIdentifier:reuseIdentifier]) {
        [self setupSubviews];
    }
    return self;
}

- (void)setupSubviews{

}

- (LHGroupListStyle *)defaultStyle
{
    LHGroupListBodyStyle *body = [LHGroupListBodyStyle new];
    body.itemNum = self.styleItemModelArray.count;
    body.singleLine = NO;
    body.styleType = LHUIStyleType20;
    
    LHGroupListStyle *style = [LHGroupListStyle new];
    style.bodyStyle = body;
    
    return style;
}

/**
 点击事件
 
 @param index 下标
 */
- (void)LHGroupListViewDidselectWithIndex:(NSInteger)index
{
    NSLog(@"点击了第%ld", index);
    if (self.delegate && [self.delegate respondsToSelector:@selector(homePageCompanyUnionSelected:)]){
        [self.delegate homePageCompanyUnionSelected:self.unions[index]];
    }
}


#pragma mark - setter getter
- (void)setUnions:(NSArray<LZMHomePageUnion *> *)unions{
    _unions = unions;

    [self.styleItemModelArray removeAllObjects];
    
    for (LZMHomePageUnion *item in unions) {
        LHUIStyleModel *newModel = [LHUIStyleModel new];
        newModel.imageUrl = item.coverImg;
        
        [self.styleItemModelArray addObject:newModel];
    }
    
    [self reloadFrame];
}

//解决首页cell设置圆角后出现缝隙
- (void)setFrame:(CGRect)frame {
    if (frame.size.height > 1) frame.size.height += 1;
    [super setFrame:frame];
}
@end

//
//  LZMNewsTableViewCell.m
//  LZM_SmartEdifice
//
//  Created by Quanhai on 2019/3/16.
//  Copyright © 2019 SZ_LZM. All rights reserved.
//

#import "LZMNewsTableViewCell.h"
#import "YYAnimatedImageView+hzImage.h"
#import "NSDate+time.h"
#import "UIView+HGCorner.h"
NSString *const kHomeNewsTableCellIdentifer = @"lzmNewsTableCell";

@interface LZMNewsTableViewCell()

@property (nonatomic, strong) UIView * containerView ; /**<  **/
@property (nonatomic, strong) UILabel * contentLabel ; /**<  **/
@property (nonatomic, strong) UILabel * timeLabel ; /**<  **/
@property (nonatomic, strong) YYAnimatedImageView *postImageView ; /**<  **/

@property (nonatomic, strong) UIButton * likeBtn ; /**<  **/
@property (nonatomic, strong) UIButton * commentBtn ; /**<  **/
@property (nonatomic, strong) UIButton * viewBtn ; /**<  **/
@property (nonatomic, strong) UILabel * viewLabel ; /**<  **/

@property (nonatomic, strong) UIView * sepratorView ; /**<  **/

@end

@implementation LZMNewsTableViewCell

- (instancetype)initWithStyle:(UITableViewCellStyle)style reuseIdentifier:(NSString *)reuseIdentifier{
    if (self = [super initWithStyle:style reuseIdentifier:reuseIdentifier]){
        [self setupContents];
        self.backgroundColor = LZMColor(@"C112");
    }
    return self;
}

- (void)layoutSubviews {
    UIView *selectBgView = [[UIView alloc]initWithFrame:CGRectMake(12, 10, self.width-24, self.height-20)];
    selectBgView.backgroundColor = [UIColor colorWithWhite:1 alpha:0.1];
    self.selectedBackgroundView = selectBgView;
}

- (void)setupContents{
    self.containerView = [[UIView alloc] init];
    self.containerView.userInteractionEnabled = NO;
    [self.containerView hg_setAllCornerWithCornerRadius:8];
    self.containerView.backgroundColor = [UIColor whiteColor];
    [self.contentView addSubview:self.containerView];
    [self.containerView mas_makeConstraints:^(MASConstraintMaker *make) {
        make.left.mas_equalTo(12);
        make.right.mas_equalTo(-12);
        make.top.mas_equalTo(0);
        make.bottom.mas_equalTo(-10);
    }];
    
    
    self.postImageView = [[YYAnimatedImageView alloc] init];
    self.postImageView.contentMode = UIViewContentModeScaleAspectFill;
    self.postImageView.layer.masksToBounds = YES;
    [self.postImageView hg_setAllCornerWithCornerRadius:4];
    [self.containerView addSubview:self.postImageView];
    [self.postImageView mas_makeConstraints:^(MASConstraintMaker *make) {
        make.top.mas_equalTo(self.containerView.mas_top).mas_offset(15.f);
        make.right.mas_equalTo(self.containerView.mas_right).mas_offset(-13.f);
        make.size.mas_equalTo(CGSizeMake(1.f, 75.f*LZMWIDTH_SCALE));
        make.bottom.mas_lessThanOrEqualTo(self.containerView.mas_bottom).mas_offset(- 15.f);
    }];
    
    self.contentLabel = [[UILabel alloc] init];
    self.contentLabel.numberOfLines = 3;
    self.contentLabel.font = LZMFont(LZMSize(@"T2"), LZMFontName(@"F2"));
    self.contentLabel.textColor = LZMColor(@"C4");
    [self.containerView addSubview:self.contentLabel];
    [self.contentLabel mas_makeConstraints:^(MASConstraintMaker *make) {
        make.left.mas_equalTo(self.containerView.mas_left).mas_offset(13.f);
        make.top.mas_equalTo(self.containerView.mas_top).mas_offset(15.f);
        make.right.mas_equalTo(self.postImageView.mas_left).mas_offset(-10.f);
    }];
    
  //  self.timeLabel = [[UILabel alloc] init];
  //  self.timeLabel.font = LZMFont12;
  //  self.timeLabel.textColor = LZMColor(@"C6");
//    [self.containerView addSubview:self.timeLabel];
//    [self.timeLabel mas_makeConstraints:^(MASConstraintMaker *make) {
//        make.left.mas_equalTo(self.containerView.mas_left).mas_offset(15.f);
//        make.bottom.mas_equalTo(self.containerView.mas_bottom).mas_offset(-12.f);
//    }];
    
    self.viewBtn = [[UIButton alloc] init];
    self.viewBtn.enabled = NO;
    [self.viewBtn setImage:LZMImage(@"home_discovery_look") forState:UIControlStateNormal];
    self.viewBtn.titleLabel.font = LZMFont12;
    [self.viewBtn setTitleColor:LZMColor(@"C6") forState:UIControlStateNormal];
    [self.containerView addSubview:self.viewBtn];
    [self.viewBtn mas_makeConstraints:^(MASConstraintMaker *make) {
        make.left.mas_equalTo(13);
        make.bottom.mas_equalTo(-14);
    }];
    
    self.commentBtn = [[UIButton alloc] init];
    self.commentBtn.enabled = NO;
    [self.commentBtn setImage:LZMImage(@"home_discovery_comment") forState:UIControlStateNormal];
    self.commentBtn.titleLabel.font = LZMFont12;
    [self.commentBtn setTitleColor:LZMColor(@"C6") forState:UIControlStateNormal];
    [self.containerView addSubview:self.commentBtn];
    [self.commentBtn mas_makeConstraints:^(MASConstraintMaker *make) {
        make.left.mas_equalTo(self.viewBtn.mas_right).mas_offset(12.f);
        make.centerY.mas_equalTo(self.viewBtn.mas_centerY);
    }];
    
    self.likeBtn = [[UIButton alloc] init];
    self.likeBtn.enabled = NO;
    [self.likeBtn setImage:LZMImage(@"home_discovery_like") forState:UIControlStateNormal];
    self.likeBtn.titleLabel.font = LZMFont12;
    [self.likeBtn setTitleColor:LZMColor(@"C6") forState:UIControlStateNormal];
    [self.containerView addSubview:self.likeBtn];
    [self.likeBtn mas_makeConstraints:^(MASConstraintMaker *make) {
        make.left.mas_equalTo(self.commentBtn.mas_right).mas_offset(12.f);
        make.centerY.mas_equalTo(self.commentBtn.mas_centerY);
    }];
    
    

    self.viewLabel = [[UILabel alloc] init];
    self.viewLabel.font = LZMFont12;
    self.viewLabel.textColor = LZMColor(@"C6");
    [self.containerView addSubview:self.viewLabel];
    [self.viewLabel mas_makeConstraints:^(MASConstraintMaker *make) {
        make.centerY.mas_equalTo(self.likeBtn.mas_centerY);
        make.right.mas_equalTo(self.containerView.mas_right).mas_offset(-15.f);
    }];
    self.viewLabel.hidden = YES;
    
    self.sepratorView = [[UIView alloc] init];
    self.sepratorView.backgroundColor = LZMColor(@"C8");
    [self.contentView addSubview:self.sepratorView];
    [self.sepratorView mas_makeConstraints:^(MASConstraintMaker *make) {
        make.left.mas_equalTo(self.contentView.mas_left).mas_offset(15.f);
        make.right.mas_equalTo(self.contentView.mas_right).mas_offset(-15.f);
        make.bottom.mas_equalTo(self.contentView.mas_bottom).mas_offset(-1);
        make.height.mas_equalTo(1.f);
    }];
    self.sepratorView.hidden = YES;
}

- (void)setIsFirst:(BOOL)isFirst {
    _isFirst = isFirst;
    [self.containerView mas_updateConstraints:^(MASConstraintMaker *make) {
        make.top.mas_equalTo(isFirst ? 10 : 0);
    }];
}

- (void)setLzmNews:(LZMNews *)lzmNews{
    _lzmNews = lzmNews;
    self.contentLabel.text = _lzmNews.title;
    NSUInteger currentSeconds = [_lzmNews.publishTime longLongValue]/1000;
    NSDate *date = [NSDate dateWithTimeIntervalSince1970:currentSeconds];
  //  self.timeLabel.text = [date hzAutoDate];
    
    if (_lzmNews.coverImg.length< 5){
        self.postImageView.image = nil;
        [self.postImageView mas_remakeConstraints:^(MASConstraintMaker *make) {
            make.size.mas_equalTo(CGSizeMake(1.f, 75.f*LZMWIDTH_SCALE));
            make.top.mas_equalTo(self.containerView.mas_top).mas_offset(15.f);
            make.right.mas_equalTo(self.containerView.mas_right).mas_offset(-13.f);
            make.bottom.mas_lessThanOrEqualTo(self.containerView.mas_bottom).mas_offset(-15.f);
        }];
        
    }else{
        [self.postImageView setImageWithURL:[NSURL URLWithString:_lzmNews.coverImg] placeholder:kBannerPlaceholderImage];
        [self.postImageView mas_remakeConstraints:^(MASConstraintMaker *make) {
            make.size.mas_equalTo(CGSizeMake(100.f*LZMWIDTH_SCALE, 75.f*LZMWIDTH_SCALE));
            make.top.mas_equalTo(self.containerView.mas_top).mas_offset(15.f);
            make.right.mas_equalTo(self.containerView.mas_right).mas_offset(-13.f);
            make.bottom.mas_lessThanOrEqualTo(self.containerView.mas_bottom).mas_offset(- 15.f);
        }];
    }
}



- (void)setShowType:(NSInteger)showType{
    _showType = showType;
    
    if (_showType == 0){
        self.contentLabel.numberOfLines = 2;
        self.likeBtn.hidden = NO;
        self.commentBtn.hidden = NO;
        self.viewBtn.hidden = NO;
        self.viewLabel.hidden = YES;
        self.showSeprator = NO;
        
        [self.likeBtn setTitle:@(_lzmNews.likeNum).stringValue forState:UIControlStateNormal];
        [self.commentBtn setTitle:@(_lzmNews.commentNum).stringValue forState:UIControlStateNormal];
        [self.viewBtn setTitle:@(_lzmNews.viewNum).stringValue forState:UIControlStateNormal];
    }else{
        self.contentLabel.numberOfLines = 0;
        self.postImageView.image = nil;
        self.likeBtn.hidden = YES;
        self.commentBtn.hidden = YES;
        self.viewBtn.hidden = YES;
        self.viewLabel.hidden = NO;
        self.showSeprator = YES;
        self.viewLabel.text = [NSString stringWithFormat:@"%ld浏览", _lzmNews.viewNum];
    }
}

- (void)setShowSeprator:(BOOL)showSeprator{
    _showSeprator = showSeprator;
    self.sepratorView.hidden = !_showSeprator;
}

- (void)setSepratorTop:(BOOL)sepratorTop
{
    _sepratorTop = sepratorTop;
    
    if (sepratorTop) {
        [self.sepratorView mas_updateConstraints:^(MASConstraintMaker *make) {
            make.bottom.mas_equalTo(self.contentView.mas_top).mas_offset(1);
        }];
    } else {
        [self.sepratorView mas_updateConstraints:^(MASConstraintMaker *make) {
            make.bottom.mas_equalTo(self.contentView.mas_bottom).mas_offset(-1);
        }];
    }

}

//解决首页cell设置圆角后出现缝隙
- (void)setFrame:(CGRect)frame {
    if (frame.size.height > 1) frame.size.height += 1;
    [super setFrame:frame];
}

@end

//
//  LZMOldUpdateView.m
//  LZM_SmartEdifice
//
//  Created by zzstc on 2020/1/8.
//  Copyright © 2020 SZ_LZM. All rights reserved.
//

#import "LZMOldUpdateView.h"
#import "HZGradientButton.h"
#import "HZGradientImageView.h"
#import "NSObject+ViewController.h"
#import <StoreKit/StoreKit.h>

@interface LZMOldUpdateView ()
<
SKStoreProductViewControllerDelegate
>
@property (nonatomic, strong) UIView * maskView ; /**< <# #> **/
@property (nonatomic, strong) UIView * contentView ; /**< <# #> **/
@property (nonatomic, strong) HZGradientImageView * imageView ; /**< lzm_notifi_head **/
@property (nonatomic, strong) UILabel * titleLabel ; /**< <# #> **/

@property (nonatomic, strong) UILabel * updateInfoLabel ; /**< <# #> **/
@property (nonatomic, strong) UIButton * closeBtn ; /**< LZM_notif_close **/
@property (nonatomic, strong) HZGradientButton * updateBtn ; /**< <# #> **/

@end

@implementation LZMOldUpdateView

//
//  LZMNotifAlertView.m
//  Louzhangmen
//
//  Created by Quanhai on 2018/6/22.
//  Copyright © 2018年 Shenzhen Zhongzheng Information Technology Co., Ltd. All rights reserved.
//

+ (LZMOldUpdateView *)updateAlertView{
    LZMOldUpdateView *alertView = [[LZMOldUpdateView alloc] initWithFrame:[UIScreen mainScreen].bounds];
    
    return alertView;
}

- (void)alertInCurrentView{
    UIWindow *window = [UIApplication sharedApplication].delegate.window;
    [window addSubview:self];
}

- (void)showAlertView{
    [self alertInCurrentView];
}

- (void)alertViewDismiss{
    [self.contentView removeFromSuperview];
    [self.closeBtn removeFromSuperview];
    [self removeFromSuperview];
}


- (instancetype)initWithFrame:(CGRect)frame{
    if (self = [super initWithFrame:frame]) {
        [self setupContents];
    }
    return self;
}


- (void)setupContents{
    self.maskView = [[UIView alloc] init];
    self.maskView.backgroundColor = [UIColor colorWithWhite:0 alpha:0.5];
    UITapGestureRecognizer *tap = [[UITapGestureRecognizer alloc] initWithTarget:self action:@selector(alertViewDismiss)];
    [self.maskView addGestureRecognizer:tap];
    [self addSubview:self.maskView];
    [self.maskView mas_makeConstraints:^(MASConstraintMaker *make) {
        (void)make.edges;
    }];
    
    CGFloat leftOffset = 25.f;
    
    self.contentView = [[UIView alloc] init];
    self.contentView.backgroundColor = [UIColor whiteColor];
    self.contentView.layer.cornerRadius = 20.f;
    self.contentView.layer.masksToBounds = YES;
    [self addSubview:self.contentView];
    [self.contentView mas_makeConstraints:^(MASConstraintMaker *make) {
        make.centerX.mas_equalTo(self.mas_centerX);
        make.centerY.mas_equalTo(self.mas_centerY);
        make.left.mas_equalTo(self.mas_left).mas_offset(leftOffset);
    }];
    
    self.imageView = [[HZGradientImageView alloc] init];
//    self.imageView.contentMode = UIViewContentModeScaleAspectFill;
    self.imageView.layer.masksToBounds = YES;
    [self.imageView setGradientColor];
    [self.contentView addSubview:self.imageView];
    [self.imageView mas_makeConstraints:^(MASConstraintMaker *make) {
        (void)make.left.top.right;
        make.height.mas_equalTo(80.f);
    }];
    
    self.titleLabel = [[UILabel alloc] init];
    self.titleLabel.numberOfLines = 1;
    self.titleLabel.textColor = [UIColor whiteColor];
    self.titleLabel.font = [UIFont boldSystemFontOfSize:20*LZMWIDTH_SCALE];
    self.titleLabel.textAlignment = NSTextAlignmentCenter;
    [self.imageView addSubview:self.titleLabel];
    [self.titleLabel mas_makeConstraints:^(MASConstraintMaker *make) {
        make.centerX.mas_equalTo(self.imageView.mas_centerX);
        make.centerY.mas_equalTo(self.imageView.mas_centerY);
    }];
    
    self.closeBtn = [[UIButton alloc] init];
    [self.closeBtn addTarget:self action:@selector(alertViewDismiss) forControlEvents:UIControlEventTouchUpInside];
    [self.closeBtn setImage:[UIImage imageNamed:@"ic_close_white"] forState:UIControlStateNormal];
    [self.contentView addSubview:self.closeBtn];
    [self.closeBtn mas_makeConstraints:^(MASConstraintMaker *make) {
        make.top.mas_equalTo(self.contentView.mas_top).mas_offset(5);
        make.right.mas_equalTo(self.contentView.mas_right).mas_offset(-5.f);
        make.width.height.mas_equalTo(40.f);
    }];
    
    
    self.updateInfoLabel = [[UILabel alloc] init];
    self.updateInfoLabel.numberOfLines = 0;
    self.updateInfoLabel.textColor = LZMColor(@"C4");
    self.updateInfoLabel.font = LZMFont14;
    [self.contentView addSubview:self.updateInfoLabel];
    [self.updateInfoLabel mas_makeConstraints:^(MASConstraintMaker *make) {
        make.centerX.mas_equalTo(self.contentView.mas_centerX);
        make.left.mas_equalTo(self.contentView.mas_left).mas_offset(30.f);
        make.top.mas_equalTo(self.imageView.mas_bottom).mas_offset(18.f);
    }];
    
    self.updateBtn = [[HZGradientButton alloc] init];
    [self.updateBtn setTitle:@"立即更新" forState:UIControlStateNormal];
    [self.updateBtn setTitleColor:[UIColor whiteColor] forState:UIControlStateNormal];
    self.updateBtn.enabled = YES;
    self.updateBtn.titleLabel.font = LZMFontMedium15;
    self.updateBtn.layer.cornerRadius = 2.f;
    self.updateBtn.layer.masksToBounds = YES;
    [self.updateBtn addTarget:self action:@selector(updatePush) forControlEvents:UIControlEventTouchUpInside];
    [self.contentView addSubview:self.updateBtn];
    [self.updateBtn mas_makeConstraints:^(MASConstraintMaker *make) {
        make.top.mas_equalTo(self.updateInfoLabel.mas_bottom).mas_offset(50.f);
        make.height.mas_equalTo(44.f*LZMWIDTH_SCALE);
        make.left.mas_equalTo(self.contentView.mas_left).mas_offset(30.f);
        make.centerX.mas_equalTo(self.contentView);
        make.bottom.mas_equalTo(self.contentView.mas_bottom).mas_offset(-30.f);
    }];
}

- (void)setUpdateModel:(LZMAPPVersionModel *)updateModel{
    _updateModel = updateModel;
    self.titleLabel.text = [NSString stringWithFormat:@"发现新版本 %@", _updateModel.targetVersion];
    
    NSMutableParagraphStyle *paragraph = [[NSMutableParagraphStyle alloc] init];
    paragraph.lineSpacing = 5.f;
    NSMutableAttributedString *attributeString = [[NSMutableAttributedString alloc] initWithString:_updateModel.message attributes:@{NSFontAttributeName: LZMFont14, NSParagraphStyleAttributeName :paragraph}];
    self.updateInfoLabel.attributedText = attributeString;
    self.closeBtn.hidden = _updateModel.isForce;
    self.maskView.userInteractionEnabled = !_updateModel.isForce;
}


- (void)updatePush{
    NSString *appStoreUrl = [NSString stringWithFormat:@"%@%@?mt=8", kAppStoreUrl, kAPPId];
    NSURL *url = [NSURL URLWithString:appStoreUrl];
    if ([[UIApplication sharedApplication] canOpenURL:url]){
        [self alertViewDismiss];
        [[UIApplication sharedApplication] openURL:url];
    }
}



@end

//
//  LZMHomePageNavi.m
//  LZM_SmartEdifice
//
//  Created by zzstc on 2020/8/19.
//  Copyright © 2020 SZ_LZM. All rights reserved.
//

#import "LZMHomePageNavi.h"
#import "LZMWeatherModel.h"
#import "UIImage+LZMSVGLoad.h"
@interface LZMHomePageNavi ()

@property (nonatomic, strong) UIImageView * bgImageView ; /**< 背景图片 **/
@property (nonatomic, strong) UIImageView * locationImageView ; /**< 定位图标 **/
@property (nonatomic, strong) UILabel * buildingLabel ; /**< 楼栋名称 **/
@property (nonatomic, strong) UILabel * weatherLabel ; /**< 天气 **/

@end

@implementation LZMHomePageNavi

- (instancetype)initWithFrame:(CGRect)frame
{
    self = [super initWithFrame:frame];
    if (self) {
        [self createSubView];
        self.backgroundColor = LZMColor(@"C1");
        self.showType = LZMHomeNaviViewShowTypeNormal;
    }
    return self;
}

- (void)createSubView {
    [self addSubview:self.bgImageView];
    [self addSubview:self.locationImageView];
    [self addSubview:self.buildingLabel];
    [self addSubview:self.weatherLabel];
    
    [self.bgImageView mas_makeConstraints:^(MASConstraintMaker *make) {
        (void)make.edges;
    }];
    [self.locationImageView mas_makeConstraints:^(MASConstraintMaker *make) {
        make.height.and.width.mas_equalTo(20);
        make.left.mas_equalTo(12);
        make.bottom.mas_equalTo(self.mas_bottom).offset(-12);
    }];
    [self.buildingLabel mas_makeConstraints:^(MASConstraintMaker *make) {
        make.left.mas_equalTo(self.locationImageView.mas_right).offset(2);
        make.centerY.mas_equalTo(self.locationImageView.mas_centerY);
    }];
    [self.weatherLabel mas_makeConstraints:^(MASConstraintMaker *make) {
        make.centerY.mas_equalTo(self.locationImageView.mas_centerY);
        make.right.mas_equalTo(-12);
    }];
    
}

- (void)updateWeathData:(LZMWeatherModel *)weatherModel {
    _weatherLabel.text =  [NSString stringWithFormat:@"%ld°丨%@",weatherModel.temperature,weatherModel.weatherName];
}

#pragma mark -getter/setter

- (void)setShowType:(LZMHomeNaviViewShowType)showType {
    if (_showType == showType) {
        return;
    }
    _showType = showType;
    if (_showType == LZMHomeNaviViewShowTypeNormal) {
      //  self.backgroundColor = LZMColor(@"C1");
        _buildingLabel.textColor = LZMColor(@"C11");
         _weatherLabel.textColor = LZMColor(@"C11");
        _locationImageView.image = [UIImage svgImageNamed:@"lzm_icon_home_location_white" size:CGSizeMake(20, 20)];
    } else if(_showType == LZMHomeNaviViewShowTypeSuspend){
        self.backgroundColor = LZMColor(@"C11");
        _buildingLabel.textColor = LZMColor(@"C1");
         _weatherLabel.textColor = LZMColor(@"C1");
        _locationImageView.image = [UIImage svgImageNamed:@"lzm_icon_home_location_green" size:CGSizeMake(20, 20) tintColor:LZMColor(@"C1")];
    }
}

- (UIImageView *)bgImageView {
    if (!_bgImageView) {
        _bgImageView = [UIImageView new];
        _bgImageView.contentMode = UIViewContentModeScaleAspectFill;
    }
    return _bgImageView;
}

- (UIImageView *)locationImageView {
    if (!_locationImageView) {
        _locationImageView = [UIImageView new];
        _locationImageView.image = [UIImage svgImageNamed:@"lzm_icon_home_location_white" size:CGSizeMake(20, 20)];
    }
    return _locationImageView;
}

- (UILabel *)buildingLabel {
    if (!_buildingLabel) {
        _buildingLabel = [UILabel new];
        _buildingLabel.textColor = LZMColor(@"C11");
        _buildingLabel.font = LZMFont(LZMSize(@"T1"), LZMFontName(@"F2"));
        _buildingLabel.text = LZM_PROJECT_CN ? @"中国储能大厦" : @"光启未来中心";
    }
    return _buildingLabel;
}

- (UILabel *)weatherLabel {
    if (!_weatherLabel) {
        _weatherLabel = [UILabel new];
        _weatherLabel.textColor = LZMColor(@"C11");
        _weatherLabel.font = LZMFont(LZMSize(@"T2"), LZMFontName(@"F2"));
        _weatherLabel.text = @"";
    }
    return _weatherLabel;
}


@end

//
//  LZMHomeOrOneController.m
//  LZM_SmartEdifice
//
//  Created by Sui.H on 2019/1/31.
//  Copyright © 2019年 SZ_LZM. All rights reserved.
//

#import "LZMHomeOrOneController.h"
#import "LZMHomePageTableView.h"
#import "AnimatedBannerView.h"
#import "HompeItemTableViewCell.h"
#import "HomePageNotifiTableViewCell.h"
#import "HomeEntranceTableViewCell.h"
#import "HomePageProductGroupCell.h"
#import "HomePageLZMServiceCell.h"
#import "HomePageCompanyUnionCell.h"
#import "LZMNewsTableViewCell.h"
#import "LZMHomepageHeader.h"
#import "LZMUpdateView.h"
#import "LZMNotifAlertView.h"

#import "LZMWebPayHandler.h"
#import "LZMHomePageService.h"
#import "LZMBanner.h"
#import "LZMAlertNotifi.h"
#import "LZMProductGroup.h"
#import "LZMProduct.h"
#import "LZMHomePageUnion.h"
#import "LZMNews.h"
#import "HomePageItem.h"
#import "HomePageEntrance.h"
#import "LZMDiscoveryModel.h"
#import "LZMAPPVersionModel.h"
#import "LZMHomeStorage.h"

#import "LZMWIFIController.h"
#import "QRMainViewController.h"
#import "LZMParkingMainViewController.h"
#import "LZMExpressController.h"
#import "LZMMeetingRoomListController.h"
#import "LZMMallOrTwoController.h"
#import "LZMProductViewController.h"
#import "LZMFoodStoreDetailController.h"
#import "LZMDiscoveryDetailController.h"
#import "LZMNewsListViewController.h"
#import "LZMUGCInformationListViewController.h"

#import "LZMHomeLayoutModel.h"
#import "LZMHomeMenusModel.h"

#import "LZMNewServicesController.h"
#import "LZMDebugFloatingView.h"
#import "CNJumpTypeManage.h"
#import "LZMHomePageModelDefine.h"

#import "LZMMainGuideView.h"
#import "LZMMainGuideSupport.h"
#import "LZMHomePageNavi.h"
#import "UIView+HGCorner.h"
#import "UIImage+Gradient.h"
#import "LZMQRService.h"
#import "LZMWeatherModel.h"
#import "LZMFoodMainController.h"
#import "LZMMallProductDetailController.h"
static CGFloat HeaderHeight = 49.f;
@interface LZMHomeOrOneController ()
<
UITableViewDelegate,
UITableViewDataSource,
AnimatedBannerViewDelegate,
MutiIconsViewDelegate,
ScrollNotifiViewDelegate,
HomePageProductGroupCellDelegate,
HomePageUnionCellDelegate,
LZMHomepageHeaderDelegate
>
@property (nonatomic, strong) LZMHomePageNavi * homePageNavi ; /**< 导航栏 **/
@property (nonatomic, strong) UIImageView *maskImageView; //渐变图层
@property (nonatomic, strong) UIImageView *shadowImageView;//阴影
@property (nonatomic, strong) UIImageView *rightMaskView;
@property (nonatomic, strong) UIView * bannerContainerView ; /**< banner容器view **/
@property (nonatomic, strong) AnimatedBannerView * bannerView ; /**< banner **/
@property (nonatomic, strong) UIView * tableHeaderView ; /**< table header view **/
@property (nonatomic, strong) LZMHomePageTableView * tableView ; /**< tableview **/

@property (nonatomic, strong) NSArray <LZMBanner *> * banners ; /**< banners **/
@property (nonatomic, strong) NSArray <HomePageItem *> * items ; /**< items **/
@property (nonatomic, strong) NSArray <LZMHomeMenusItemModel *> * entrances ; /**< entrances **/
@property (nonatomic, strong) NSArray <LZMAlertNotifi *> * notifis ; /**< 公告 **/
@property (nonatomic, strong) NSArray <NSString *> * notifiTitles ; /**< 公告标题 **/
@property (nonatomic, strong) NSArray <LZMProductGroup *> * groups ; /**< 分组 **/
@property (nonatomic, strong) NSArray <LZMHomePageUnion *> * unions ; /**< 企业联盟 **/
@property (nonatomic, strong) NSArray <LZMNews *>* lzmNews ; /**< 园区头条 **/

@property (nonatomic, strong) HomePageProductGroupCell * groupCell ; /**< 分组cell **/
@property (nonatomic, strong) LZMHomepageHeader *groupHeader  ; /**< 分组header **/
@property (nonatomic, copy)   NSString *lzmServiceImageName ;
@property (nonatomic, assign) CGFloat content_OffsetY;

@property (nonatomic, strong) LZMHomeStorage * homeCache ;

/** 确认布局类型 */
@property (nonatomic, strong) LZMHomeLayoutModel *layoutModel;
@property (nonatomic, strong) NSMutableArray *layoutArry;

/** 每组数据 */
@property (nonatomic, strong) LZMHomeMenusModel *menusModel;
@property (nonatomic, strong) NSMutableArray *menusDataArry;

/** 引导页 */
@property (nonatomic, strong) LZMMainGuideView *guideView;
@property (nonatomic, assign) BOOL isShowGuide;

/** 升级相关 */
@property (nonatomic, strong) LZMAPPVersionModel *versionModel;
@property (nonatomic, assign) BOOL isShowUpdateView;
@property (nonatomic, strong)NSMutableArray *maskImageArr;
@property (nonatomic, strong)UIView *tmpHeaderView;
@property (nonatomic, strong)UITableViewCell *tmpTabelViewCell;
@property (nonatomic, assign) NSInteger oldIndex;
@property (nonatomic, assign) CGFloat oldAlpha;
@property (nonatomic, assign) BOOL isFirstIn;
@end

@implementation LZMHomeOrOneController

#pragma mark - lifeCycle
- (void)viewDidLoad {
    [super viewDidLoad];
    self.isFirstIn = YES;
    [self createSubView];
    
    [self registered_notification];
    
    [self loadConfig];
    
    [self dataReqByCallBack_block];
     
    [self is_ShowHomeGuid];
    
    [self getHomeAppUpdate];
    
    [self addDebugFloating];
}

- (void)viewWillAppear:(BOOL)animated{
    [super viewWillAppear:animated];
    [self.navigationController setNavigationBarHidden:YES animated:YES];
    [LZMGeneralSupport checkCommentsMessageStatusWithOutNetErrorToast];
    self.bannerView.autoScroll = true;
    [self.bannerView viewWillAppear];
    [self getBanner:^{
    }];
}

- (void)viewWillDisappear:(BOOL)animated{
    [super viewWillDisappear:animated];
    [self viewDisAppearActions];
}

- (void)viewDidAppear:(BOOL)animated{
    [super viewDidAppear:animated];
    if (self.groupCell){
        [self.groupCell viewDidAppearbeginScrolling];
    }
    
    [self viewAppearActions];
    [[NSNotificationCenter defaultCenter] postNotificationName:kAppEnterHomePageNotification object:nil];
    [[NSNotificationCenter defaultCenter] postNotificationName:kMessageNumChangedNotification object:nil];
}

- (void)viewAppearActions{
    self.bannerView.autoScroll = true;
    [self getBanner:^{
    }];
}

- (void)viewDisAppearActions{
    self.bannerView.autoScroll = false;
    if (self.groupCell){
        [self.groupCell viewWillDisappearEndScrolling];
    }
}

- (UIStatusBarStyle)preferredStatusBarStyle{
    CGFloat ffsetY = ((LZMHomeBannerHeight -self.content_OffsetY)-(SafeAreaTopHeight+24)*LZMWIDTH_SCALE);
    if (ffsetY < -44){
        return UIStatusBarStyleDefault;
    }
    return UIStatusBarStyleLightContent;
}

- (void)loadConfig{
    /** 读取配置文件数据 */
    NSDictionary *dataDict = LZMGetConfigDict(HOMEPAGE);
    self.lzmServiceImageName = dataDict[@"HomePageLZMServiceImage"];
    
    /** 读取缓存Data */
    self.homeCache = [[LZMHomeStorage alloc] initWithUserId:@"lzm"];
    
    /** 轮播缓存 */
    self.banners = [self.homeCache getHomeBanners];
    NSMutableArray *imageUrls = [NSMutableArray array];
    for (LZMBanner *banner in self.banners) {
        [imageUrls addObject:banner.imageUrl];
    }
    self.bannerView.imageStringUrls = imageUrls;
    
    /** 布局缓存 */
    self.layoutArry    = [NSMutableArray arrayWithArray:[self.homeCache getLayoutArry]];
    /** item数据缓存 */
    self.menusDataArry = [NSMutableArray arrayWithArray:[self.homeCache getMenusDataArry]];
    /** 工具组缓存 */
    self.items = [self.homeCache getToolGroup];
    /** 消费组缓存 */
    self.entrances = [self.homeCache getPartitionGroup];
    /** 企业联盟缓存 */
    self.unions = [self.homeCache getHomeUnions];
    /** 储能头条缓存 */
    self.lzmNews = [self.homeCache getHomeNews];
    /** 推荐缓存 */
    self.groups = [self.homeCache getHomeGroups];
    self.notifiTitles = [self.homeCache getHomeNotifi];
    [self.tableView reloadData];
}

- (void)creatMaskImages:(NSMutableArray *)colorArr {
    self.maskImageArr = [NSMutableArray new];
    if (colorArr.count >0) {
        [colorArr enumerateObjectsUsingBlock:^(id  _Nonnull obj, NSUInteger idx, BOOL * _Nonnull stop) {
       //      [self.maskImageArr addObject:[[UIImage alloc] createImageWithSize:_bannerContainerView.size gradientColors:@[(id)[UIColor colorWithHexString:obj],(id)LZMColor(@"C11")] percentage:@[@(0),@(1)] gradientType:GradientFromTopToBottom]];
            [self.maskImageArr addObject:[UIColor colorWithHexString:obj]];
        }];
        if (self.oldIndex> self.maskImageArr.count-1) {
            self.oldIndex =  self.maskImageArr.count-1;
        }
        self.maskImageView.backgroundColor = self.maskImageArr[self.oldIndex];
        if (self.isFirstIn) {
           self.maskImageView.backgroundColor = self.maskImageArr.firstObject;
            self.isFirstIn = NO;
        }
    } else {
        self.maskImageView.backgroundColor = LZMColor(@"C1");
    }
}


- (UIColor *)transColor1:(UIColor*)color1 color2:(UIColor *)color2 ratio:(CGFloat)ratio {
    if(ratio > 1)
        ratio = 1;
    const CGFloat * components1 = CGColorGetComponents(color1.CGColor);
    const CGFloat * components2 = CGColorGetComponents(color2.CGColor);
    CGFloat r = components2[0]*ratio + components1[0]*(1-ratio);
    CGFloat g = components2[1]*ratio + components1[1]*(1-ratio);
    CGFloat b = components2[2]*ratio + components1[2]*(1-ratio);
    return [UIColor colorWithRed:r green:g blue:b alpha:1];
}

- (void)createSubView {
    self.view.backgroundColor = [UIColor whiteColor];
    [self setAutoAjustOfScrollView:self.tableView isNeedAuto:NO];
    [LZMGeneralSupport setNavigationItemTitle:self.navigationItem withItemName:TARBAR_HOMEORONE];
    [self.view addSubview:self.bannerContainerView];
    [self.bannerContainerView addSubview:self.bannerView];
    [_bannerContainerView insertSubview:self.maskImageView belowSubview:_shadowImageView];
    [_bannerContainerView insertSubview:self.rightMaskView aboveSubview:_shadowImageView];
    [self.view addSubview:self.tableView];
    [self.tableView mas_makeConstraints:^(MASConstraintMaker *make) {
        (void)make.edges;
    }];
    [self.view addSubview:self.homePageNavi];
}

- (void)registered_notification {
    [[NSNotificationCenter defaultCenter] addObserver:self selector:@selector(jumpLoginOutNoShowGuide) name:kAppLoginOutNoShowGuide object:nil];
    [[NSNotificationCenter defaultCenter] addObserver:self selector:@selector(loginShowGuide) name:kAppLoginShowGuide object:nil];
    [[NSNotificationCenter defaultCenter] addObserver:self selector:@selector(viewAppearActions) name:kAppBeActivateNotification object:nil];
    [[NSNotificationCenter defaultCenter] addObserver:self selector:@selector(viewDisAppearActions) name:kAppEnterBackgroundNotification object:nil];
    [[NSNotificationCenter defaultCenter] addObserver:self selector:@selector(applicationWillResignActive) name:UIApplicationWillResignActiveNotification object:nil];
    [[NSNotificationCenter defaultCenter] addObserver:self selector:@selector(applicationDidBecomeActive) name:UIApplicationDidBecomeActiveNotification object:nil];
    
}

#pragma mark - public
#pragma mark - http
- (void)dataReqByCallBack_block {
    WEAK_SELF(self);
    [self getWeatherData];
    [self layoutWithData:^{
        [self getBanner:^{
            [self getPublicNotifis:^{
                [self getProductGroups:^{
                    [self getCompanyUnions:^{
                        [self getHomePageNews:^{
                            STRONG_SELF(self);
                            [self.tableView.mj_header endRefreshing];
                            [self judgeGroupConner];
                            [self.homeCache saveHomeMenusDataArry:self.menusDataArry];
                            [self.tableView reloadData];
                        }];
                    }];
                }];
            }];
        }];
    }];
}

/** 布局类型及内容 */
- (void)layoutWithData:(void(^)(void))callback {
    [LZMHomePageService getHomeMenusDataSuccess:^(id  _Nullable responseObj, NSString * _Nullable message, NSInteger statusCode, NSUInteger responseCode) {
        /** 布局标识 */
        NSArray *layoutDataArry = [LZMHomeLayoutModel mj_objectArrayWithKeyValuesArray:responseObj[@"groupModules"]];
        self.layoutArry = [NSMutableArray arrayWithArray:layoutDataArry];
        [self.homeCache saveHomelayoutArry:self.layoutArry];
        
        /** 每组内容 */
        NSArray *menusDataArry = [LZMHomeMenusModel mj_objectArrayWithKeyValuesArray:responseObj[@"list"]];
        self.menusDataArry = [NSMutableArray arrayWithArray:menusDataArry];
        [self.homeCache saveHomeMenusDataArry:self.menusDataArry];
        
        /** 分解数据/缓存 */
        [self handleItemData];
        callback();
    } failureHandle:^(NSError * _Nullable error, NSString * _Nullable message, NSInteger statusCode, NSUInteger responseCode) {
        NSLog(@"%@",error.localizedDescription);
        callback();
    }];
}
/**天气 */
- (void)getWeatherData {
    [LZMQRService getWeatherDataSuccess:^(id  _Nullable responseObj, NSString * _Nullable message, NSInteger statusCode, NSUInteger responseCode) {
        LZMWeatherModel *model = [LZMWeatherModel mj_objectWithKeyValues:responseObj];
        [self.homePageNavi updateWeathData:model];
    } failureHandle:^(NSError * _Nullable error, NSString * _Nullable message, NSInteger statusCode, NSUInteger responseCode) {
        
    }];
}
/** 轮播 */
- (void)getBanner:(void(^)(void))callback{
   
    [LZMHomePageService getHomePageBannerSuccess:^(id  _Nullable responseObj, NSString * _Nullable message, NSInteger statusCode, NSUInteger responseCode) {
        self.banners = [LZMBanner mj_objectArrayWithKeyValuesArray:responseObj];
        [self.homeCache saveHomeBanners:self.banners];
        NSMutableArray *imageUrls = [NSMutableArray array];
        NSMutableArray *colorArr = [NSMutableArray new];
        for (LZMBanner *banner in self.banners) {
            [imageUrls addObject:banner.imageUrl];
           NSArray <NSString *>*tmpArr = [banner.imageUrl componentsSeparatedByString:@"lzmBgColor="];
            if (tmpArr.lastObject.length == 7 && [tmpArr.lastObject containsString:@"#"]) {
                [colorArr addObject:tmpArr.lastObject];
            } else {
                [colorArr addObject:@"#37BDC3"];
            }
        }
        [self creatMaskImages:colorArr];
        self.bannerView.imageStringUrls = imageUrls;
        callback();
    } failureHandle:^(NSError * _Nullable error, NSString * _Nullable message, NSInteger statusCode, NSUInteger responseCode) {
        [self.tableView.mj_header endRefreshing];
        callback();
    }];
}

/** 公告 */
- (void)getPublicNotifis:(void(^)(void))callback{
    [LZMHomePageService getHomePagePublicNotifSuccess:^(id  _Nullable responseObj, NSString * _Nullable message, NSInteger statusCode, NSUInteger responseCode) {
        self.notifis = [LZMAlertNotifi mj_objectArrayWithKeyValuesArray:responseObj[@"announcements"]];
        NSMutableArray *notifis = [NSMutableArray array];
        for (LZMAlertNotifi *notifi in self.notifis) {
            [notifis addObject:notifi.title];
        }
        self.notifiTitles = notifis;
        [self fillMenus:@"NoticeGroup" withArray:self.notifis];
        [self.homeCache saveHomeNotifi:self.notifiTitles];
        callback();
    } failureHandle:^(NSError * _Nullable error, NSString * _Nullable message, NSInteger statusCode, NSUInteger responseCode) {
        NSLog(@"%@",error.localizedDescription);
        callback();
    }];
}

/** 商品推荐 */
- (void)getProductGroups:(void(^)(void))callback{
    [LZMHomePageService getHomePageProductGroupSuccess:^(id  _Nullable responseObj, NSString * _Nullable message, NSInteger statusCode, NSUInteger responseCode) {
        self.groups = [LZMProductGroup mj_objectArrayWithKeyValuesArray:responseObj[@"groups"]];
        [self fillMenus:@"RecommendGroup" withArray:self.groups];
        [self.homeCache saveHomeGroups:self.groups];
      //  [self.tableView reloadData];
        callback();
    } failureHandle:^(NSError * _Nullable error, NSString * _Nullable message, NSInteger statusCode, NSUInteger responseCode) {
        NSLog(@"%@",error.localizedDescription);
        callback();
    }];
}

/** 企业联盟 */
- (void)getCompanyUnions:(void(^)(void))callback{
    //光启不需要企业联盟
    if (SingleDataHelper.sharedSingleDataHelper.isCompany_GQ) {
        callback();
        return;
    }
    [LZMHomePageService getCompanyUnionSuccess:^(id  _Nullable responseObj, NSString * _Nullable message, NSInteger statusCode, NSUInteger responseCode) {
        self.unions = [LZMHomePageUnion mj_objectArrayWithKeyValuesArray:responseObj[@"services"]];
        [self fillMenus:@"UnionGroup" withArray:self.unions];
        [self.homeCache saveHomeUnions:self.unions];
        callback();
    } failureHandle:^(NSError * _Nullable error, NSString * _Nullable message, NSInteger statusCode, NSUInteger responseCode) {
        NSLog(@"%@",error.localizedDescription);
        callback();
    }];
}

/** 新闻资讯 */
- (void)getHomePageNews:(void(^)(void))callback{
    [LZMHomePageService getNewsSuccess:^(id  _Nullable responseObj, NSString * _Nullable message, NSInteger statusCode, NSUInteger responseCode) {
        self.lzmNews = [LZMNews mj_objectArrayWithKeyValuesArray:responseObj[@"list"]];
        [self fillMenus:@"NewsGroup" withArray:self.lzmNews];
        [self.homeCache saveHomeNews:self.lzmNews];
        callback();
    } failureHandle:^(NSError * _Nullable error, NSString * _Nullable message, NSInteger statusCode, NSUInteger responseCode) {
        NSLog(@"%@",error.localizedDescription);
        callback();
    }];
}

- (void)fillMenus:(NSString *)key withArray:(NSArray *)menusArr{
    for (LZMHomeMenusModel *model in self.menusDataArry) {
        if ([model.groupModule isEqualToString:key]) {
            model.menus = menusArr;
            break;
        }
    }
}
//判断分组圆角
- (void)judgeGroupConner {
    for (LZMHomeMenusModel *model in self.menusDataArry) {
        if(!model.hasGroupName && !LZMArrayIsEmpty(model.menus)) {
            model.hasCorner = YES;
            break;
        }
        if(!model.hasGroupName && !LZMArrayIsEmpty(model.menus)) {
            model.hasCorner = YES;
            break;
        }
    }
}

- (void)getHomeAppUpdate{
    [LZMHomePageService getAppUpgradeInfoSuccess:^(id  _Nullable responseObj, NSString * _Nullable message, NSInteger statusCode, NSUInteger responseCode) {
        LZMAPPVersionModel *versionModel = [LZMAPPVersionModel mj_objectWithKeyValues:responseObj];
        _versionModel = versionModel;
        if (!versionModel.targetVersion){
            return ;
        }
        _isShowUpdateView = true;
        [self showUpdateApp:1.0f];
    } failureHandle:^(NSError * _Nullable error, NSString * _Nullable message, NSInteger statusCode, NSUInteger responseCode) {
        
    }];
}

#pragma mark - incident
- (void)iconsViewItemJumpVc:(LZMJumpGeneralModel *)model {
    [CNJumpTypeManage CN_handleJumpItem:model currentController:self];
}

/** webView跳转事件 */
- (void)jumpLZMWebViewUrlStr:(NSString *)urlStr title:(NSString *)title itemType:(NSInteger)type bottomShow:(BOOL)isShow backHidden:(BOOL)isHidden {
    LZMWebController *webVc = [LZMWebController new];
    
    CustShareModel *shareModel = [CustShareModel new];
    shareModel.shareTitle = title;
    shareModel.sharedUrl = urlStr;
    webVc.webShareModel = shareModel;
    
    webVc.navItemStyle = type;
    webVc.bottomShow = isShow;
    [webVc loadRequestURLStr:urlStr naviTitle:title];
    [self jumpSpecifiedController:webVc];
    LZMWebPayHandler *handler = [[LZMWebPayHandler alloc] init];
    webVc.webViewPayBlock = handler.WebPayHandler;
}

- (void)jumpSpecifiedController:(UIViewController *)vc {
    [self.navigationController pushViewController:vc animated:true];
}

/** 公告通知. 代理 */
- (void)scrollNotifiView:(ScrollNotifiView *)notifiView selectAtIndex:(NSUInteger)index{
    LZMAlertNotifi *alertNotif = self.notifis[index];
    LZMNotifAlertView *alertView = [LZMNotifAlertView notifAlertView];
    alertView.notif = alertNotif;
    [alertView showAlertView];
}

/** 商品推荐自动滚动.回调 */
- (void)groupIndexChanged_Event {
    WEAK_SELF(self);
    self.groupCell.groupIndexChanged = ^(NSUInteger index){
        STRONG_SELF(self);
        LZMProductGroup *group = self.groups[index];
        self.groupHeader.title = group.groupName;
        self.groupHeader.cateIndex = index;
    };
}

#pragma mark - 通知 后台/前台
/** 后台 */
- (void)applicationWillResignActive {
    if ([[NSObject getCurrentVC] isMemberOfClass:[self class]]) {
        if (self.groupCell){
            [self.groupCell viewWillDisappearEndScrolling];
        }
    }
}

/** 前台 */
- (void)applicationDidBecomeActive {
    if ([[NSObject getCurrentVC] isMemberOfClass:[self class]]) {
        if (self.groupCell){
            [self.groupCell viewDidAppearbeginScrolling];
        }
    }
}

#pragma mark - private
- (void)handleItemData {
    for (LZMHomeMenusModel *model in self.menusDataArry) {
        if ([model.groupModule isEqualToString:Tool_Group]) {
            NSMutableArray *array = [NSMutableArray array];
            for (LZMHomeMenusItemModel *changeModel in model.menus) {
                HomePageItem *model = [changeModel changeToHomePageItemModel];
                [array addObject:model];
            }
            self.items = [NSMutableArray arrayWithArray:array];
//            self.items = [NSMutableArray arrayWithArray:model.menus];
            [self.homeCache saveHomeToolGroup:self.items];
        }
        if ([model.groupModule isEqualToString:Partition_Group]) {
            self.entrances = [NSMutableArray arrayWithArray:model.menus];
            [self.homeCache saveHomePartitionGroup:self.entrances];
        }
    }
}

/** 调试浮窗 */
- (void)addDebugFloating {
//    if ([SingleDataHelper sharedSingleDataHelper].isCompany_MGW) {return;}
//#if defined(DEBUG) || defined(_DEBUG)
////    dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(0.3f * NSEC_PER_SEC)), dispatch_get_main_queue(), ^{
//        [SingleDataHelper sharedSingleDataHeler].debugServerStr = LZMNetworking.baseUrl;
//        LZMDebugFloatingView *floatingView = [[LZMDebugFloatingView alloc]init];
//        [floatingView ServerIP:LZMNetworking.baseUrl];
//        [floatingView showFloatingView:self];
////    });
//#endif
}

- (void)is_ShowHomeGuid {
    /** 玫瑰湾共用此控制器，屏蔽首页引导 */
    if ([SingleDataHelper sharedSingleDataHelper].isCompany_MGW) {
        return;
    }
    if (LZMStrIsEmpty([LZMMainGuideSupport checkIsShowHomeGuideState])) {
        /** 缓存 */
        [LZMMainGuideSupport saveHomeGuideState];
        /** 显示 */
        LZMMainGuideView *guideView = [[LZMMainGuideView alloc]initWithFrame:CGRectZero forGuideStye:LZMMainGuideView_Home];
        [guideView showMainGuideView];
        _guideView = guideView;
        
        WEAK_SELF(self);
        [_guideView setHomePageGuideDisappearBlock:^{
            STRONG_SELF(self);
            self.guideView = nil;
            [self showUpdateApp:0.1f];
        }];
        return;
    }
}

/** 引导页 自动登出，会弹出登录界面,有在显示关闭 */
- (void)jumpLoginOutNoShowGuide {
    if (_guideView) {
        [_guideView disappearHomeGuideStyle_home];
        _isShowGuide = true;
    }
}
/** 引导页 登出，之前显示被通知关闭,判断标识，是否重新显示 */
- (void)loginShowGuide {
    if (_isShowGuide) {
        LZMMainGuideView *guideView = [[LZMMainGuideView alloc]initWithFrame:CGRectZero forGuideStye:LZMMainGuideView_Home];
        [guideView showMainGuideView];
        _isShowGuide = false;
    }
}

/** 版本升级 引导页有在显示先不显示 */
- (void)showUpdateApp:(NSInteger)after {
    if (_guideView || !_isShowUpdateView) {return;}
    LZMUpdateView *updateView = [LZMUpdateView updateAlertView];
    updateView.updateModel = _versionModel;
    dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(after * NSEC_PER_SEC)), dispatch_get_main_queue(), ^{
        _isShowUpdateView = false;
        [updateView showAlertView];
    });
}

#pragma mark - delegate
// banner 跳转
- (void)animatedBannerView:(AnimatedBannerView *)bannerView selectAtIndex:(NSUInteger)index{
    LZMBanner *banner = self.banners[index];
    [LZMDataAnalysis actionEvent:kAnyHomePageBanner eventId:banner.bannerId];
    [LZMWebViewHelper handleJumpId:banner.jumpId jumpType:banner.jumpType jumpUrl:banner.infoUrl title:banner.title controller:self];
}

- (void)animatedBannerView:(AnimatedBannerView *)bannerView didScrollToIndex:(NSUInteger)index viewAlpha:(CGFloat)alpha toRight:(BOOL)isToRight{
    if (self.maskImageArr) {
        if (isToRight) {
            if (alpha == 1) {
                 self.oldIndex = index;
                alpha = 0;
              }
            if (self.oldIndex == self.maskImageArr.count - 1) {
                    _maskImageView.backgroundColor =  [self transColor1:self.maskImageArr.lastObject color2:self.maskImageArr.firstObject ratio:(alpha)];
                 } else
                     _maskImageView.backgroundColor =  [self transColor1:self.maskImageArr[self.oldIndex] color2:self.maskImageArr[self.oldIndex+1] ratio:(alpha)];
        } else {
            if (alpha == 1) {
                 self.oldIndex = index;
               // alpha = 1;
              }
            if (self.oldIndex == 0) {
                _maskImageView.backgroundColor =  [self transColor1:self.maskImageArr.firstObject color2:self.maskImageArr.lastObject ratio:(1-alpha)];
                 } else
                     _maskImageView.backgroundColor =  [self transColor1:self.maskImageArr[self.oldIndex] color2:self.maskImageArr[self.oldIndex-1] ratio:(1-alpha)];
        }
    }
  //  NSLog(@"%ld-----%lf----%ld",index,alpha,self.oldIndex);
}

//homeItem 跳转
- (void)HompeItemJumpWithIndex:(NSInteger)index
{
    HomePageItem *item = self.items[index];
    LZMJumpGeneralModel *jumpModel = [LZMJumpGeneralModel modelWithHomePageItem:item];
    [self iconsViewItemJumpVc:jumpModel];
}

// item 跳转
- (void)entrancesJumpWithIndex:(NSInteger)index
{
    // 入口区域 快递 会议室 美食 京东购
    LZMHomeMenusItemModel *entrance = self.entrances[index];
    LZMJumpGeneralModel *jumpModel = [LZMJumpGeneralModel modelWithHomePageEntrance:entrance];
    [self iconsViewItemJumpVc:jumpModel];
    
    //会员点击打点
    if (jumpModel.jumpType == 2401) {
        [LZMDataAnalysis pageEvent:kCnMemberIndexEntrance];
    }
}

// 分组商品点击
- (void)groupProductSelected:(LZMProduct *)product{
    if (product.type == 1) {
        LZMFoodStoreDetailController *storeVc = [LZMFoodStoreDetailController new];
        storeVc.shopId = product.shopId.integerValue;
        [storeVc scrollToGroupId:product.groupId.integerValue goodId:product.goodsId.integerValue];
        [self.navigationController pushViewController:storeVc animated:YES];
    } else if (product.type == 2) {
        LZMMallProductDetailController *vc = [LZMMallProductDetailController new];
        vc.goodsId = product.goodsId.integerValue;
        [self.navigationController pushViewController:vc animated:YES];
    }
}

// 企业联盟
- (void)homePageCompanyUnionSelected:(LZMHomePageUnion *)homePageUnion{
    [self jumpLZMWebViewUrlStr:homePageUnion.jumpUrl title:homePageUnion.title itemType:3 bottomShow:false backHidden:false];
    [LZMDataAnalysis actionEvent:kAnyUnoinEntrance eventId:homePageUnion.serviceId];
}

- (void)homepageHeaderTapped:(LZMHomepageHeader *)header{
//    self.tabBarController.selectedIndex = 2;
    
    if (kcheckModule(kAppBusinessModuleTypeUGC)) {
        LZMUGCInformationListViewController *ctr = [LZMUGCInformationListViewController new];
        [self.navigationController pushViewController:ctr animated:YES];
    } else {
        LZMNewsListViewController *ctr = [LZMNewsListViewController new];
        [self.navigationController pushViewController:ctr animated:YES];
    }
}

#pragma mark - tableview
- (NSInteger)numberOfSectionsInTableView:(UITableView *)tableView{
    return self.layoutArry.count;
}

- (NSInteger)tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section{
    _layoutModel = self.layoutArry[section];
    if (LZMStrIsNotEmpty(_layoutModel.ToolGroup)) {return LZMArrayIsEmpty(self.items)?0:1;}
    if (LZMStrIsNotEmpty(_layoutModel.NoticeGroup)) {return LZMArrayIsEmpty(self.notifiTitles)?0:1;}
    if (LZMStrIsNotEmpty(_layoutModel.PartitionGroup)) {return LZMArrayIsEmpty(self.entrances)?0:1;}
    if (LZMStrIsNotEmpty(_layoutModel.RecommendGroup)) {return LZMArrayIsEmpty(self.groups)?0:1;}
    if (LZMStrIsNotEmpty(_layoutModel.B2BServiceGroup)) {return 1;}
    if (LZMStrIsNotEmpty(_layoutModel.UnionGroup)) {return LZMArrayIsEmpty(self.unions)?0:1;}
    if (LZMStrIsNotEmpty(_layoutModel.NewsGroup)) {return self.lzmNews.count;}
    return 0;
}

- (CGFloat)tableView:(UITableView *)tableView heightForRowAtIndexPath:(NSIndexPath *)indexPath{
    return UITableViewAutomaticDimension;
}

/** 需要显示组头个数 */
- (CGFloat)tableView:(UITableView *)tableView heightForHeaderInSection:(NSInteger)section{
    _layoutModel = self.layoutArry[section];
    _menusModel  = self.menusDataArry[section];
    if(_menusModel) return  _menusModel.hasGroupName?HeaderHeight:0.001;
//    if (LZMStrIsNotEmpty(_layoutModel.ToolGroup)) {return (_menusModel.hasGroupName&&!LZMArrayIsEmpty(self.items))?HeaderHeight:0.001;}
//    if (LZMStrIsNotEmpty(_layoutModel.PartitionGroup)) {return (_menusModel.hasGroupName&&!LZMArrayIsEmpty(self.unions))?HeaderHeight:0.001;}
//    if (LZMStrIsNotEmpty(_layoutModel.B2BServiceGroup)) {return HeaderHeight;}
//    if (LZMStrIsNotEmpty(_layoutModel.RecommendGroup)) {return LZMArrayIsEmpty(self.groups)?1:HeaderHeight;}
//    if (LZMStrIsNotEmpty(_layoutModel.UnionGroup)) {return LZMArrayIsEmpty(self.unions)?1:HeaderHeight;}
//    if (LZMStrIsNotEmpty(_layoutModel.NewsGroup)) {return LZMArrayIsEmpty(self.lzmNews)?1:HeaderHeight;}
//    if (LZMStrIsNotEmpty(_layoutModel.NoticeGroup)) {return LZMArrayIsEmpty(self.groups)?1:HeaderHeight;}

    return 0.001f;
}

- (UIView *)tableView:(UITableView *)tableView viewForHeaderInSection:(NSInteger)section{
    CGFloat height = [self tableView:tableView heightForHeaderInSection:section];
    _menusModel  = self.menusDataArry[section];
    _layoutModel = self.layoutArry[section];
    
    if (height <HeaderHeight){
        UIView *view = [[UIView alloc] initWithFrame:CGRectMake(0, 0, LZMDevWidth, height)];
        view.backgroundColor = LZMStrIsNotEmpty(_layoutModel.ToolGroup)? [UIColor clearColor]: [UIColor whiteColor];
        return nil;
    }else {
        LZMHomepageHeader *header = [[LZMHomepageHeader alloc] initWithFrame:CGRectMake(0, 0, LZMDevWidth, height)];
        if (LZMStrIsNotEmpty(_layoutModel.RecommendGroup)){
            LZMProductGroup *group = self.groups[self.groupCell.groupIndex];
            header.title = group.groupName;
            header.cateIndex = self.groupCell.groupIndex;
            self.groupHeader = header;
            header.showMoreAccess = NO;
        }else{
            header.title = _menusModel.groupName;
            header.showMoreAccess = _menusModel.hasMore;
        }
        if (section == 0) {
            [header processCorner:UIRectCornerTopLeft|UIRectCornerTopRight size:CGSizeMake(20, 20)];
            header.backgroundColor = UIColor.clearColor;
            self.tmpHeaderView = header;
        } else if(_menusModel.hasSectionCorner){
            [header processCorner:UIRectCornerTopLeft|UIRectCornerTopRight size:CGSizeMake(20, 20)];
            header.backgroundColor = UIColor.clearColor;
            self.tmpHeaderView = header;
        }
        if (LZMStrIsNotEmpty(_layoutModel.NewsGroup)){
            header.delegate = self;
            UIImage *maskImg = [[UIImage alloc] createImageWithSize:header.size gradientColors:@[(id)LZMColor(@"C11"),(id)LZMColor(@"C112")] percentage:@[@(0),@(1)] gradientType:GradientFromTopToBottom];
            UIImageView *tmp = [[UIImageView alloc] initWithFrame:header.bounds];
            tmp.image = maskImg;
            [header insertSubview:tmp atIndex:0];
           
        }
        return header;
    }
}

- (void)tableView:(UITableView *)tableView didSelectRowAtIndexPath:(NSIndexPath *)indexPath{
    _layoutModel = self.layoutArry[indexPath.section];
    _menusModel  = self.menusDataArry[indexPath.section];
    if (LZMStrIsNotEmpty(_layoutModel.B2BServiceGroup)){  //跳转 行政解忧杂货铺
        if (_menusModel.menus && _menusModel.menus.count > 0) {
            LZMHomeMenusItemModel *menu = _menusModel.menus.firstObject;
            LZMJumpGeneralModel *jumpModel = [LZMJumpGeneralModel modelWithHomeMenuItemModel:menu];
            [self iconsViewItemJumpVc:jumpModel];
            return;
        }
        NSString *url = [NSString stringWithFormat:@"%@/as/", kLZMBaseUrl];
        LZMWebController *webVc = [LZMWebController new];
        CustShareModel *shareModel = [CustShareModel new];
        shareModel.shareTitle = @"行政解忧杂货铺";
        shareModel.sharedescription = [[SingleDataHelper sharedSingleDataHelper]getAppShareTextKey:groceriesDes];
        shareModel.sharedUrl = [NSString stringWithFormat:@"%@?isinside=1",url];
        webVc.webShareModel = shareModel;
        webVc.navItemStyle = 1;
        webVc.isGrocery = true;
        [webVc loadRequestURLStr:url naviTitle:shareModel.shareTitle];
        [self jumpSpecifiedController:webVc];
        LZMWebPayHandler *handler = [[LZMWebPayHandler alloc] init];
        webVc.webViewPayBlock = handler.WebPayHandler;
        [LZMDataAnalysis pageEvent:kAnyShopService];
    }
    else if (LZMStrIsNotEmpty(_layoutModel.NewsGroup)){  //园区头条 跳转资讯详情
        [self.tableView deselectRowAtIndexPath:indexPath animated:YES];
        CustShareModel *shareModel = [CustShareModel new];
        LZMDiscoveryDetailController *lzmNewsVc = [LZMDiscoveryDetailController new];
        lzmNewsVc.discoveryId = self.lzmNews[indexPath.row].discoveryId;
        shareModel.shareTitle = self.lzmNews[indexPath.row].title;
        shareModel.shareImage = self.lzmNews[indexPath.row].coverImg;
        lzmNewsVc.discoveryShareModel = shareModel;
        [self.navigationController pushViewController:lzmNewsVc animated:YES];
    }
}

- (CGFloat)tableView:(UITableView *)tableView heightForFooterInSection:(NSInteger)section{
    return 0.001f;
}

- (UIView *)tableView:(UITableView *)tableView viewForFooterInSection:(NSInteger)section{
    UIView *view = [[UIView alloc] initWithFrame:CGRectMake(0, 0, LZMDevWidth, 1.f)];
    view.backgroundColor = [UIColor whiteColor];
    return nil;
}

- (UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath{
    _layoutModel = self.layoutArry[indexPath.section];
    _menusModel  = self.menusDataArry[indexPath.section];
    UITableViewCell *tmpCell;
    WEAK_SELF(self)
    if ([_layoutModel.ToolGroup isEqualToString:_menusModel.groupModule]) {
        HompeItemTableViewCell *cell = [tableView dequeueReusableCellWithIdentifier:kHomePageItemCellIdentifer];
        cell.groupStyle = _menusModel.groupStyle;
        cell.items = self.items;
        
        cell.selectBlock = ^(NSInteger index) {
            [weak_self HompeItemJumpWithIndex:index];
        };
        tmpCell = cell;
    }
    else if ([_layoutModel.NoticeGroup isEqualToString:_menusModel.groupModule]) {
        HomePageNotifiTableViewCell *cell = [tableView dequeueReusableCellWithIdentifier:kHomePagePublicNotifiCellIdentifer];
        cell.delegate = self;
        cell.notifis = self.notifiTitles;
        tmpCell = cell;
    }
    else if ([_layoutModel.PartitionGroup isEqualToString:_menusModel.groupModule]) {
        HomeEntranceTableViewCell *cell = [tableView dequeueReusableCellWithIdentifier:kHomePageEntranceCellIdentifier];
        cell.groupStyle = _menusModel.groupStyle;
        cell.entrances = self.entrances;
        
        cell.selectBlock = ^(NSInteger index) {
            [weak_self entrancesJumpWithIndex:index];
        };
        tmpCell = cell;
    }
    else if ([_layoutModel.RecommendGroup isEqualToString:_menusModel.groupModule]) {
        self.groupCell = [tableView dequeueReusableCellWithIdentifier:kHomePageProductGroupCellIdenitfer];
        self.groupCell.delegate = self;
        self.groupCell.groups = self.groups;
        [self groupIndexChanged_Event];
        return self.groupCell;
    }
    else if ([_layoutModel.B2BServiceGroup isEqualToString:_menusModel.groupModule]) {
        HomePageLZMServiceCell *cell = [tableView dequeueReusableCellWithIdentifier:kHomePageLZMServiceCellIdentifer];
        LZMHomeMenusItemModel *b2bModel = _menusModel.menus.firstObject;
        if (b2bModel && LZMStrIsNotEmpty(b2bModel.iconUrl)) {
            cell.imageName = b2bModel.iconUrl;
        } else {
            cell.imageName = self.lzmServiceImageName;
        }
        tmpCell = cell;
    }
    else if ([_layoutModel.UnionGroup isEqualToString:_menusModel.groupModule]) {
        HomePageCompanyUnionCell *cell = [tableView dequeueReusableCellWithIdentifier:kHomePageCompanyUnionCell];
        cell.selectionStyle = UITableViewCellSelectionStyleNone;
        cell.groupStyle = _menusModel.groupStyle;
        cell.delegate = self;
        cell.unions = self.unions;
        tmpCell = cell;
    }
    else if ([_layoutModel.NewsGroup isEqualToString:_menusModel.groupModule]) {
        LZMNewsTableViewCell *cell = [tableView dequeueReusableCellWithIdentifier:kHomeNewsTableCellIdentifer];
        cell.isFirst = indexPath.row == 0;
        cell.lzmNews = self.lzmNews[indexPath.row];
        cell.showSeprator = (indexPath.row < self.lzmNews.count-1);
        cell.showType = 0;
        tmpCell = cell;
    }
    if (tmpCell) {
        return tmpCell;
    }
    kCell(UITableViewCell);
    return cell;
}

- (void)tableView:(UITableView *)tableView willDisplayCell:(UITableViewCell *)cell forRowAtIndexPath:(NSIndexPath *)indexPath {
     _menusModel  = self.menusDataArry[indexPath.section];
    if (_menusModel.hasCorner) {
        self.tmpTabelViewCell = nil;
       [cell processCorner:UIRectCornerTopLeft|UIRectCornerTopRight size:_menusModel.hasGroupName?CGSizeZero:CGSizeMake(20, 20)];
        cell.contentView.backgroundColor = _menusModel.hasGroupName?UIColor.whiteColor:UIColor.clearColor;
        cell.backgroundColor = _menusModel.hasGroupName?UIColor.whiteColor:UIColor.clearColor;
        if (!_menusModel.hasGroupName) {
            self.tmpTabelViewCell = cell;
        }
    } else {
       [cell processCorner:UIRectCornerTopLeft|UIRectCornerTopRight size:CGSizeZero];
        if([cell isKindOfClass:LZMNewsTableViewCell.class]) {
            cell.backgroundColor = LZMColor(@"C112");
        } else {
            cell.contentView.backgroundColor = UIColor.whiteColor;
            cell.backgroundColor = UIColor.whiteColor;
        }
    }
}

- (void)scrollViewDidScroll:(UIScrollView *)scrollView{
    CGFloat offset = scrollView.contentOffset.y;
    self.content_OffsetY = offset;
 
    if (offset <= 0){
        // 移动banner
        if (self.tmpHeaderView) self.tmpHeaderView.backgroundColor = [UIColor clearColor];
        if(self.tmpTabelViewCell) {
            self.tmpTabelViewCell.backgroundColor = [UIColor clearColor];
            self.tmpTabelViewCell.contentView.backgroundColor = [UIColor clearColor];
        }
        CGRect naviFinalFrame = CGRectMake(0, -offset, LZMDevWidth, SafeAreaTopHeight);
         self.homePageNavi.frame = naviFinalFrame;
        CGRect finalFrame = CGRectMake(0, -offset, LZMDevWidth, LZMHomeBannerContainerHeight+SafeAreaTopHeight);
        self.bannerContainerView.frame = finalFrame;
   //     self.rightMaskView.frame = CGRectMake(self.rightMaskView.frame.origin.x, -offset, self.rightMaskView.width, self.rightMaskView.height);
    }else{
        if (self.tmpHeaderView) self.tmpHeaderView.backgroundColor = [UIColor whiteColor];
        if(self.tmpTabelViewCell) {
           self.tmpTabelViewCell.backgroundColor = [UIColor whiteColor];
           self.tmpTabelViewCell.contentView.backgroundColor = [UIColor whiteColor];
        }
        self.bannerContainerView.frame = CGRectMake(0, 0, LZMDevWidth, LZMHomeBannerContainerHeight+SafeAreaTopHeight);
        self.homePageNavi.frame = CGRectMake(0, 0, LZMDevWidth,SafeAreaTopHeight);
  //      self.rightMaskView.frame = CGRectMake(self.rightMaskView.frame.origin.x, 0, self.rightMaskView.width, self.rightMaskView.height);
    }
    if (offset > LZMHomeBannerContainerHeight-22) {
       self.homePageNavi.backgroundColor = [UIColor colorWithWhite:1 alpha:1];
    } else if (offset > 120 && offset <= LZMHomeBannerContainerHeight-22) {
         CGFloat alpha = (offset-120)/(LZMHomeBannerContainerHeight-122);
         self.homePageNavi.backgroundColor = [UIColor colorWithWhite:1 alpha:alpha];
     } else {
         self.homePageNavi.backgroundColor = [UIColor colorWithWhite:1 alpha:0];;
     }
    if (offset > LZMHomeBannerContainerHeight-22) {
        self.homePageNavi.showType = LZMHomeNaviViewShowTypeSuspend;
    } else {
        self.homePageNavi.showType = LZMHomeNaviViewShowTypeNormal;
    }
    [self setNeedsStatusBarAppearanceUpdate];
}

#pragma mark - getter/setter

- (LZMHomePageNavi *)homePageNavi {
    if (!_homePageNavi) {
        _homePageNavi = [[LZMHomePageNavi alloc]initWithFrame:CGRectMake(0, 0, LZMDevWidth, SafeAreaTopHeight)];
        _homePageNavi.backgroundColor = [UIColor colorWithWhite:1 alpha:0];
    }
    return _homePageNavi;
}

- (UIImageView *)maskImageView {
    if (!_maskImageView) {
        _maskImageView = [[UIImageView alloc] initWithFrame:_bannerContainerView.bounds];
        _maskImageView.backgroundColor = LZMColor(@"C1");
        UIColor *colorOne = [UIColor colorWithRed:255.0/255.0 green:255.0/255.0 blue:255.0/255.0 alpha:0];
        UIColor *colorTwo = [UIColor colorWithRed:255.0/255.0 green:255.0/255.0 blue:255.0/255.0 alpha:1];
        NSArray *colors = [NSArray arrayWithObjects:(id)colorOne.CGColor,(id)colorOne.CGColor,(id)colorTwo.CGColor, nil];
        CAGradientLayer *gradient = [CAGradientLayer layer];
        gradient.startPoint = CGPointMake(0, 0);
        gradient.endPoint = CGPointMake(0, 1);
        gradient.locations = @[@(0),@(1/3.f), @(2/3.f)];
        gradient.colors = colors;
        gradient.size = _bannerContainerView.size;
        [_maskImageView.layer addSublayer:gradient];
        
    }
    return _maskImageView;
}

- (UIImageView *)rightMaskView {
    if (!_rightMaskView) {
        _rightMaskView = [[UIImageView alloc]initWithFrame:CGRectMake(LZMDevWidth-LZMWIDTH_SCALE*208, 0, LZMWIDTH_SCALE*180, 128*LZMHEIGHT_SCALE)];
        _rightMaskView.image = LZMImage(@"home_right_mask");
    }
    return _rightMaskView;
}

- (UIView *)bannerContainerView {
    if (!_bannerContainerView) {
        _bannerContainerView = [[UIView alloc] initWithFrame:CGRectMake(0, 0, LZMDevWidth, LZMHomeBannerContainerHeight+SafeAreaTopHeight)];
        _bannerContainerView.backgroundColor = [UIColor whiteColor];
        _shadowImageView = [[UIImageView alloc] initWithFrame:CGRectMake(0, SafeAreaTopHeight, LZMDevWidth, LZMHomeBannerContainerHeight)];
        _shadowImageView.image = LZMImage(@"lzm_home_mask");
        [_bannerContainerView addSubview:_shadowImageView];
    }
    return _bannerContainerView;
}

- (AnimatedBannerView *)bannerView{
    if (!_bannerView) {
        _bannerView = [[AnimatedBannerView alloc] initWithFrame:CGRectMake(11, 14+SafeAreaTopHeight, LZMDevWidth-22, LZMHomeBannerHeight)];
        _bannerView.pageControlStyle = BannerPageControlStyleDotCenter;
        _bannerView.currentIndicatorColor = LZMColor(@"C11");
        _bannerView.bottomOffset = 4.f;
        _bannerView.placeholderImage = kBannerPlaceholderImage;
        _bannerView.delegate = self;
        _bannerView.autoScrollTimeInterval = 3;
        [_bannerView hg_setAllCornerWithCornerRadius:8];
    }
    return _bannerView;
}

- (UIView *)tableHeaderView{
    if (!_tableHeaderView) {
        _tableHeaderView = [[UIView alloc] initWithFrame:CGRectMake(0, 0, LZMDevWidth, LZMHomeBannerContainerHeight + SafeAreaTopHeight -22.f)];
        _tableHeaderView.backgroundColor = [UIColor clearColor];
    }
    return _tableHeaderView;
}

- (LZMHomePageTableView *)tableView{
    if (!_tableView) {
        _tableView = [[LZMHomePageTableView alloc] initWithFrame:self.view.bounds style:UITableViewStyleGrouped];
        _tableView.backgroundColor = [UIColor clearColor];
        _tableView.separatorStyle = UITableViewCellSeparatorStyleNone;
        _tableView.estimatedRowHeight = 50.f;
        _tableView.delegate = self;
        _tableView.dataSource = self;
        _tableView.tableHeaderView = self.tableHeaderView;
        _tableView.nextView = self.bannerView;
        _tableView.responseView = self.tableHeaderView;
        WEAK_SELF(self);
        _tableView.mj_header = [LZMRefreshHeader headerWithRefreshingBlock:^{
            STRONG_SELF(self);
            [self dataReqByCallBack_block];
        }];
        
        [_tableView registerClass:[HompeItemTableViewCell class] forCellReuseIdentifier:kHomePageItemCellIdentifer];
        [_tableView registerClass:[HomePageNotifiTableViewCell class] forCellReuseIdentifier:kHomePagePublicNotifiCellIdentifer];
        [_tableView registerClass:[HomeEntranceTableViewCell class] forCellReuseIdentifier:kHomePageEntranceCellIdentifier];
        [_tableView registerClass:[HomePageProductGroupCell class] forCellReuseIdentifier:kHomePageProductGroupCellIdenitfer];
        [_tableView registerClass:[HomePageLZMServiceCell class] forCellReuseIdentifier:kHomePageLZMServiceCellIdentifer];
        [_tableView registerClass:[HomePageCompanyUnionCell class] forCellReuseIdentifier:kHomePageCompanyUnionCell];
        [_tableView registerClass:[LZMNewsTableViewCell class] forCellReuseIdentifier:kHomeNewsTableCellIdentifer];
    }
    return _tableView;
}

- (NSMutableArray *)layoutArry {
    if (!_layoutArry) {
        _layoutArry = [NSMutableArray array];
    }
    return _layoutArry;
}

- (NSMutableArray *)menusDataArry {
    if (!_menusDataArry) {
        _menusDataArry = [NSMutableArray array];
    }
    return _menusDataArry;
}

@end

